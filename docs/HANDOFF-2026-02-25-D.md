# Handoff — sesja 2026-02-25 Faza D (UI strona promptow z profilem DONE)

## Status: FAZY A-D KOMPLETNE, E-F PENDING

Handoffy bazowe (przeczytaj w kolejnosci):
1. `docs/HANDOFF-2026-02-24-v2.md` — plan 6 faz
2. `docs/HANDOFF-2026-02-25.md` — fazy A-C done

## Co zrobiono w tej sesji (Faza D)

### 1. API — dual-mode `/api/prompts` route
**Plik: `src/app/api/prompts/route.ts`**

GET:
- `?profileId=<uuid>` → zwraca `prompt_templates WHERE profile_id AND tier='profile' AND is_active`
- `?profileId=<uuid>&seed=true&sectionKey=<key>` → zwraca najstarszy row (oryg. seed z migracji)
- bez parametrow → legacy behavior (DEFAULT_PROMPTS merged z tier='global')

POST:
- z `profileId` w body → upsert tier='profile' scoped do profilu (deaktywuje stary, insert nowy)
- obsluguje nowe pola: `synthetic_focus`, `standard_focus`, `model`, `temperature`, `max_tokens`
- bez profileId → legacy tier='global'

DELETE:
- z `profileId` w body → soft-delete tier='profile' scoped do profilu
- bez profileId → legacy

### 2. Przebudowa strony promptow
**Plik: `src/app/(hub)/email-analyzer/prompts/page.tsx`**

Calkowita przebudowa z flat-list na profile-centric UI:

- **Profile dropdown** na gorze — laduje z `GET /api/analysis-profiles`
- **Profile CRUD inline** — dialogi create/rename/delete
  - Create: `POST /api/analysis-profiles` (auto-generacja slug, domyslny thread prompt)
  - Rename: `PATCH /api/analysis-profiles/[id]` (nazwa + opis)
  - Delete: `DELETE /api/analysis-profiles/[id]` (blokada systemowych, confirm dialog)
- **Thread prompt editor** — kolapsowalna sekcja pod dropdownem
  - Edycja thread_system_prompt + thread_user_prompt_template
  - Zapis przez `PATCH /api/analysis-profiles/[id]`
- **Section list + editor** — grid 1:3 (sidebar + edytor)
  - Sekcje per profil z tier='profile'
  - Reorder, copy, delete (wszystko z profileId)
  - Checkboxy W/K (in_internal_report, in_client_report) z optimistic update
- **AI Config per-section** (kolapsowalne) — model, temperature, max_tokens
- **Focus prompts per-section** (kolapsowalne) — synthetic_focus, standard_focus
- **Reset to seed** — przywraca oryginalna tresc z migracji DB (nie z hardcoded DEFAULT_PROMPTS)

### Wazne: import DEFAULT_PROMPTS usuniety
Strona promptow nie importuje juz `DEFAULT_PROMPTS` z `default-prompts.ts`. Jest w pelni DB-driven. Profile systemowe (communication_audit, case_analytics) maja swoje sekcje jako tier='profile' rows w prompt_templates (zasilone w migracji Phase A).

## Co zostaje do zrobienia

### Faza E: UI — dropdown profilu na stronie analizy + mailbox form
Szczegoly w `docs/HANDOFF-2026-02-25.md` sekcja "Faza E":

- `src/app/(hub)/email-analyzer/analyze/page.tsx` — dropdown profilu miedzy skrzynka a datami
- `src/components/email/MailboxForm.tsx` — dynamiczny dropdown z API `/api/analysis-profiles` (zamiast hardcoded PROFILE_OPTIONS)
- `src/components/email/MailboxList.tsx` — dynamiczny badge (zamiast hardcoded `case_analytics`)
- `src/app/api/mailboxes/route.ts` + `[id]/route.ts` — default_profile_id (JUZ DODANE w MAILBOX_SELECT_COLUMNS i PATCH)

### Faza F: Czyszczenie + build
- Usuniecie nieuzywanych importow `getAnalysisProfile` (po pelnej integracji)
- Usuniecie hardcoded `PROFILE_OPTIONS` na rzecz API
- Weryfikacja build

## Pliki zmodyfikowane w tej sesji

| Plik | Zmiana |
|------|--------|
| `src/app/api/prompts/route.ts` | Dual-mode GET/POST/DELETE + seed endpoint |
| `src/app/(hub)/email-analyzer/prompts/page.tsx` | Pelna przebudowa na profile-centric UI |
| `.planning/STATE.md` | Progress update: 4/6 faz |

## Pliki istniejace (nie zmieniane, gotowe do uzycia w fazach E-F)

| Plik | Rola |
|------|------|
| `src/app/api/analysis-profiles/route.ts` | GET lista profili, POST create |
| `src/app/api/analysis-profiles/[id]/route.ts` | GET/PATCH/DELETE profilu |
| `src/lib/ai/profile-loader.ts` | loadProfile, loadAllProfiles, loadProfileSections |
| `src/lib/ai/analysis-profiles.ts` | Hardcoded registry (fallback) — getAnalysisProfile, PROFILE_OPTIONS |
| `src/app/api/mailboxes/route.ts` | MAILBOX_SELECT_COLUMNS juz zawiera default_profile_id |
| `src/app/api/mailboxes/[id]/route.ts` | PATCH juz obsluguje default_profile_id |
| `src/types/email.ts` | AnalysisProfileDb, PromptTemplateDb, Mailbox.default_profile_id |

## Kontekst projektu

- **Stack**: Next.js 16 (App Router), React 19, Tailwind CSS v4, Supabase
- **Jezyk UI**: TYLKO polski
- **Branch**: master, auto-deploy na Vercel
- **Auth pattern**: `verifyScopedAdminAccess()` + `getAdminClient()` z `src/lib/api/admin.ts`
- **Supabase ref**: `zyqewiqtnxrhkaladoah` (eu-north-1)
- **Build**: `npm run build` — przechodzi czysto po fazie D

## Komendy

```bash
npm run dev     # Dev server
npm run build   # Build check
```

## Nowy agent powinien

1. Przeczytac ten handoff + `docs/HANDOFF-2026-02-25.md` (fazy A-C)
2. Rozpoczac **Faze E** (dropdown profilu na stronie analizy + mailbox form)
3. Po E → Faza F (cleanup + final build)
