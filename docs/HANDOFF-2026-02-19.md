# Handoff — sesja 2026-02-19

## Co się wydarzyło

Użytkownik dostarczył wygenerowany raport (`.wyniki/Raport_wewnetrzny_Rzecznik_Robyg_2026-02-18.docx`) i wymagania klienta (`.wymagania/All_bez_struktury.docx` + `.wymagania/Struktura_2in1 (1).docx`). Porównanie wykazało ocenę **5/10** — raport pokrywał tematykę, ale miał poważne problemy strukturalne i formatowe.

## Zidentyfikowane problemy

1. **Duplikaty sekcji**: "Szybkość reakcji" + "Czas reakcji" (ta sama treść), "Zgodność z RODO" + "Bezpieczeństwo danych (RODO)"
2. **Brak podsekcji**: Sekcja 2 (Szybkość) i 7 (Forma wypowiedzi) wymagają podsekcji wg klienta — raport miał monolityczne bloki
3. **"Ściana bulletów"**: Prompt syntezatora literalnie mówił "Używaj wypunktowań zamiast prozy" → nieczytelne
4. **Mała czcionka**: Brak explicit font sizes w DOCX → domyślna mikroskopijne
5. **Brak metadanych**: Brak konkretnych dat, liczby wiadomości
6. **Rekomendacje bez priorytetów**: Klient wymagał tabeli z priorytetami i odpowiedzialnymi

## Wprowadzone zmiany (NIEZACOMMITOWANE)

### 5 plików, 341 insertions, 88 deletions

#### 1. `src/lib/ai/thread-summary-prompt.ts`
- Wymiar 2 → rozszerzony o podsekcje 2.1 (czas reakcji) i 2.2 (potwierdzenie odbioru: forma + konsekwencja)
- Wymiar 7 → rozszerzony o 6 podsekcji (7.1-7.6: język, powitania, konsekwencja, personalizacja, formalność, zwroty końcowe)

#### 2. `src/lib/ai/report-synthesizer.ts`
- **System prompt**: "Używaj wypunktowań" → "akapit wprowadzający + kluczowe obserwacje jako punkty + rekomendacje"
- **getSectionFocusPrompt()**:
  - `response_speed`: wymaga `## 2.1`/`## 2.2`/`### a)`/`### b)`
  - `expression_form`: wymaga `## 7.1` - `## 7.6`
  - `metadata_analysis`: wymaga konkretnych dat i liczb
  - `recommendations`: wymaga tabeli markdown z priorytetami/odpowiedzialnymi/kategoriami
- Instrukcje anty-redundancyjne, zakaz `#` (tylko `##`/`###`), 7-10 stron A4

#### 3. `src/lib/export/markdown-to-docx.ts` (pełne przepisanie)
- Font: Calibri 12pt body, 14pt H2, 12pt bold H3
- Kolory: navy blue nagłówki (#2B579A), ciemnoszary tekst (#333333), niebieskie bullet dots
- `#` w treści → HeadingLevel.HEADING_2 (degradacja, bo H1 = tytuł sekcji)
- Obsługa `•` (Unicode bullet) jako marker listy
- Line spacing 1.15
- Hanging indent dla bulletów (profesjonalny wygląd)

#### 4. `src/lib/export/export-report-docx.ts` (pełne przepisanie)
- Tytuł: 24pt bold navy blue
- Numeracja sekcji: "1. Metadane analizy", "2. Szybkość reakcji..."
- Nagłówki sekcji: 18pt bold navy blue
- Marginesy: 1 inch (2.54 cm) ze wszystkich stron
- Separator dekoracyjny po nagłówku dokumentu
- Document-level default font: Calibri 12pt

#### 5. `src/app/api/reports/process/route.ts`
- Filtr: gdy format nowy (thread summaries), pomija DB-only sekcje z `prompt_templates` (eliminuje duplikaty z dawnych definicji)

## Stan techniczny

- **TypeScript**: `tsc --noEmit` PASS
- **Next.js build**: PASS (wszystkie route'y kompilują się)
- **Git**: 5 plików zmodyfikowanych, NIEZACOMMITOWANE

## Co zrobić w następnej sesji

### Krok 1: Commit i deploy
```bash
git add src/lib/ai/thread-summary-prompt.ts src/lib/ai/report-synthesizer.ts src/lib/export/markdown-to-docx.ts src/lib/export/export-report-docx.ts src/app/api/reports/process/route.ts
git commit -m "feat: improve report structure and DOCX formatting"
```

### Krok 2: Wygeneruj nowy raport
1. Idź do Raporty → wygeneruj nowy raport wewnętrzny
2. Eksportuj do DOCX
3. Sprawdź czy:
   - Sekcja 2 ma podsekcje 2.1 i 2.2
   - Sekcja 7 ma podsekcje 7.1-7.6
   - Sekcja 13 (Rekomendacje) zawiera tabelę z priorytetami
   - Czcionka jest 12pt Calibri, nagłówki wyraźne
   - Brak duplikatów sekcji

### Krok 3: Oceń i dopracuj
- Jeśli AI nadal generuje `#` zamiast `##` → wzmocnij instrukcję w system prompt
- Jeśli tabela rekomendacji nie powstaje → sprawdź czy model (GPT-5.x) respektuje format tabelaryczny
- Jeśli podsekcje 7.1-7.6 są za krótkie → rozważ zwiększenie tokena per sekcja lub split na osobne calls

### Krok 4: Ewentualnie — Phase 9 (Scraping Engine)
- `/gsd:discuss-phase 9` → kontynuacja Analizatora Grup FB
- WAŻNE: Przed Phase 9 user MUSI wkleić SQL migracje Phase 7 i 8 w Supabase SQL Editor!

## Wymagania klienta (reference)

Pliki w `.wymagania/`:
- `All_bez_struktury.docx` — lista wymaganych tematów i szczegółowych kryteriów
- `Struktura_2in1 (1).docx` — numerowana struktura 13 sekcji z podsekcjami

Kluczowe wymagania klienta:
1. 13 sekcji w określonej kolejności (Metadane → Szybkość → Efektywność → ... → Rekomendacje)
2. Sekcja 2: podsekcje 2.1 Czas reakcji + 2.2 Potwierdzenie odbioru (a. Forma, b. Konsekwencja)
3. Sekcja 7: podsekcje 7.1-7.6 (Język, Powitania, Konsekwencja, Personalizacja, Formalność, Zwroty końcowe)
4. Sekcja 13: tabela z priorytetami i odpowiedzialnymi
5. Metadane: konkretne daty (najstarsza/najnowsza wiadomość), liczba wiadomości

## Pipeline generowania raportu (przypomnienie)

```
1. Analiza AI (per wątek, 1 AI call) → analysis_results (_thread_summary)
2. POST /api/reports → job creation (status: generating)
3. Polling: POST /api/reports/process → synthesizeReportSection() per sekcja
4. report_sections table (content_markdown) → status: draft
5. GET /api/reports/[id] → display
6. exportReportToDocx() (client-side) → markdownToDocxChildren() → DOCX blob
```

Zmienione pliki uczestniczą w krokach 1, 3, i 6.
