# Handoff — sesja 2026-02-25 (Analysis Profiles v2: Fazy A-C DONE)

## Status: FAZY A-C KOMPLETNE, D-F PENDING

Handoff bazowy: `docs/HANDOFF-2026-02-24-v2.md` — przeczytaj go w całości.

## Co zrobiono w tej sesji

### Faza A: Schemat DB + seed — GOTOWE
- Migracja SQL `supabase/migrations/20260225_analysis_profiles_v2.sql` — **już zastosowana na Supabase**
- Tabela `analysis_profiles` — 2 systemowe profile (communication_audit, case_analytics)
- 20 rows w `prompt_templates` (tier='profile') — 14 comm_audit + 6 case_analytics
- Kolumny UUID na mailboxes (default_profile_id) i analysis_jobs (analysis_profile_id)
- Typy TS: `AnalysisProfileDb`, `PromptTemplateDb`, `PromptTemplateTier` w `src/types/email.ts`
- Seed update: `src/lib/mock/seed-data.ts` — lookup UUID profilu

### Faza B: API profili + loader — GOTOWE
Pliki **już istniały** z poprzedniej sesji. Dodano:
- Auto-generacja slug z polskich znaków (`generateSlug()`) w `src/app/api/analysis-profiles/route.ts`
- Blokada zmiany slug profili systemowych w PATCH `src/app/api/analysis-profiles/[id]/route.ts`

**API endpoints:**
| Endpoint | Metoda | Opis |
|----------|--------|------|
| `/api/analysis-profiles` | GET | Lista profili (opcja ?includeSections=true) |
| `/api/analysis-profiles` | POST | Tworzenie profilu (slug auto-generowany) |
| `/api/analysis-profiles/[id]` | GET | Profil + sekcje + globalContext |
| `/api/analysis-profiles/[id]` | PATCH | Aktualizacja (blokada slug systemowych) |
| `/api/analysis-profiles/[id]` | DELETE | Usunięcie (blokada systemowych, czyszczenie mailboxes) |

**Loader:** `src/lib/ai/profile-loader.ts` — loadProfile, loadAllProfiles, loadProfileSections, loadGlobalContext, resolveProfileId (fallback do hardcoded)

### Faza C: Integracja pipeline — GOTOWE
Pipeline był już zintegrowany z DB. Jedyny nowy element:
- **Per-section model override** w `src/lib/ai/report-synthesizer.ts`:
  - Nowe pola `SynthesisInput`: modelOverride, temperatureOverride, maxTokensOverride
  - `applyConfigOverrides()` — merguje per-section AI config z globalnym
  - `reports/process/route.ts` — przekazuje per-section model/temp/maxTokens z dbProfileSections

## Co zostaje do zrobienia

### Faza D: UI — strona promptów z profilem
- **Kluczowa zmiana**: `src/app/(hub)/email-analyzer/prompts/page.tsx` — dodać dropdown profilu na górze
- `src/app/api/prompts/route.ts` — dodać query param ?profileId=
- Widok: po wybraniu profilu pokazuje sekcje z `prompt_templates WHERE profile_id AND tier='profile'`
- Zarządzanie profilami inline (modal/panel) — tworzenie, edycja, usuwanie
- **Wzorzec UI**: `~/projekty/Content Marketing Hub/src/modules/settings/` — SectionManagementPanel, useSectionTemplates, useSectionProfiles

### Faza E: UI — dropdown profilu na stronie analizy + mailbox form
- `src/app/(hub)/email-analyzer/analyze/page.tsx` — dropdown profilu między skrzynką a datami
- `src/components/email/MailboxForm.tsx` — dynamiczny dropdown z API `/api/analysis-profiles` (zamiast hardcoded PROFILE_OPTIONS)
- `src/components/email/MailboxList.tsx` — dynamiczny badge (zamiast hardcoded `case_analytics`)
- `src/app/api/mailboxes/route.ts` + `[id]/route.ts` — default_profile_id (JUŻ DODANE w MAILBOX_SELECT_COLUMNS i PATCH)

### Faza F: Czyszczenie + build
- Usunięcie nieużywanych importów `getAnalysisProfile` (po pełnej integracji)
- Usunięcie hardcoded `PROFILE_OPTIONS` na rzecz API
- Weryfikacja build

## Pliki kluczowe (zmodyfikowane w tej sesji)

| Plik | Zmiana |
|------|--------|
| `src/lib/ai/report-synthesizer.ts` | +modelOverride/temperatureOverride/maxTokensOverride, applyConfigOverrides() |
| `src/app/api/reports/process/route.ts` | per-section model/temp/maxTokens z dbProfileSections |
| `src/app/api/analysis-profiles/route.ts` | +generateSlug(), slug opcjonalny w POST |
| `src/app/api/analysis-profiles/[id]/route.ts` | +blokada slug system profiles, +existing check w PATCH |
| `src/app/api/mailboxes/route.ts` | MAILBOX_SELECT_COLUMNS += default_profile_id |
| `src/app/api/mailboxes/[id]/route.ts` | MAILBOX_SELECT_COLUMNS += default_profile_id, PATCH += default_profile_id |

## Pliki istniejące (nie zmieniane, ale gotowe do użycia)

| Plik | Rola |
|------|------|
| `src/lib/ai/profile-loader.ts` | DB loader: loadProfile, loadAllProfiles, loadProfileSections, loadGlobalContext, resolveProfileId |
| `src/lib/ai/analysis-profiles.ts` | Hardcoded registry (fallback) — getAnalysisProfile, PROFILE_OPTIONS |
| `src/app/api/analysis/route.ts` | POST: profileId override + analysis_profile_id UUID |
| `src/app/api/analysis/process/route.ts` | loadProfile() z DB |
| `src/app/api/reports/route.ts` | loadProfile() + loadProfileSections() z DB |
| `src/types/email.ts` | AnalysisProfileDb, PromptTemplateDb, PromptTemplateTier, Mailbox.default_profile_id |

## Kontekst projektu

- **Stack**: Next.js 16 (App Router), React 19, Tailwind CSS v4, Supabase
- **Język UI**: TYLKO polski
- **Branch**: master, auto-deploy na Vercel
- **Auth pattern**: `verifyScopedAdminAccess()` + `getAdminClient()` z `src/lib/api/admin.ts`
- **Supabase ref**: `zyqewiqtnxrhkaladoah` (eu-north-1)
- **Build**: `npm run build` — przechodzi czysto po fazie C

## Komendy

```bash
# Dev server
npm run dev

# Build check
npm run build

# Sprawdzenie stanu DB
curl -s -X POST "https://api.supabase.com/v1/projects/zyqewiqtnxrhkaladoah/database/query" \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"query": "SELECT id, slug, name FROM analysis_profiles;"}'
```

## Nowy agent powinien

1. Przeczytać ten handoff + `docs/HANDOFF-2026-02-24-v2.md` (bazowy plan 6 faz)
2. Rozpocząć **Fazę D** (UI strona promptów z profilem)
3. Po D → Faza E (dropdown na stronie analizy) → Faza F (cleanup)
