# Handoff — sesja 2026-02-24 v2 (Analysis Profiles → DB-driven)

## Status: PLAN ZATWIERDZONY, IMPLEMENTACJA NIE ROZPOCZĘTA

Plan: `.claude/plans/recursive-hopping-book.md` — przeczytaj go w całości.

## Co zrobiono w tej sesji

1. **Migracja SQL wykonana** — `20260225_analysis_profiles.sql` (ALTER mailboxes + analysis_jobs + UPDATE Rzecznik). Kolumny `analysis_profile TEXT` istnieją w DB.
2. **Testowanie na dev server** — użytkownik zweryfikował, że badge "Analityka spraw" i dropdown profilu w edycji skrzynki działają.
3. **Uwagi użytkownika** (4 szt.) → nowy plan zatwierdzony:
   - Wybór profilu na stronie Analiza AI (nie tylko w edycji skrzynki)
   - Strona promptów powinna być profile-aware
   - Tworzenie własnych profili przez UI (wzorzec Content Marketing Hub)
   - Zarządzanie sekcjami: reorder, copy, delete, per-section AI model
4. **Analiza konfliktów z CC Thread Filtering** — brak blokujących konfliktów. CC Filtering działa równolegle (docs/plans/2026-02-24-cc-thread-filtering-plan.md). Wspólne pliki: `email.ts`, `analysis/route.ts`, `analysis/process/route.ts`, `mailboxes/route.ts`, `MailboxForm.tsx` — zmiany addytywne.

## Plan do implementacji (6 faz)

### Faza A: Schemat DB + migracja danych
- **NOWA tabela `analysis_profiles`** — profile w DB zamiast hardcoded w TS
- **Rozszerzenie `prompt_templates`** — +profile_id, +synthetic_focus, +standard_focus, +model, +temperature, +max_tokens
- **ALTER mailboxes** — +default_profile_id UUID
- **ALTER analysis_jobs** — +analysis_profile_id UUID
- **Seed** — 2 profile + sekcje + focus prompts z hardcoded → DB
- Plik: `supabase/migrations/20260225_analysis_profiles_v2.sql`

### Faza B: API profili + loader
- **NOWY** `src/lib/ai/profile-loader.ts` — loadProfile(), loadProfileSections() z DB
- **NOWY** `src/app/api/analysis-profiles/route.ts` — GET/POST
- **NOWY** `src/app/api/analysis-profiles/[id]/route.ts` — GET/PATCH/DELETE

### Faza C: Integracja pipeline'u
- `analysis/route.ts` — POST przyjmuje profileId, zapisuje analysis_profile_id UUID
- `analysis/process/route.ts` — loadProfile z DB zamiast getAnalysisProfile()
- `reports/route.ts` — sekcje z prompt_templates WHERE profile_id
- `reports/process/route.ts` — focus prompts z DB
- `report-synthesizer.ts` — SynthesisInput + focusPrompt/systemPromptOverride, per-section model

### Faza D: UI — strona promptów z profilem
- `prompts/page.tsx` — dropdown profilu na górze, CRUD per profil
- `api/prompts/route.ts` — query param ?profileId=
- Zarządzanie profilami inline (modal/panel)

### Faza E: UI — dropdown profilu na stronie analizy
- `analyze/page.tsx` — dropdown profilu między skrzynką a datami
- `MailboxForm.tsx` — dynamiczny dropdown z API
- `MailboxList.tsx` — dynamiczny badge
- `mailboxes/route.ts` + `[id]/route.ts` — default_profile_id

### Faza F: Czyszczenie + build

## Kluczowe decyzje (zatwierdzone)

| Decyzja | Wybór |
|---------|-------|
| Sekcje profili | Reuse `prompt_templates` + profile_id (nie osobna tabela) |
| Focus prompts | Nowe kolumny w prompt_templates (przeniesienie z hardcoded) |
| Per-section model | model/temperature/max_tokens nullable na prompt_templates |
| Wiele profili per skrzynka | NIE — jeden default_profile_id + override na stronie analizy |
| Nowa strona profili | NIE — inline na stronie promptów |

## Koordynacja z CC Thread Filtering

Równolegle pracuje inny agent wg `docs/plans/2026-02-24-cc-thread-filtering-plan.md`. Modyfikuje te same pliki (email.ts, analysis routes, mailboxes routes, MailboxForm). Zmiany addytywne — po jego zakończeniu uwzględnij:
- `cc_filter_mode` w SELECT/CRUD mailboxes
- `CcFilterMode`/`CcFilterStatus` typy w email.ts
- CC filtering w analysis routes

## Pliki istniejącej implementacji (do wchłonięcia/zastąpienia)

Poprzedni agent stworzył hardcoded profile (niezcommitowane, w git status jako modified/untracked):
- `src/lib/ai/analysis-profiles.ts` — rejestr 2 profili → stanie się fallback
- `src/lib/ai/profiles/case-analytics-prompts.ts` — thread prompt → dane przeniesione do DB
- `src/lib/ai/profiles/case-analytics-sections.ts` — 6 sekcji → dane przeniesione do DB
- 12 zmodyfikowanych plików — patrz git status

## Kontekst projektu

- **Stack**: Next.js 16 (App Router), React 19, Tailwind CSS v4, Supabase
- **Język UI**: TYLKO polski
- **Branch**: master, auto-deploy na Vercel
- **Auth pattern**: `verifyAdmin()` + `getAdminClient()` z `src/lib/api/admin.ts`
- **Supabase ref**: `zyqewiqtnxrhkaladoah` (eu-north-1)
- **Supabase migracje**: via Management API (access token w sesji, NIE w repo)
- **Wzorzec z Content Marketing Hub**: `~/projekty/Content Marketing Hub/` — SectionManagementPanel, SectionEditor, useSectionTemplates, useSectionProfiles

## Komendy

```bash
# Dev server
npm run dev

# Build check
npm run build

# Migracja SQL via Management API
curl -s -X POST \
  "https://api.supabase.com/v1/projects/zyqewiqtnxrhkaladoah/database/query" \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"query": "<SQL>"}'
```
