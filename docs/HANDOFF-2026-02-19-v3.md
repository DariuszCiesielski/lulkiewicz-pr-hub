# Handoff — sesja 2026-02-19 v3 (po implementacji 2 poziomów raportów)

## Stan na koniec sesji

- **v1.0.7 deployed** — commit `9580e99`, tag `v1.0.7`, na Vercel
- **2 poziomy raportów ZAIMPLEMENTOWANE** — Wave 1 (backend) + Wave 2 (frontend) GOTOWE
- **SQL migracja ZASTOSOWANA** w Supabase SQL Editor
- **Build przechodzi** — `npm run build` OK
- **NIE COMMITNIĘTE** — zmiany w working directory, do przetestowania przed commitem
- **NIE ZDEPLOYOWANE** — czeka na test + commit + push + deploy

## Co zrobiono w tej sesji (v3)

### Wave 1 — Backend (5 plików)

1. **`supabase/migrations/20260219_report_detail_level.sql`** (NOWY)
   - `ALTER TABLE reports ADD COLUMN detail_level TEXT NOT NULL DEFAULT 'standard'`
   - Zastosowane w SQL Editor

2. **`src/lib/ai/report-synthesizer.ts`** — rdzeń zmian:
   - Nowy typ `DetailLevel = 'synthetic' | 'standard'` (eksportowany)
   - `detailLevel: DetailLevel` dodane do `SynthesisInput`
   - 2 system prompts: `SYNTHETIC_SYSTEM_PROMPT` (5-6 stron, max 3-4 zdania, BEZ podsekcji) + `STANDARD_SYSTEM_PROMPT` (15-20 stron, z poprawkami)
   - 2 zestawy focus prompts: `getSyntheticFocusPrompt()` (zwięzłe 1-linijkowe) + `getStandardFocusPrompt()` (z poprawkami: tabela czasów reakcji 2.1, NO_REDUNDANT_H2, RECO_ONLY_IN_13)
   - Router: `getSectionFocusPrompt(key, level)` → routuje do odpowiedniego zestawu
   - `getSystemPrompt(level)` → wybiera system prompt
   - `buildUserPrompt()` — inna instrukcja końcowa per level (synthetic: "max 3-4 zdania", standard: pełna)
   - `singlePassSynthesis()` + `twoLevelSynthesis()` — używają `getSystemPrompt(input.detailLevel)`

3. **`src/app/api/reports/route.ts`**:
   - Parsowanie: `detailLevel = body.detailLevel === 'standard' ? 'standard' : 'synthetic'`
   - Insert: `detail_level: detailLevel`
   - Tytuł: `Raport ${levelLabel} ${templateType}...` (syntetyczny/standardowy)
   - Response: `detailLevel` w zwrotce

4. **`src/app/api/reports/process/route.ts`**:
   - Import: `DetailLevel` z report-synthesizer
   - Odczyt: `detailLevel: DetailLevel = report.detail_level === 'standard' ? 'standard' : 'synthetic'`
   - Przekazanie: `detailLevel` w `SynthesisInput`

5. **`src/app/api/debug/test-synthesis/route.ts`**:
   - Query param: `?detailLevel=standard` (default: synthetic)
   - Dodane `detailLevel` do `SynthesisInput`

### Wave 2 — Frontend (3 pliki)

6. **`src/app/(hub)/email-analyzer/reports/page.tsx`**:
   - `detail_level: string` w interface Report
   - State: `detailLevel` (useState zamiast const)
   - Formularz: grid 3-kolumnowy, trzeci selector "Poziom szczegółowości"
   - Opis dynamiczny pod selektorem (zmienia się z poziomem)
   - Badge na liście: fioletowy (#8b5cf6) = syntetyczny, pomarańczowy (#f97316) = standardowy
   - Komunikat generowania dynamiczny

7. **`src/app/(hub)/email-analyzer/reports/[id]/page.tsx`**:
   - `detail_level: string` w interface Report
   - Badge poziomu w headerze (te same kolory co na liście)

8. **`src/lib/export/export-report-docx.ts`**:
   - `detail_level?: string` w ReportMeta
   - Nazwa pliku: `Raport_syntetyczny_wewnetrzny_skrzynka_daty.docx`

## NASTĘPNY KROK: Testowanie w trybie deweloperskim

### Przed testem
- `npm run dev` — uruchomić serwer deweloperski
- Sprawdzić czy SQL migracja jest zastosowana (kolumna `detail_level` w tabeli `reports`)

### Test 1: Raport syntetyczny (domyślny)
1. Otworzyć `/email-analyzer/reports`
2. Kliknąć "Generuj raport"
3. Wybrać skrzynkę, szablon wewnętrzny, **Syntetyczny** (~5-6 stron)
4. Kliknąć "Generuj"
5. Sprawdzić:
   - Tytuł: "Raport syntetyczny wewnętrzny — ..."
   - Badge fioletowy "Syntetyczny" na liście i w headerze
   - Sekcje: max 3-4 zdania, BEZ podsekcji, BEZ list, BEZ tabel (poza rekomendacjami)
   - Długość: ~5-6 stron po eksporcie DOCX
   - Nazwa pliku DOCX: `Raport_syntetyczny_wewnetrzny_...`

### Test 2: Raport standardowy
1. Wybrać **Standardowy** (~15-20 stron) w selektorze
2. Generuj
3. Sprawdzić:
   - Tytuł: "Raport standardowy wewnętrzny — ..."
   - Badge pomarańczowy "Standardowy"
   - Sekcje: podsekcje (## / ###), tabela czasów reakcji w 2.1
   - BEZ redundantnych H2 powtarzających tytuł
   - Rekomendacje TYLKO w sekcji 13
   - Nazwa pliku DOCX: `Raport_standardowy_wewnetrzny_...`

### Test 3: Kompatybilność wsteczna
- Istniejące raporty (wygenerowane przed migracją) powinny mieć `detail_level = 'standard'` (DEFAULT)
- Badge "Standardowy" powinien się wyświetlać na starych raportach

### Po testach — commit + deploy
```bash
git add src/lib/ai/report-synthesizer.ts src/app/api/reports/route.ts src/app/api/reports/process/route.ts src/app/api/debug/test-synthesis/route.ts src/app/\(hub\)/email-analyzer/reports/page.tsx src/app/\(hub\)/email-analyzer/reports/\[id\]/page.tsx src/lib/export/export-report-docx.ts supabase/migrations/20260219_report_detail_level.sql
git commit -m "feat: add 2 report detail levels (synthetic 5-6p + standard 15-20p)"
git tag v1.0.8
git push && git push --tags
```
Deploy na Vercel.

## Poprawki standardowego raportu (wbudowane)

Te poprawki zostały wbudowane w `getStandardFocusPrompt()` i `STANDARD_SYSTEM_PROMPT`:
1. **Usunięte redundantne H2** — prefix `NO_REDUNDANT_H2` w sekcjach 3-6, 8-10
2. **Rekomendacje TYLKO w sekcji 13** — prefix `RECO_ONLY_IN_13` w sekcjach 2, 3, 5, 10
3. **Tabela statystyk** w sekcji 2.1 — rozkład % czasów reakcji
4. **Konsolidacja rekomendacji** — sekcja 13: "NIE powtarzaj SLA/CRM/ticketing"

## Architektura zmian

```
Frontend (reports/page.tsx)
  ↓ POST /api/reports { detailLevel: 'synthetic' | 'standard' }
API route (reports/route.ts)
  ↓ INSERT reports (detail_level)
  ↓ return { reportId, detailLevel }
Frontend polling → POST /api/reports/process { reportId }
Process route (reports/process/route.ts)
  ↓ SELECT report.detail_level
  ↓ SynthesisInput { detailLevel }
Synthesizer (report-synthesizer.ts)
  ↓ getSystemPrompt(detailLevel) → SYNTHETIC / STANDARD
  ↓ getSectionFocusPrompt(key, detailLevel) → synthetic / standard
  ↓ buildUserPrompt() → inna instrukcja końcowa
  ↓ callAI(systemPrompt, userPrompt)
  → report_sections (content_markdown)
```

## Ważne konteksty (przypomnienie)

- **Supabase CLI zepsuty** — migracje TYLKO przez SQL Editor
- **GPT-5.x = reasoning model** — NIGDY nie ustawiać niskiego max_completion_tokens
- **Potrójne wymuszenie zwięzłości**: system prompt + focus prompt + user prompt instruction
- **Kolory badge**: fioletowy = syntetyczny, pomarańczowy = standardowy, niebieski = wewnętrzny, zielony = kliencki
