# Handoff — 2026-02-15 (sesja 4+5)

## Gdzie skończyliśmy

**v1.0.3 Quality Fixes — COMPLETE** — polskie znaki, filtrowanie sekcji raportów, usuwanie raportów, usunięcie Demo.

### Co zrobione w sesji 5 (v1.0.3):

1. **Polskie znaki diakrytyczne** — 30+ poprawek w stronie Prompty + treść _global_context
2. **Filtrowanie sekcji raportów** — respektuje checkboxy in_internal_report/in_client_report z DB
3. **_global_context wykluczony z syntezy** — używany tylko jako kontekst AI, nie sekcja raportu
4. **Global context z DB** — ładowany z _global_context w prompt_templates (nie z nieistniejącego report_global)
5. **DELETE /api/reports/[id]** — usuwanie raportów (sekcje + raport) + przycisk w UI
6. **Polskie znaki na stronie Raportów** — Wewnętrzny, Szczegółowy, Poziom szczegółowości
7. **Usunięte badge Demo** z Sidebara (oba narzędzia)
8. **Tagged v1.0.3**, pushed to GitHub, deployed to Vercel

---

**Phase 2.1: Multi-Folder Sync — COMPLETE** (INSERTED hotfix do email-analyzer v1.0).
Zweryfikowane (13/13 must-haves), wdrożone na produkcję, otagowane v1.0.1.

### Co zrobione w tej sesji:

1. **Phase 2.1 executed** — 3 plany, 2 wave'y, 18 commitów
2. **SQL migracja wklejona** w Supabase SQL Editor (folder_id + metadata)
3. **Verification passed** — 13/13 must-haves potwierdzone w kodzie
4. **Pushed to production** — auto-deploy Vercel
5. **Tagged v1.0.1** — hotfix release

---

## Phase 2.1: Multi-Folder Sync — szczegóły

### Plan 01: Schema DB + graph-folders + email-fetcher (Wave 1)
- `supabase/migrations/20260214_02_1_01_multi_folder_sync.sql` — ALTER TABLE emails (folder_id TEXT) + ALTER TABLE sync_jobs (metadata JSONB)
- `src/lib/email/graph-folders.ts` — `getExcludedFolderIds()` pobiera ID 3 wykluczonych folderów (drafts, junkemail, deleteditems) via Graph API well-known folder names
- `src/lib/email/email-fetcher.ts` — endpointy z `/mailFolders/inbox/messages` na `/messages`, nowe: `fetchMessagesSince()`, `filterExcludedFolders()`, `parentFolderId` w `$select`
- Commits: a487504, 7f7a227, 0bde990, bb83d6c

### Plan 02: Sync API routes + email-parser (Wave 1)
- `src/lib/email/email-parser.ts` — `mapGraphMessageToEmail` zwraca `folder_id` z `msg.parentFolderId`
- `src/types/email.ts` — `folder_id: string | null` dodany do interfejsu `Email`
- `src/app/api/sync/route.ts` — delta sync wymaga `last_sync_at` zamiast `delta_link`
- `src/app/api/sync/process/route.ts` — `fetchMessagesSince` + `filterExcludedFolders` w obu ścieżkach, excluded folders cachowane w `job.metadata`
- 1 deviation (Rule 2): folder_id dodany do upsert rows w email-fetcher.ts
- Commits: 3b3624b, d8c0874, b7db1b8, c3cccf3

### Plan 03: Legenda statusów + polskie znaki (Wave 2)
- `src/components/threads/ThreadList.tsx` — zwijalna legenda statusów (Oczekujący/Otwarty/Zamknięty)
- 60+ poprawek polskich znaków diakrytycznych w 9 plikach UI
- Commits: c4ce978, b33137d, 56864cc, 153eaa4, 4868dbf, aec9b43, fe7345a

---

## Stan projektu

### v1.0 Email Analyzer — COMPLETE (100%)
| Phase | Status |
|-------|--------|
| 1. Hub Shell & Fundament | COMPLETE |
| 2. Email Connection & Fetching | COMPLETE |
| 2.1. Multi-Folder Sync (INSERTED) | **COMPLETE** (2026-02-15) |
| 3. Email Threading & Browsing | COMPLETE |
| 4. AI Analysis & Prompts | COMPLETE |
| 5. Report Generation & Export | COMPLETE |
| 6. Dashboard & Polish | COMPLETE |

### v1.1 FB Analyzer — IN PROGRESS (40%)
| Phase | Status |
|-------|--------|
| 7. FB Foundation | COMPLETE |
| 8. Group Management | COMPLETE |
| 9. Scraping Engine | **NEXT** |
| 10. AI Sentiment Analysis | Pending |
| 11. Post Browsing & Dashboard | Pending |
| 12. Reports & Export | Pending |

---

## Następny krok

**Phase 9: Scraping Engine** — Integracja Apify Actor API

```
/gsd:discuss-phase 9
```

**UWAGA przed Phase 9:**
- SQL migracje Phase 7 i 8 muszą być wklejone w Supabase SQL Editor (jeśli jeszcze nie)
- Phase 9 = **najwyższe ryzyko** — Apify Actor output schema wymaga walidacji (test run)

---

## Known Gaps (v1.0)

1. **Eksport .pdf** (Phase 5): .docx działa, .pdf nie zaimplementowany
2. **Evaluation criteria UI** (Phase 4): Tabela istnieje w DB, brak UI
3. **Azure Admin Consent** (Phase 2): Czeka na administratora TAG Polska

---

## Kluczowe wzorce techniczne z Phase 2.1

- **All-folders sync**: `/users/{email}/messages` zamiast `/mailFolders/inbox/messages`
- **Smart resync (delta)**: `$filter=receivedDateTime ge {lastSyncDate}` zamiast delta link (per-folder only w Graph API)
- **Excluded folders**: well-known folder names → ID cache w `sync_jobs.metadata`
- **folder_id**: przechowywany na każdym emailu (identyfikacja folderu źródłowego)

---

## Pliki

| Plik | Status |
|------|--------|
| `.planning/STATE.md` | Zaktualizowany (Phase 2.1 COMPLETE) |
| `.planning/ROADMAP.md` | Zaktualizowany (Phase 2.1 marked complete) |
| `.planning/phases/02.1-multi-folder-sync/` | 3 PLANs + 3 SUMMARYs + CONTEXT + VERIFICATION |
| `docs/HANDOFF-2026-02-15.md` | Ten dokument |

---

## GSD Config

```json
{
  "mode": "yolo",
  "model_profile": "quality",
  "workflow": { "research": true, "plan_check": true, "verifier": true }
}
```
