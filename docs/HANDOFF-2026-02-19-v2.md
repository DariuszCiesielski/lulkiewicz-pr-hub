# Handoff — sesja 2026-02-19 (v2, po deployu v1.0.7)

## Stan na koniec sesji

- **v1.0.7 deployed** — commit `9580e99`, tag `v1.0.7`, push na GitHub, deploy na Vercel
- **Production**: https://lulkiewicz-pr-hub.vercel.app
- Raport z 19.02 oceniony na **8/10** (poprawa z 5/10 po zmianach promptów i DOCX)
- Plan 2 poziomów raportów GOTOWY, NIEZAIMPLEMENTOWANY

## Co zrobiono w tej sesji

1. Commitnięto i otagowano zmiany v1.0.7 (report structure + DOCX formatting)
2. Push na GitHub + deploy na Vercel
3. Ocena raportu z 19.02 vs wymagania klienta → 8/10
4. Zaprojektowano plan 2 poziomów raportów (Syntetyczny + Standardowy)

## NASTĘPNE ZADANIE: Implementacja 2 poziomów raportów

### Plan gotowy w: `C:\Users\dariu\.claude\plans\wobbly-percolating-hamster.md`

### Podsumowanie planu

**Problem**: Raport ma ~20 stron zamiast docelowych 5-6. User chce wybór poziomu szczegółowości.

**Rozwiązanie**: 2 poziomy raportów:
- **Syntetyczny** (5-6 stron) — max 3-4 zdania per sekcja, BEZ podsekcji, BEZ list, zwarta proza, styl managerski
- **Standardowy** (15-20 stron) — obecny z poprawkami: brak redundantnych H2, rekomendacje TYLKO w sekcji 13, tabela statystyk w 2.1

**Pełny raport (600+ stron)** — odłożony na później.

### Pliki do modyfikacji (7 plików, 3 wave'y)

#### Wave 1: Backend
1. **SQL migration** — `ALTER TABLE reports ADD COLUMN detail_level TEXT NOT NULL DEFAULT 'standard'` (user wkleja w Supabase SQL Editor)
2. **`src/lib/ai/report-synthesizer.ts`** — rdzeń zmian:
   - Dodać `detailLevel: 'synthetic' | 'standard'` do `SynthesisInput`
   - 2 system prompts: `SYNTHETIC_SYSTEM_PROMPT` (zwięzły) + `STANDARD_SYSTEM_PROMPT` (obecny z poprawkami)
   - 2 zestawy focus prompts: `getSyntheticFocusPrompt()` + `getStandardFocusPrompt()`
   - Helper `getSystemPrompt(detailLevel)` + `getSectionFocusPrompt(key, level)`
   - `buildUserPrompt()` — inna instrukcja końcowa per level
   - `singlePassSynthesis()` / `twoLevelSynthesis()` — użyć `getSystemPrompt()` zamiast stałej
3. **`src/app/api/reports/route.ts`** — parsowanie `detailLevel`, zapis `detail_level` do DB, tytuł z poziomem
4. **`src/app/api/reports/process/route.ts`** — odczyt `report.detail_level`, przekazanie w `SynthesisInput`

#### Wave 2: Frontend
5. **`src/app/(hub)/email-analyzer/reports/page.tsx`** — selector poziomu w formularzu, badge na liście
6. **`src/app/(hub)/email-analyzer/reports/[id]/page.tsx`** — badge poziomu w headerze
7. **`src/lib/export/export-report-docx.ts`** — `detail_level` w ReportMeta, nazwa pliku

#### Wave 3: Weryfikacja
- `npm run build`
- Wygenerować oba typy raportów
- Sprawdzić długość i jakość
- Deploy na Vercel

### Poprawki raportu standardowego (wbudowane w plan)

Te poprawki są częścią nowego `getStandardFocusPrompt()`:
1. **Usunąć redundantne H2** — sekcje 3-6, 8-10: "NIE zaczynaj od H2 powtarzającego tytuł"
2. **Rekomendacje TYLKO w sekcji 13** — sekcje 2, 3, 5, 10: "Rekomendacje podaj WYŁĄCZNIE w sekcji 13"
3. **Tabela statystyk** w sekcji 2.1 — rozkład % czasów reakcji
4. **Konsolidacja rekomendacji** — sekcja 13: "NIE powtarzaj tych samych SLA/CRM/ticketing"

### Decyzje użytkownika (z tej sesji)

- Nazwy: **Syntetyczny / Standardowy / Pełny** (pełny odłożony)
- Pełny raport: **na razie tylko syntetyczny + standardowy**
- Struktura syntetycznego: **każda z 13 sekcji zachowana** (max 3-4 zdania, bez podsekcji)

## Wymagania klienta (reference)

Pliki w `.wymagania/`:
- `All_bez_struktury.docx` — lista wymaganych tematów i szczegółowych kryteriów
- `Struktura_2in1 (1).docx` — numerowana struktura 13 sekcji z podsekcjami

Wygenerowane raporty w `.wyniki/`:
- `Raport_wewnetrzny_Rzecznik_Robyg_2026-02-18.docx` — stary (5/10)
- `Raport_wewnetrzny_Rzecznik_Robyg_2026-02-19.docx` — nowy po v1.0.7 (8/10)

## Pipeline generowania raportu (przypomnienie)

```
1. Analiza AI (per wątek, 1 AI call) → analysis_results (_thread_summary)
2. POST /api/reports → job creation (status: generating)
3. Polling: POST /api/reports/process → synthesizeReportSection() per sekcja
4. report_sections table (content_markdown) → status: draft
5. GET /api/reports/[id] → display
6. exportReportToDocx() (client-side) → markdownToDocxChildren() → DOCX blob
```

## Ważne konteksty

- **Supabase CLI zepsuty** — migracje TYLKO przez SQL Editor w Dashboard
- **GPT-5.x = reasoning model** — NIGDY nie ustawiać niskiego max_completion_tokens
- **Polling pattern**: POST /api/X → job, POST /api/X/process → batch, frontend pętla
- **Admin-only**: verifyAdmin() + getAdminClient() w `src/lib/api/admin.ts`
- **MEMORY.md** zaktualizowane o tę sesję
