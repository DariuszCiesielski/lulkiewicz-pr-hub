# Handoff — sesja 2026-02-24 (Analysis Profiles per skrzynka)

## Status: PLAN ZATWIERDZONY, IMPLEMENTACJA NIE ROZPOCZĘTA

Plan znajduje się w: `.claude/plans/rippling-finding-biscuit.md` — przeczytaj go w całości przed rozpoczęciem pracy.

## Co robimy

Dodajemy **Analysis Profiles** — mechanizm per-mailbox, który zmienia zarówno prompt analizy AI wątków, jak i sekcje generowanego raportu.

### Problem
Skrzynka "Rzecznik Robyg" wymaga zupełnie innego raportu niż pozostałe skrzynki. Obecna struktura (13 sekcji oceny jakości komunikacji) daje fałszywe wnioski, bo maile do Rzecznika to CC/forwarding. Klientka potrzebuje **analityki zgłoszeniowej**: lokalizacje (Gdańsk/Poznań/Wrocław/Warszawa), etapy procesu, typy zgłoszeń, problemy.

### Rozwiązanie
Dwa profile definiowane w kodzie:
- `communication_audit` (domyślny) — obecne 13 sekcji, bez zmian
- `case_analytics` (nowy) — 6 sekcji analityki zgłoszeniowej

Profil zmienia **dwie fazy**: (1) prompt analizy wątków, (2) sekcje i prompty raportu.

## Decyzje podjęte z użytkownikiem

1. **Nowa analiza AI wymagana** — istniejące thread summaries nie zawierają danych o lokalizacjach/etapach
2. **UI dropdown** w formularzu skrzynki + auto-assign profilu `case_analytics` dla skrzynek z "Rzecznik" w nazwie (migracja SQL)
3. **6 sekcji raportu**: Metadane, Rozkład geograficzny, Etapy procesu, Typologie zgłoszeń, Analiza problemów, Rekomendacje

## 7 kroków implementacji (todo lista)

Wszystkie szczegóły w planie `.claude/plans/rippling-finding-biscuit.md`. Skrót:

### Krok 1: Migracja SQL
Nowy plik `supabase/migrations/20260225_analysis_profiles.sql`:
- `ALTER TABLE mailboxes ADD COLUMN analysis_profile TEXT DEFAULT 'communication_audit'`
- `ALTER TABLE analysis_jobs ADD COLUMN analysis_profile TEXT`
- `UPDATE mailboxes SET analysis_profile = 'case_analytics' WHERE display_name ILIKE '%Rzecznik%'`

### Krok 2: Typy + rejestr profili
- `src/types/email.ts` — dodać `analysis_profile` do Mailbox, MailboxFormData
- `src/components/email/MailboxList.tsx` — dodać do MailboxListItem
- `src/components/email/MailboxForm.tsx` — dodać do MailboxEditData
- **NOWY** `src/lib/ai/analysis-profiles.ts` — centralny rejestr z interfejsem AnalysisProfile, getAnalysisProfile(), PROFILE_OPTIONS

### Krok 3: Prompty case_analytics
- **NOWY** `src/lib/ai/profiles/case-analytics-prompts.ts` — thread prompt wyodrębniający lokalizację, etap, typ, kategorię problemu
- **NOWY** `src/lib/ai/profiles/case-analytics-sections.ts` — 6 sekcji z focus promptami (synthetic + standard)
- Section key: `_case_thread_summary` (oddzielny od `_thread_summary`)

### Krok 4: Analysis pipeline
- `src/app/api/analysis/route.ts` — POST: zapisać profil z mailboxa do job.analysis_profile
- `src/app/api/analysis/process/route.ts` — zamiast hardcoded THREAD_SUMMARY_*, użyć `profile.threadConfig.*`

### Krok 5: Report synthesis
- `src/lib/ai/report-synthesizer.ts` — dodać profileId do SynthesisInput, system/focus prompty z profilu
- `src/app/api/reports/process/route.ts` — sekcje z profilu (nie DEFAULT_PROMPTS), dynamiczny section_key
- `src/app/api/reports/route.ts` — sekcje liczone z profilu

### Krok 6: UI
- `src/components/email/MailboxForm.tsx` — dropdown "Profil analizy"
- `src/components/email/MailboxList.tsx` — badge "Analityka spraw"
- `src/app/api/mailboxes/route.ts` + `[id]/route.ts` — dodać analysis_profile do SELECT/POST/PATCH

### Krok 7: Mock + build
- `src/lib/mock/seed-mailboxes.ts` — analysis_profile w mock Rzecznik
- `npm run build` — weryfikacja

## Kluczowe pliki do przeczytania przed implementacją

1. `.claude/plans/rippling-finding-biscuit.md` — pełny plan
2. `src/lib/ai/thread-summary-prompt.ts` — obecny prompt analizy (do opakowania w profil communication_audit)
3. `src/lib/ai/default-prompts.ts` — obecne 13 sekcji (do opakowania w profil communication_audit)
4. `src/lib/ai/report-synthesizer.ts` — focus prompty i system prompty (do przeniesienia do profilu)
5. `src/app/api/analysis/process/route.ts` — linia 210: hardcoded prompt → dynamiczny z profilu
6. `src/app/api/reports/process/route.ts` — sekcje z DEFAULT_PROMPTS → z profilu

## Kontekst projektu

- **Stack**: Next.js 16 (App Router), React 19, Tailwind CSS v4, Supabase, OpenAI
- **Język UI**: TYLKO polski
- **Branch**: master
- **Build**: `npm run build` przechodzi (stan na początek sesji)
- **Faza 11** (Post Browsing & Dashboard) jest planowana równolegle w osobnej sesji terminala — nie koliduje z naszą pracą

## Co NIE robić

- NIE usuwać `DEFAULT_PROMPTS`, `CLIENT_REPORT_SECTIONS`, `THREAD_SUMMARY_SECTION_KEY` — profil communication_audit ich używa
- NIE zmieniać istniejącej logiki dla domyślnego profilu — backward compatibility jest krytyczna
- NIE tworzyć UI do zarządzania sekcjami (jak w Content Marketing Hub) — profile są w kodzie
