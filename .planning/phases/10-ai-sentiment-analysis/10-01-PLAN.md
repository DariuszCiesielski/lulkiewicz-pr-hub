---
phase: 10-ai-sentiment-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql
  - src/lib/ai/ai-provider.ts
  - src/lib/fb/fb-analysis-prompt.ts
  - src/lib/fb/fb-keywords.ts
  - src/lib/ai/default-prompts.ts
  - src/app/api/fb-settings/route.ts
  - src/types/fb.ts
autonomous: true

must_haves:
  truths:
    - "callAI() przyjmuje opcjonalny parametr responseFormat i przekazuje go do OpenAI API"
    - "Domyslny prompt AI szuka opinii mieszkancow dotyczacych administracji osiedla i dewelopera z obsluga sarkazmu, kolokwializmow i pasywno-agresywnego tonu"
    - "JSON schema gwarantuje structured output z polami: is_relevant, sentiment, relevance_score, categories, ai_snippet"
    - "Keyword matching laduje slowa kluczowe z fb_settings (per-group lub global) i zwraca trafienia"
    - "fb_keywords i fb_keywords:{groupId} sa dozwolonymi kluczami w fb-settings POST walidacji"
    - "fb_analysis_jobs CHECK constraint zawiera 'paused' i tabela ma kolumne metadata JSONB"
  artifacts:
    - path: "supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql"
      provides: "SQL migration: paused status + metadata JSONB na fb_analysis_jobs"
      contains: "paused"
    - path: "src/lib/ai/ai-provider.ts"
      provides: "callAI z opcjonalnym responseFormat"
      contains: "responseFormat"
    - path: "src/lib/fb/fb-analysis-prompt.ts"
      provides: "System prompt, user prompt template, JSON schema, section key"
      exports: ["FB_POST_ANALYSIS_SECTION_KEY", "FB_POST_ANALYSIS_SYSTEM_PROMPT", "FB_POST_ANALYSIS_USER_PROMPT_TEMPLATE", "FB_POST_ANALYSIS_SCHEMA", "buildFbUserPrompt"]
    - path: "src/lib/fb/fb-keywords.ts"
      provides: "Keyword matching i loading z fb_settings"
      exports: ["matchKeywords", "loadKeywords"]
    - path: "src/lib/ai/default-prompts.ts"
      provides: "FB prompt zarejestrowany w DEFAULT_PROMPTS"
      contains: "_fb_post_analysis"
    - path: "src/types/fb.ts"
      provides: "FbPostAnalysisResult interface + FbAnalysisStatus rozszerzony o paused"
      contains: "FbPostAnalysisResult"
  key_links:
    - from: "src/lib/fb/fb-analysis-prompt.ts"
      to: "src/lib/ai/ai-provider.ts"
      via: "responseFormat schema passed to callAI"
      pattern: "response_format.*json_schema"
    - from: "src/lib/fb/fb-keywords.ts"
      to: "fb_settings table"
      via: "Supabase query for fb_keywords key"
      pattern: "fb_keywords"
    - from: "src/lib/ai/default-prompts.ts"
      to: "src/lib/fb/fb-analysis-prompt.ts"
      via: "imports FB prompt constants"
      pattern: "_fb_post_analysis"
---

<objective>
Przygotowanie backendu AI do analizy postow FB: migracja SQL (paused status + metadata JSONB), rozszerzenie callAI() o structured JSON output, stworzenie polskiego promptu do analizy sentymentu postow z grup FB, systemu matchowania slow kluczowych i rejestracja domyslnego promptu w prompt_templates.

Purpose: Fundament AI dla Phase 10 — bez tych modulow API routes nie moga przetwarzac postow. Prompt musi rozpoznawac polski sarkazm, kolokwializmy i pasywno-agresywny ton w kontekscie administracji osiedli. Migracja SQL dodaje status 'paused' i kolumne metadata JSONB (pattern identyczny jak sync_jobs w email-analyzer).
Output: SQL migration + 4 moduly (ai-provider rozszerzony, fb-analysis-prompt, fb-keywords, default-prompts zaktualizowany) + zaktualizowane typy TS
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ai-sentiment-analysis/10-RESEARCH.md
@src/lib/ai/ai-provider.ts
@src/lib/ai/default-prompts.ts
@src/types/fb.ts
@src/app/api/fb-settings/route.ts
@supabase/migrations/20260212_07_01_fb_analyzer.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: SQL migration + Rozszerzenie callAI() + typy + fb-analysis-prompt.ts</name>
  <files>
    supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql
    src/lib/ai/ai-provider.ts
    src/lib/fb/fb-analysis-prompt.ts
    src/types/fb.ts
  </files>
  <action>
0. **SQL migration** — Stworz `supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql`:
   ```sql
   -- Phase 10: AI Sentiment Analysis — ALTER fb_analysis_jobs
   -- Uwaga: Wklej w Supabase Dashboard > SQL Editor (Supabase CLI zepsuty)

   -- 1. Dodaj status 'paused' do CHECK constraint
   -- Stary: CHECK (status IN ('pending', 'running', 'completed', 'failed'))
   -- Nowy: CHECK (status IN ('pending', 'running', 'paused', 'completed', 'failed'))
   ALTER TABLE fb_analysis_jobs DROP CONSTRAINT IF EXISTS fb_analysis_jobs_status_check;
   ALTER TABLE fb_analysis_jobs ADD CONSTRAINT fb_analysis_jobs_status_check
     CHECK (status IN ('pending', 'running', 'paused', 'completed', 'failed'));

   -- 2. Dodaj kolumne metadata JSONB (pattern identyczny jak sync_jobs)
   -- Uzycie: { forceReanalyze: true } zapisywane przy tworzeniu joba
   ALTER TABLE fb_analysis_jobs
     ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}';
   ```
   WAZNE: Ten plik to dokumentacja — user musi wkleic SQL w Supabase SQL Editor (CLI zepsuty). Bez tej migracji pause/resume NIE bedzie dzialac (DB odrzuci status 'paused') i forceReanalyze nie bedzie sledzony miedzy requestami.

1. **ai-provider.ts** — Dodaj opcjonalny 4. parametr `responseFormat` do `callAI()`:
   ```typescript
   export async function callAI(
     config: AIConfig,
     systemPrompt: string,
     userPrompt: string,
     responseFormat?: { type: string; json_schema?: { name: string; strict: boolean; schema: object } }
   ): Promise<AIResponse>
   ```
   W body requestu dodaj warunkowo: `...(responseFormat ? { response_format: responseFormat } : {})`.
   NIE zmieniaj sygnatury `loadAIConfig()` ani reszty pliku — tylko rozszerzenie.

2. **fb-analysis-prompt.ts** — Nowy plik w `src/lib/fb/`. Eksportuje:
   - `FB_POST_ANALYSIS_SECTION_KEY = '_fb_post_analysis'`
   - `FB_POST_ANALYSIS_SYSTEM_PROMPT` — pelny system prompt po polsku. MUSI zawierac:
     * Ekspert ds. zarzadzania nieruchomosciami analizujacy posty z grup FB osiedli
     * Szukaj opinii waznych dla zarzadcy: skargi, pochwaly, usterki, oplaty, bezpieczenstwo
     * Sekcja "WAZNE — cechy polskiego jezyka w mediach spolecznosciowych" z 6+ przyklady sarkazmu, grzecznych skarg, kolokwializmow (kicha, masakra, dramat, zenada), emocjonalnych wielkich liter, ironii, pasywno-agresywnego tonu
     * Instrukcja "Odpowiadasz WYLACZNIE w formacie JSON zgodnym z podanym schematem"
   - `FB_POST_ANALYSIS_USER_PROMPT_TEMPLATE` — template z placeholders: `{{post_content}}`, `{{group_name}}`, `{{author_name}}`, `{{posted_at}}`, `{{likes_count}}`, `{{comments_count}}`, `{{keyword_context}}`, `{{extra_instructions}}`. Zadanie: is_relevant, sentiment, relevance_score (skala 0-10 z opisem zakresow), kategorie (1-3 z predefiniowanych 11), ai_snippet. Instrukcja podwyzszenia relevance_score o 1-2 punkty przy trafieniu slow kluczowych.
   - `FB_POST_ANALYSIS_SCHEMA` — obiekt `response_format` z `type: "json_schema"`, `json_schema.name: "fb_post_analysis"`, `json_schema.strict: true`, schema z:
     * `is_relevant`: boolean
     * `sentiment`: string enum ["positive", "negative", "neutral"]
     * `relevance_score`: integer (NOTE: min/max may be ignored by strict mode — validate in code)
     * `categories`: array of string enum ["oplaty", "naprawy", "czystosc", "bezpieczenstwo", "zielen", "komunikacja", "finanse", "prawo", "sasiedzi", "pochwaly", "inne"]
     * `ai_snippet`: string
     * `additionalProperties: false`, `required: [all 5 fields]`
   - `buildFbUserPrompt(post, groupName, keywordMatches, extraInstructions)` — funkcja ktora wypelnia template placeholderami i zwraca gotowy user prompt. `keyword_context` = "Znalezione slowa kluczowe w tresci: [lista]" jesli sa trafienia, pusty string jesli nie.

3. **fb.ts** — Dodaj:
   - `FbPostAnalysisResult` interface (is_relevant, sentiment, relevance_score, categories, ai_snippet) — odwzorowuje JSON schema
   - Rozszerz `FbAnalysisStatus` o `'paused'`: `'pending' | 'running' | 'paused' | 'completed' | 'failed'`
   - Dodaj `'fb_keywords'` i template literal `fb_keywords:${string}` do `FbSettingsKey` union type
  </action>
  <verify>
  - `npx tsc --noEmit` przechodzi bez bledow
  - `grep -r "responseFormat" src/lib/ai/ai-provider.ts` zwraca linie z nowym parametrem
  - `grep -r "FB_POST_ANALYSIS_SCHEMA" src/lib/fb/fb-analysis-prompt.ts` potwierdza eksport schema
  - `grep -r "FbPostAnalysisResult" src/types/fb.ts` potwierdza nowy interface
  - Plik `supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql` istnieje z ALTER TABLE
  - `grep "paused" supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql` potwierdza nowy status
  - `grep "metadata" supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql` potwierdza kolumne JSONB
  </verify>
  <done>
  - SQL migration dodaje 'paused' do CHECK constraint i kolumne metadata JSONB na fb_analysis_jobs
  - callAI() przyjmuje opcjonalny 4. parametr responseFormat i przekazuje go do OpenAI API body
  - fb-analysis-prompt.ts eksportuje section key, system prompt (z obsluga polskiego sarkazmu), user prompt template, JSON schema i funkcje buildFbUserPrompt
  - fb.ts ma FbPostAnalysisResult, rozszerzony FbAnalysisStatus i rozszerzony FbSettingsKey
  </done>
</task>

<task type="auto">
  <name>Task 2: fb-keywords.ts + rejestracja promptu w default-prompts + fb-settings allowlist</name>
  <files>
    src/lib/fb/fb-keywords.ts
    src/lib/ai/default-prompts.ts
    src/app/api/fb-settings/route.ts
  </files>
  <action>
1. **fb-keywords.ts** — Nowy plik w `src/lib/fb/`. Eksportuje:
   - `matchKeywords(content: string, keywords: string[]): string[]` — bierze tresc postu i liste slow kluczowych, zwraca trafienia (case-insensitive `.includes()`). Zwraca puste tablice jesli content pusty lub keywords puste.
   - `loadKeywords(adminClient: SupabaseClient, groupId: string): Promise<string[]>` — laduje slowa kluczowe z fb_settings:
     1. Probuje `fb_keywords:{groupId}` (per-group override)
     2. Fallback na `fb_keywords` (global)
     3. Parsuje `value_plain` jako JSON array (`JSON.parse()`)
     4. Zwraca `[]` jesli brak ustawien lub blad parsowania (graceful fallback, nie throw)
   Import `SupabaseClient` z `@supabase/supabase-js`.

2. **default-prompts.ts** — Dodaj wpis FB do `DEFAULT_PROMPTS` array na koncu (przed zamknieciem tablicy):
   ```typescript
   import { FB_POST_ANALYSIS_SECTION_KEY, FB_POST_ANALYSIS_SYSTEM_PROMPT, FB_POST_ANALYSIS_USER_PROMPT_TEMPLATE } from '@/lib/fb/fb-analysis-prompt';
   ```
   Nowy wpis:
   ```typescript
   {
     section_key: FB_POST_ANALYSIS_SECTION_KEY,
     title: 'Analiza postu FB',
     section_order: 100,
     system_prompt: FB_POST_ANALYSIS_SYSTEM_PROMPT,
     user_prompt_template: FB_POST_ANALYSIS_USER_PROMPT_TEMPLATE,
   }
   ```
   WAZNE: `section_order: 100` zeby prompt FB byl na koncu listy (po emailowych sekcjach ktore maja 0-13). Nie zmieniaj istniejacych wpisow.

3. **fb-settings/route.ts** — Dodaj `'fb_keywords'` do allowlist. W POST handler, po linii `const isDeveloperInstruction = key.startsWith('developer_instruction:');`, dodaj:
   ```typescript
   const isFbKeywords = key === 'fb_keywords' || key.startsWith('fb_keywords:');
   ```
   Zaktualizuj warunek walidacji:
   ```typescript
   if (!isEncryptedKey && !isSuperAdminKey && !isDeveloperInstruction && !isFbKeywords) {
   ```
   Zaktualizuj tez komunikat bledu zeby zawierał `fb_keywords, fb_keywords:*`.
   fb_keywords NIE jest szyfrowany — uzywa `value_plain` (JSON array string).
  </action>
  <verify>
  - `npx tsc --noEmit` przechodzi bez bledow
  - `grep -r "matchKeywords" src/lib/fb/fb-keywords.ts` potwierdza eksport
  - `grep -r "_fb_post_analysis" src/lib/ai/default-prompts.ts` potwierdza rejestracje promptu
  - `grep -r "fb_keywords" src/app/api/fb-settings/route.ts` potwierdza rozszerzony allowlist
  </verify>
  <done>
  - fb-keywords.ts eksportuje matchKeywords() i loadKeywords() z graceful fallback
  - Prompt FB zarejestrowany w DEFAULT_PROMPTS — admin widzi go na stronie promptow (istniejacy /api/prompts endpoint go zwroci)
  - fb-settings POST akceptuje klucze fb_keywords i fb_keywords:{groupId} jako value_plain
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — zero bledow TypeScript
- Plik `supabase/migrations/20260223_10_01_fb_analysis_paused_metadata.sql` istnieje z ALTER TABLE dodajacym 'paused' do CHECK + metadata JSONB
- Nowy plik `src/lib/fb/fb-analysis-prompt.ts` istnieje z eksportami: FB_POST_ANALYSIS_SECTION_KEY, FB_POST_ANALYSIS_SYSTEM_PROMPT, FB_POST_ANALYSIS_USER_PROMPT_TEMPLATE, FB_POST_ANALYSIS_SCHEMA, buildFbUserPrompt
- Nowy plik `src/lib/fb/fb-keywords.ts` istnieje z eksportami: matchKeywords, loadKeywords
- `ai-provider.ts` — callAI ma 4 parametry (4. opcjonalny: responseFormat)
- `default-prompts.ts` — DEFAULT_PROMPTS zawiera wpis z section_key '_fb_post_analysis'
- `fb-settings/route.ts` — POST akceptuje klucz 'fb_keywords'
- `fb.ts` — FbPostAnalysisResult, FbAnalysisStatus z 'paused', FbSettingsKey z 'fb_keywords'
</verification>

<success_criteria>
- SQL migration plik istnieje i zawiera poprawne ALTER TABLE (user musi wkleic w SQL Editor)
- callAI("...", "...", "...", { type: "json_schema", json_schema: { ... } }) kompiluje sie bez bledow
- buildFbUserPrompt() zwraca pelny user prompt z wypelnionymi placeholderami
- matchKeywords("awaria windy", ["winda", "awaria"]) zwraca ["winda", "awaria"]
- loadKeywords() zwraca [] bez rzucania wyjatku gdy brak konfiguracji
- GET /api/prompts zwraca prompt z section_key '_fb_post_analysis' w liscie
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-sentiment-analysis/10-01-SUMMARY.md`
</output>
