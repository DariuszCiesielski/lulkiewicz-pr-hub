---
phase: 10-ai-sentiment-analysis
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - src/hooks/useFbAnalysisJob.ts
  - src/components/fb/FbAnalysisPanel.tsx
  - src/app/(hub)/fb-analyzer/analyze/page.tsx
  - src/components/fb/SettingsForm.tsx
  - src/app/api/fb-settings/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin klika Analizuj na grupie — progress bar pokazuje X/Y postow w czasie rzeczywistym"
    - "Admin moze wstrzymac i wznowic analize w trakcie"
    - "Admin moze konfigurowac slowa kluczowe do monitorowania w ustawieniach"
    - "Strona Analiza AI wyswietla rzeczywiste grupy z bazy (nie mock data)"
    - "Admin widzi historie ostatnich analiz z statusami i progressem"
    - "Admin moze wymusic re-analize postow juz przeanalizowanych (checkbox)"
  artifacts:
    - path: "src/hooks/useFbAnalysisJob.ts"
      provides: "Polling hook for FB analysis"
      exports: ["useFbAnalysisJob"]
    - path: "src/components/fb/FbAnalysisPanel.tsx"
      provides: "Analysis launch UI with progress"
      exports: ["default"]
    - path: "src/app/(hub)/fb-analyzer/analyze/page.tsx"
      provides: "Full analysis page replacing mock data"
      contains: "useFbAnalysisJob"
    - path: "src/components/fb/SettingsForm.tsx"
      provides: "Keywords config section added"
      contains: "fb_keywords"
    - path: "src/app/api/fb-settings/route.ts"
      provides: "GET response extended with fb_keywords"
      contains: "fb_keywords"
  key_links:
    - from: "src/hooks/useFbAnalysisJob.ts"
      to: "/api/fb/analysis"
      via: "fetch POST to start job"
      pattern: "fetch.*api/fb/analysis"
    - from: "src/hooks/useFbAnalysisJob.ts"
      to: "/api/fb/analysis/process"
      via: "polling fetch POST"
      pattern: "api/fb/analysis/process"
    - from: "src/app/(hub)/fb-analyzer/analyze/page.tsx"
      to: "src/hooks/useFbAnalysisJob.ts"
      via: "hook usage"
      pattern: "useFbAnalysisJob"
    - from: "src/app/(hub)/fb-analyzer/analyze/page.tsx"
      to: "/api/fb-groups"
      via: "fetch real groups"
      pattern: "fetch.*api/fb-groups"
    - from: "src/components/fb/SettingsForm.tsx"
      to: "/api/fb-settings"
      via: "POST fb_keywords"
      pattern: "fb_keywords"
---

<objective>
Stworzenie frontendu do analizy AI postow FB: hook pollingowy, panel analizy z progress barem, zastapienie mock data rzeczywistymi danymi z API, i sekcja konfiguracji slow kluczowych w ustawieniach.

Purpose: Kompletne UI pozwalajace adminowi uruchomic, monitorowac, wstrzymac i wznowic analize AI postow. To ostatni plan Phase 10 — po nim admin moze analizowac posty end-to-end.
Output: Hook pollingowy, komponent panelu analizy, zaktualizowana strona analyze, rozszerzone ustawienia o slowa kluczowe
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ai-sentiment-analysis/10-RESEARCH.md
@.planning/phases/10-ai-sentiment-analysis/10-01-SUMMARY.md
@.planning/phases/10-ai-sentiment-analysis/10-02-SUMMARY.md
@src/hooks/useAnalysisJob.ts
@src/hooks/useScrapeJob.ts
@src/components/fb/SettingsForm.tsx
@src/app/(hub)/fb-analyzer/analyze/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: useFbAnalysisJob hook + FbAnalysisPanel komponent</name>
  <files>
    src/hooks/useFbAnalysisJob.ts
    src/components/fb/FbAnalysisPanel.tsx
  </files>
  <action>
1. **useFbAnalysisJob.ts** — Nowy hook na wzor `useAnalysisJob.ts` ale uproszczony i dostosowany do FB:

   Eksportuj typy:
   ```typescript
   export type FbAnalysisUIStatus = 'idle' | 'starting' | 'processing' | 'paused' | 'completed' | 'error';

   export interface FbAnalysisProgress {
     analyzedPosts: number;
     totalPosts: number;
     percentage: number;
   }
   ```

   Eksportuj interface:
   ```typescript
   export interface UseFbAnalysisJobReturn {
     startAnalysis: (groupId: string, forceReanalyze?: boolean) => Promise<void>;
     pauseJob: () => Promise<void>;
     resumeJob: (jobId: string, analyzedPosts: number, totalPosts: number) => void;
     status: FbAnalysisUIStatus;
     progress: FbAnalysisProgress;
     error: string | null;
     jobId: string | null;
     reset: () => void;
   }
   ```

   Implementacja:
   - `BATCH_DELAY_MS = 800` (identyczne z email analyzer)
   - `startAnalysis(groupId, forceReanalyze?)`:
     1. POST `/api/fb/analysis` z `{ groupId, forceReanalyze }`
     2. Na sukces: setJobId, setStatus('processing'), start processBatch
   - `processBatch(jobId)`:
     1. POST `/api/fb/analysis/process` z `{ jobId }`
     2. Update progress (analyzedPosts, totalPosts, percentage)
     3. Jesli data.status === 'paused': setStatus('paused'), stop
     4. Jesli data.hasMore: setTimeout(processBatch, 800ms)
     5. Jesli !hasMore && status === 'completed': setStatus('completed'), call onComplete
   - `pauseJob()`:
     1. clearTimeout, setStatus('paused')
     2. POST `/api/fb/analysis/pause` z `{ jobId, action: 'pause' }`
   - `resumeJob(jobId, analyzedPosts, totalPosts)`:
     1. POST `/api/fb/analysis/pause` z `{ jobId, action: 'resume' }`
     2. setStatus('processing'), start processBatch
   - `reset()`: clear all state
   - Cleanup: useEffect unmount clears timeout, sets mounted=false
   - Error handling: identyczne jak useAnalysisJob (try/catch, setError, setStatus('error'))

2. **FbAnalysisPanel.tsx** — Komponent panelu analizy AI:

   Props:
   ```typescript
   interface FbAnalysisPanelProps {
     groups: Array<{ id: string; name: string; total_posts: number }>;
     onAnalysisComplete?: () => void;
   }
   ```

   Layout (2-kolumnowy grid na md+, 1-kolumnowy na mobile):

   **Lewa kolumna: "Uruchom analize"**
   - Select grupy (z props.groups, NIE mock data)
   - Po wyborze grupy: informacja ile nowych postow do analizy (pobierz z API: GET `/api/fb/analysis?groupId={id}` zeby zobaczyc czy jest aktywny job, albo pokaz total_posts z grupy)
   - Checkbox "Analizuj ponownie juz przetworzone posty" (forceReanalyze)
   - Przycisk "Analizuj" (Play icon) — disabled jesli brak grupy lub analiza trwa
   - Progress bar gdy status = 'processing':
     * Pasek z kolorem accent-primary, animate-pulse gdy aktywny
     * Tekst: "X/Y postow (Z%)"
   - Przyciski pause/resume gdy analiza trwa
   - Status completed: zielony badge "Zakonczona"
   - Status error: czerwony badge + error message
   - Przycisk "Reset" po zakonczeniu/bledzie

   **Prawa kolumna: "Ostatnie analizy"**
   - Fetch GET `/api/fb/analysis` (bez groupId — wszystkie)
   - Lista jobow z: group name, status badge (kolorowe ikony), progress bar, analyzed/total, data
   - Mozliwosc wznowienia paused joba (przycisk Resume)

   Stylowanie: CSS variables (--bg-secondary, --border-primary, --text-primary, --text-muted, --accent-primary). Ikony: Brain, Play, Pause, RotateCcw, CheckCircle2, XCircle, Loader2 z lucide-react.
  </action>
  <verify>
  - `npx tsc --noEmit` przechodzi
  - `grep "useFbAnalysisJob" src/hooks/useFbAnalysisJob.ts` potwierdza eksport
  - `grep "FbAnalysisPanel" src/components/fb/FbAnalysisPanel.tsx` potwierdza komponent
  - `grep "api/fb/analysis" src/hooks/useFbAnalysisJob.ts` potwierdza endpoint calls
  </verify>
  <done>
  - useFbAnalysisJob hook eksportuje start/pause/resume/reset z polling na 800ms
  - FbAnalysisPanel komponent renderuje select grupy, progress bar, historie analiz
  - Calosc uzywa CSS variables i lucide-react icons (design system)
  </done>
</task>

<task type="auto">
  <name>Task 2: Strona analyze (replace mock) + keywords w settings + fb-settings GET rozszerzenie</name>
  <files>
    src/app/(hub)/fb-analyzer/analyze/page.tsx
    src/components/fb/SettingsForm.tsx
    src/app/api/fb-settings/route.ts
  </files>
  <action>
1. **analyze/page.tsx** — Calkowite zastapienie mock data rzeczywistymi danymi:
   - USUN import z `@/lib/mock/fb-mock-data` — zadnych mockow
   - Dodaj import `FbAnalysisPanel` z `@/components/fb/FbAnalysisPanel`
   - useEffect: fetch `/api/fb-groups` zeby pobrac liste aktywnych grup (filter: status = 'active', deleted_at IS NULL — API juz to robi)
   - Render FbAnalysisPanel z groups={groups} i onAnalysisComplete callback (refresh groups)

   Sekcja promptu AI (pod panelem):
   - Fetch aktualny prompt: GET `/api/prompts` i znajdz section_key === '_fb_post_analysis'
   - Pokaz tytul + readonly textarea z aktualnym system_prompt (jak dotychczas ale z prawdziwych danych)
   - Przycisk "Edytuj prompt" — link/redirect do strony Prompty (`/email-analyzer/prompts`) lub modal.
     UWAGA: Istniejaca strona promptow jest w email-analyzer. Najlatwiej: link z targetem do strony promptow. Prompt FB pojawi sie na liscie dzieki rejestracji w default-prompts.ts (Plan 01).
     Alternatywnie: otworz `/email-analyzer/prompts` w nowym tabie. Zachowaj prostosc.
   - Tekst pod textarea: "Ten prompt jest uzywany do analizy kazdego postu. Edytuj na stronie Prompty."

   Obsluga stanow:
   - Loading: spinner z Loader2
   - Error: komunikat bledu
   - Empty groups: "Brak aktywnych grup. Dodaj grupy w zakladce Grupy."

2. **SettingsForm.tsx** — Dodaj sekcje "Slowa kluczowe" (5. karta/sekcja):

   Istniejace karty: Apify Token, FB Cookies, Actor ID (super admin), Instrukcje AI.
   Dodaj **5. karte**: "Slowa kluczowe do monitorowania"

   - Textarea do wpisywania slow kluczowych (jedno per linia lub po przecinku)
   - Load: pobierz z GET /api/fb-settings rozszerzonego o `fb_keywords` (patrz punkt 3 ponizej)
   - Save: POST /api/fb-settings z `{ key: 'fb_keywords', value: JSON.stringify(keywordsArray) }`
   - Parse: rozdziel input po newline i przecinku, trim(), filter empty, unique
   - Domyslne slowa kluczowe (placeholder): "winda, awaria, przeciek, smrod, ochrona, monitoring, oplaty, czynsz, parking, smieci, sprzatanie, remont"
   - Informacja: "Posty zawierajace te slowa kluczowe otrzymaja podwyzszone relevance score (+1-2 pkt)."

3. **fb-settings/route.ts** — Rozszerz GET response o `fb_keywords`:
   ```typescript
   const fbKeywordsRecord = settings.find((s) => s.key === 'fb_keywords');
   // w return:
   fb_keywords: fbKeywordsRecord?.value_plain ? JSON.parse(fbKeywordsRecord.value_plain) : [],
   ```
   UWAGA: Plan 10-01 juz dodal `fb_keywords` do POST allowlist. Tutaj TYLKO rozszerzamy GET response.
  </action>
  <verify>
  - `npx tsc --noEmit` przechodzi
  - `grep "mock" src/app/\\(hub\\)/fb-analyzer/analyze/page.tsx` NIE zwraca wynikow (zero mockow)
  - `grep "FbAnalysisPanel" src/app/\\(hub\\)/fb-analyzer/analyze/page.tsx` potwierdza uzycie komponentu
  - `grep "fb_keywords" src/components/fb/SettingsForm.tsx` potwierdza sekcje keywords
  - `grep "fb_keywords" src/app/api/fb-settings/route.ts` potwierdza rozszerzony GET response
  - `npm run build` przechodzi (lub `next build`)
  </verify>
  <done>
  - Strona Analiza AI wyswietla rzeczywiste grupy z bazy, panel analizy z progress barem, i podglad promptu
  - Sekcja slow kluczowych w ustawieniach pozwala na konfiguracje globalnych keywords
  - GET /api/fb-settings zwraca fb_keywords w response (do uzycia przez SettingsForm)
  - Zero mock data na stronie analyze
  - Admin moze uruchomic, wstrzymac, wznowic i resetowac analize z poziomu UI
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — zero bledow
- `npm run build` — build przechodzi (Next.js kompiluje wszystkie strony)
- Strona `/fb-analyzer/analyze` nie importuje nic z mock data
- useFbAnalysisJob hook komunikuje sie z 3 API routes: /api/fb/analysis, /api/fb/analysis/process, /api/fb/analysis/pause
- FbAnalysisPanel renderuje select grupy, progress bar, historie analiz
- SettingsForm ma sekcje slow kluczowych z save/load
- fb-settings GET response zawiera fb_keywords
</verification>

<success_criteria>
- Admin wybiera grupe, klika "Analizuj" — widzi progress bar X/Y postow rosnacy w czasie rzeczywistym
- Admin moze wstrzymac analize (Pause) i wznowic (Resume) — stan zachowany
- Po zakonczeniu: zielony badge "Zakonczona" z podsumowaniem
- Admin widzi liste ostatnich analiz ze statusami
- Admin moze edytowac slowa kluczowe w ustawieniach — zapisuja sie do fb_settings
- Checkbox "Analizuj ponownie" pozwala na re-analize juz przetworzonych postow
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-sentiment-analysis/10-03-SUMMARY.md`
</output>
