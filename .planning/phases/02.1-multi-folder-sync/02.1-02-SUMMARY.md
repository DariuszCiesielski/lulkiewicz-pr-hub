---
phase: 02.1-multi-folder-sync
plan: 02
subsystem: api
tags: [graph-api, sync, email-parser, multi-folder, delta-sync, excluded-folders]

# Dependency graph
requires:
  - phase: 02.1-01
    provides: "graph-folders.ts, fetchMessagesSince, filterExcludedFolders, parentFolderId w $select"
provides:
  - "Sync API routes adaptowane do multi-folder (all-folders endpoints)"
  - "email-parser z folder_id z parentFolderId"
  - "Delta sync oparty na dacie (last_sync_at) zamiast delta_link"
  - "Excluded folders cachowane w sync_jobs.metadata"
affects: ["02.1-03", "sync-ui", "thread-builder"]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Excluded folder IDs cached in job metadata (1 Graph API call per sync, not per batch)"
    - "Date-based delta sync via $filter=receivedDateTime ge (replaces delta_link)"
    - "filterExcludedFolders in both full and delta sync paths"

key-files:
  modified:
    - "src/lib/email/email-parser.ts"
    - "src/app/api/sync/process/route.ts"
    - "src/app/api/sync/route.ts"
    - "src/types/email.ts"
    - "src/lib/email/email-fetcher.ts"

key-decisions:
  - "folder_id dodany do interfejsu Email i upsert rows — dane folderu zapisywane do bazy"
  - "Delta sync walidacja zmieniona z delta_link na last_sync_at"
  - "Excluded folder IDs cachowane w job.metadata — reuse miedzy batchami"
  - "fetchDeltaPage calkowicie usuniete z sync/process — zastapione fetchMessagesSince"

patterns-established:
  - "Job metadata caching: drogie dane z Graph API zapisywane w sync_jobs.metadata dla reuse miedzy batchami"

# Metrics
duration: 3min
completed: 2026-02-15
---

# Phase 2.1 Plan 02: Sync API Routes Multi-Folder Adaptation Summary

**Sync routes uzywaja /messages (all-folders) z excluded folder filtering i date-based delta sync zamiast delta_link**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-15T08:30:40Z
- **Completed:** 2026-02-15T08:33:51Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- email-parser zwraca folder_id z msg.parentFolderId — identyfikacja folderu zrodlowego
- sync/route.ts nie wymaga delta_link — delta sync wymaga tylko last_sync_at
- sync/process route adaptowany do all-folders: fetchMessagesSince + filterExcludedFolders
- Excluded folder IDs cachowane w job.metadata (1 API call per sync, nie per batch)
- delta_link calkowicie usuniete z sync/process — brak odczytu i zapisu

## Task Commits

Each task was committed atomically:

1. **Task 1: email-parser.ts — dodanie folder_id** - `3b3624b` (feat)
2. **Task 2: sync/route.ts — usuniecie wymagania delta_link** - `d8c0874` (feat)
3. **Task 3: sync/process/route.ts — adaptacja do multi-folder** - `b7db1b8` (feat)

**Plan metadata:** (pending)

## Files Created/Modified
- `src/lib/email/email-parser.ts` — dodano folder_id: msg.parentFolderId || null
- `src/types/email.ts` — dodano folder_id: string | null do interfejsu Email
- `src/lib/email/email-fetcher.ts` — dodano folder_id do upsert rows
- `src/app/api/sync/route.ts` — zmieniono walidacje delta sync z delta_link na last_sync_at
- `src/app/api/sync/process/route.ts` — pelna adaptacja: importy, excluded folders, full+delta sync, usunieto delta_link

## Decisions Made
- **folder_id w upsert**: Dodano folder_id do rows w upsertEmails — dane folderu zapisywane do bazy (Rule 2: missing critical — bez tego folder_id z parsera bylby ignorowany)
- **Brak usuwania kolumny delta_link**: Kolumna istnieje w DB ale nie jest juz uzywana — bezpieczne podejscie (moze sie przydac jako fallback)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Dodano folder_id do upsert rows w email-fetcher.ts**
- **Found during:** Task 1 (email-parser folder_id)
- **Issue:** Plan wskazywal dodanie folder_id do parsera i typu Email, ale nie do rows w upsertEmails — folder_id nie bylby zapisywany do bazy
- **Fix:** Dodano `folder_id: email.folder_id ?? null` do rows w upsertEmails
- **Files modified:** src/lib/email/email-fetcher.ts
- **Verification:** TypeScript compilation passes, folder_id w rows
- **Committed in:** 3b3624b (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Auto-fix konieczny dla poprawnego zapisywania folder_id do bazy. Bez niego cala zmiana w parserze bylaby bezuzyteczna.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Sync API routes w pelni adaptowane do multi-folder sync
- Gotowe do testowania z prawdziwa skrzynka (re-sync)
- Nastepny plan 02.1-03: legenda statusow + polskie znaki diakrytyczne

---
*Phase: 02.1-multi-folder-sync*
*Completed: 2026-02-15*
