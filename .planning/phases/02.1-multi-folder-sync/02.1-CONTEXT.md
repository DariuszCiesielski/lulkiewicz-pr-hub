# Phase 2.1: Multi-Folder Sync — INSERTED

## Cel fazy

Rozszerzenie synchronizacji maili o wszystkie foldery skrzynki Outlook (poza Spam i Drafts).
Obecna synchronizacja pobiera maile TYLKO z folderu Inbox — brakuje maili wysłanych (Sent Items),
przez co wątki mają 1 uczestnika, statusy są błędne (wszystko "Oczekujący"), a czasy odpowiedzi
nie mogą być obliczone.

## Dlaczego INSERTED (nie Phase 9)

- Problem wykryty podczas pierwszej analizy produkcyjnej skrzynki (3012 maili)
- Blokuje poprawne działanie email-analyzer v1.0 (raporty AI będą niekompletne)
- Dotyczy istniejącej fazy 2 (Email Connection & Fetching), stąd numer 2.1

## Kontekst techniczny

### Microsoft Graph API

- **Endpoint all-folders**: `GET /users/{email}/messages` — zwraca maile ze WSZYSTKICH folderów
- **Endpoint per-folder**: `GET /users/{email}/mailFolders/{folderId}/messages` — aktualnie używany (hardcoded do inbox)
- **Delta sync**: `/messages/delta` jest dostępny TYLKO per-folder, nie na `/messages`
- **Rozwiązanie delta**: "smart resync" z `$filter=receivedDateTime ge {lastSyncDate}` na `/messages`
- **Foldery do wykluczenia**: `drafts`, `junkemail` (docelowo też `deleteditems`)
- **Well-known folder names**: Graph API akceptuje nazwy: inbox, drafts, sentitems, junkemail, deleteditems, archive

### Obecna architektura sync

- `src/lib/email/email-fetcher.ts` — hardcoded `/mailFolders/inbox/messages`
- `src/app/api/sync/process/route.ts` — batch processing (100/batch, safety timeout 50s)
- `src/app/api/sync/route.ts` — job creation, wymaga delta_link dla delta sync
- `src/hooks/useSyncJob.ts` — client-side polling (500ms między batchami)
- `mailboxes.delta_link` — przechowuje deltaLink z Graph API (stanie się nieużywany)

### Dodatkowe poprawki w tej fazie

1. **Legenda statusów** — brak wyjaśnienia co oznaczają statusy wątków (Oczekujący/Otwarty/Zamknięty)
2. **Polskie znaki diakrytyczne** — 47 miejsc w 8 plikach UI z brakującymi ą, ę, ó, ś, ć, ź, ż, ł, ń

### Poprawki już wykonane (w bieżącej sesji Cursor)

- `email-fetcher.ts`: deduplikacja w batchu (fix: ON CONFLICT duplicate row)
- `thread-builder.ts`: paginacja pobierania maili (fix: Supabase 1000 row limit)
- `thread-builder.ts`: batch insert threads + parallel email updates (fix: timeout)
- `thread-builder.ts`: domain-based `isIncoming()` (fix: status detection)
- `SyncProgress.tsx` + `useSyncJob.ts` + API: totalInDatabase w komunikacie
- `MailboxList.tsx`: wyróżnienie "Odśwież" po pierwszym sync, info panel
- `ThreadFilters.tsx`: ujednolicone etykiety statusów

## Scope

- 3 plany, 2 wave'y
- Plan 01 (Wave 1): Schema DB + email-fetcher + graph-folders helper
- Plan 02 (Wave 1): Sync API routes adaptacja + email-parser
- Plan 03 (Wave 2): Legenda statusów + polskie znaki diakrytyczne (47 poprawek)
