---
phase: 02.1-multi-folder-sync
verified: 2026-02-15T09:15:00Z
status: passed
score: 13/13 must-haves verified
---

# Phase 2.1: Multi-Folder Sync Verification Report

**Phase Goal:** Sync wszystkich folderów (nie tylko Inbox), legenda statusów, polskie znaki diakrytyczne
**Verified:** 2026-02-15T09:15:00Z
**Status:** PASSED
**Re-verification:** No - initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | emails tabela ma kolumnę folder_id TEXT | VERIFIED | supabase/migrations/20260214_02_1_01_multi_folder_sync.sql linia 5 |
| 2 | sync_jobs tabela ma kolumnę metadata JSONB | VERIFIED | supabase/migrations/20260214_02_1_01_multi_folder_sync.sql linia 8 |
| 3 | getExcludedFolderIds zwraca listę folder ID do wykluczenia | VERIFIED | graph-folders.ts eksportuje funkcję, używana w sync/process/route.ts linia 164 |
| 4 | fetchMessagesPage używa /users/{email}/messages zamiast /mailFolders/inbox/messages | VERIFIED | email-fetcher.ts linia 68 endpoint /messages (all-folders) |
| 5 | fetchMessagesSince istnieje i używa $filter=receivedDateTime ge | VERIFIED | email-fetcher.ts linia 90-117, używana w sync/process linia 222 |
| 6 | MESSAGE_SELECT_FIELDS zawiera parentFolderId | VERIFIED | email-fetcher.ts linia 21 |
| 7 | mapGraphMessageToEmail zwraca folder_id z msg.parentFolderId | VERIFIED | email-parser.ts linia 142 |
| 8 | sync/process route używa fetchMessagesPage z /messages (all-folders) | VERIFIED | sync/process/route.ts linia 201 |
| 9 | sync/process route filtruje excluded folders w każdym batchu | VERIFIED | filterExcludedFolders wywołany 2x (linia 208, 230) |
| 10 | sync/process route dla delta sync używa fetchMessagesSince z last_sync_at | VERIFIED | sync/process/route.ts linia 220-227 |
| 11 | sync/route.ts nie wymaga delta_link do uruchomienia delta sync | VERIFIED | sync/route.ts linia 62 wymaga tylko last_sync_at |
| 12 | ThreadList.tsx zawiera legendę statusów z opisami Oczekujący/Otwarty/Zamknięty | VERIFIED | ThreadList.tsx linia 75, zwijalna legenda z 3 statusami |
| 13 | Żaden plik UI nie zawiera polskich słów bez znaków diakrytycznych | VERIFIED | grep po 8 plikach zwrócił 0 wyników |

**Score:** 13/13 truths verified


### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| supabase/migrations/20260214_02_1_01_multi_folder_sync.sql | ALTER TABLE emails + sync_jobs | EXISTS + SUBSTANTIVE + WIRED | 8 lines, ALTER TABLE x2, IF NOT EXISTS, ready for SQL Editor |
| src/lib/email/graph-folders.ts | Helper do pobierania excluded folder IDs | EXISTS + SUBSTANTIVE + WIRED | 40 lines, eksportuje getExcludedFolderIds, używany w sync/process |
| src/lib/email/email-fetcher.ts | Zaktualizowany fetcher z all-folders endpoints | EXISTS + SUBSTANTIVE + WIRED | 262 lines, /messages endpoints, fetchMessagesSince, filterExcludedFolders |
| src/lib/email/email-parser.ts | Parser z folder_id | EXISTS + SUBSTANTIVE + WIRED | 144 lines, folder_id w linia 142 |
| src/app/api/sync/process/route.ts | Batch processing z all-folders | EXISTS + SUBSTANTIVE + WIRED | 350+ lines, importuje wszystkie nowe funkcje |
| src/app/api/sync/route.ts | Job creation bez wymagania delta_link | EXISTS + SUBSTANTIVE + WIRED | Walidacja wymaga last_sync_at linia 62 |
| src/components/threads/ThreadList.tsx | Legenda statusów wątków | EXISTS + SUBSTANTIVE + WIRED | Zwijalna legenda z 3 statusami |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| sync/process | graph-folders | getExcludedFolderIds | WIRED | Import + wywołanie + cache w metadata |
| sync/process | email-fetcher | fetchMessagesSince | WIRED | Import + wywołanie linia 222 delta sync |
| sync/process | email-fetcher | filterExcludedFolders | WIRED | Import + wywołanie 2x full+delta |
| email-fetcher | MESSAGE_SELECT | parentFolderId | WIRED | Dodany linia 21, używany 3x |
| email-parser | Email type | folder_id | WIRED | mapGraphMessageToEmail + upsertEmails |
| sync/route | mailboxes | last_sync_at | WIRED | Select + walidacja delta sync |

### Requirements Coverage

Phase 2.1 nie ma powiązanych requirements w REQUIREMENTS.md (INSERTED phase dodana post-hoc).

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| email-fetcher.ts | 136-192 | @deprecated fetchDeltaPage preserved | INFO | Zachowany dla backward compatibility |

**Blocker anti-patterns:** 0
**Warning anti-patterns:** 0
**Info anti-patterns:** 1 (deprecated function preserved intentionally)


### Human Verification Required

#### 1. SQL Migration Application

**Test:** Wklej zawartość supabase/migrations/20260214_02_1_01_multi_folder_sync.sql w Supabase Dashboard SQL Editor
**Expected:** Success message, kolumny folder_id i metadata dodane do tabel
**Why human:** SQL migrations muszą być aplikowane ręcznie (Supabase CLI jest zepsuty)

#### 2. Multi-Folder Sync Test

**Test:** 
1. Wybierz istniejącą skrzynkę Outlook
2. Uruchom Synchronizuj (full sync)
3. Sprawdź logi - expected: success message z excluded folder IDs
4. Sprawdź tabelę emails w Supabase - expected: kolumna folder_id wypełniona
5. Sprawdź tabelę sync_jobs - expected: kolumna metadata zawiera excludedFolderIds

**Expected:** 
- Synchronizacja pobiera maile ze WSZYSTKICH folderów (nie tylko Inbox)
- Excluded folders (spam, drafts, deleted items) są odfiltrowane
- folder_id jest zapisywany do bazy dla każdego emaila

**Why human:** Wymaga prawdziwego połączenia z Outlook API

#### 3. Delta Sync Without delta_link

**Test:**
1. Po zakończeniu full sync z testu 2
2. Uruchom Odśwież (delta sync) na tej samej skrzynce
3. Expected: sync job startuje BEZ błędu delta_link required
4. Sprawdź logi - expected: używa fetchMessagesSince z $filter=receivedDateTime ge

**Expected:** Delta sync działa bez delta_link (wymaga tylko last_sync_at)
**Why human:** Wymaga prawdziwego połączenia i wcześniejszego full sync

#### 4. Thread Status Legend

**Test:**
1. Przejdź do /email-analyzer/threads
2. Sprawdź czy nad listą wątków jest przycisk Legenda statusów z ikoną Info
3. Kliknij przycisk - expected: rozwinięcie legendy z 3 statusami

**Expected:** 
- Legenda jest zwijalna (domyślnie zwinięta)
- Kolory badge'ów zgadzają się z kolorami statusów w ThreadCard

**Why human:** Wizualna weryfikacja UI


### Gaps Summary

**No gaps found.** Wszystkie must-haves z 3 planów są zweryfikowane:

- **Plan 01 (6/6):** Migracja SQL gotowa, graph-folders.ts eksportuje getExcludedFolderIds, email-fetcher.ts ma all-folders endpoints, fetchMessagesSince, filterExcludedFolders, parentFolderId w MESSAGE_SELECT_FIELDS
- **Plan 02 (5/5):** email-parser zwraca folder_id, sync/process używa all-folders endpoints z filtrowaniem, delta sync oparty na last_sync_at zamiast delta_link
- **Plan 03 (2/2):** Legenda statusów w ThreadList, polskie znaki diakrytyczne poprawione w 8 plikach UI (60+ miejsc)

**TypeScript compilation:** PASSED (npx tsc --noEmit bez błędów)

**Critical notes:**
1. SQL migracja MUSI być wklejona w Supabase SQL Editor przed uruchomieniem sync
2. Faktyczne działanie multi-folder sync wymaga re-sync istniejącej skrzynki (test human verification 2)
3. fetchDeltaPage zachowany jako @deprecated (nie usunięty) - to świadoma decyzja projektowa, nie bug

---

_Verified: 2026-02-15T09:15:00Z_
_Verifier: Claude (gsd-verifier)_
