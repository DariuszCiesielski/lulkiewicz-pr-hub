---
phase: 02.1-multi-folder-sync
plan: 01
subsystem: database, api
tags: [microsoft-graph, email-sync, multi-folder, sql-migration, graph-api]

# Dependency graph
requires:
  - phase: 02-email-connection
    provides: email-fetcher.ts, graph-auth.ts, graph-client.ts, emails table, sync_jobs table
provides:
  - emails.folder_id column (TEXT) for source folder identification
  - sync_jobs.metadata column (JSONB) for sync configuration
  - getExcludedFolderIds() helper for Graph API folder exclusion
  - fetchMessagesPage() using /messages (all-folders endpoint)
  - fetchMessagesSince() for smart resync with date filter
  - filterExcludedFolders() for post-fetch filtering
affects: [02.1-02 (sync route adaptation), 02.1-03 (UI polish)]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "All-folders sync via /users/{email}/messages instead of /mailFolders/inbox/messages"
    - "Smart resync with $filter=receivedDateTime ge as delta replacement"
    - "Post-fetch folder filtering (fetch all, filter excluded)"
    - "Well-known folder names for excluded folder ID resolution"

key-files:
  created:
    - "supabase/migrations/20260214_02_1_01_multi_folder_sync.sql"
    - "src/lib/email/graph-folders.ts"
  modified:
    - "src/lib/email/email-fetcher.ts"

key-decisions:
  - "parentFolderId added to MESSAGE_SELECT_FIELDS for folder identification"
  - "getMailboxMessageCount uses /messages with $count instead of /mailFolders/inbox totalItemCount"
  - "fetchDeltaPage preserved with @deprecated tag (not deleted) for backward compatibility"
  - "filterExcludedFolders is a pure function (no API calls) for batch filtering"

patterns-established:
  - "Well-known folder names: Graph API accepts names (inbox, drafts, sentitems, junkemail, deleteditems) instead of IDs"
  - "Smart resync pattern: $filter=receivedDateTime ge replaces per-folder delta sync"

# Metrics
duration: 4min
completed: 2026-02-15
---

# Phase 2.1 Plan 01: DB Schema + Graph Folders Helper + All-Folders Endpoints Summary

**Migracja SQL (folder_id, metadata), helper getExcludedFolderIds z Graph API well-known folders, email-fetcher z endpointami /messages (all-folders) + fetchMessagesSince jako zamiennik delta sync**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-15T08:23:58Z
- **Completed:** 2026-02-15T08:27:22Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments
- Migracja SQL z kolumnami folder_id (emails) i metadata (sync_jobs) gotowa do wklejenia w SQL Editor
- Helper graph-folders.ts pobiera ID folderow do wykluczenia (drafts, junkemail, deleteditems) via Graph API well-known folder names
- email-fetcher.ts zmieniony na all-folders endpointy: /messages zamiast /mailFolders/inbox/messages
- Nowa funkcja fetchMessagesSince z $filter=receivedDateTime ge zastepuje delta sync (ktory jest per-folder only)
- filterExcludedFolders do filtrowania wiadomosci z wykluczonych folderow po pobraniu batcha

## Task Commits

Each task was committed atomically:

1. **Task 1: Migracja SQL -- nowe kolumny dla multi-folder sync** - `a487504` (chore)
2. **Task 2: Helper graph-folders.ts -- excluded folder IDs** - `7f7a227` (feat)
3. **Task 3: email-fetcher.ts -- all-folders endpoints** - `0bde990` (feat)

## Files Created/Modified
- `supabase/migrations/20260214_02_1_01_multi_folder_sync.sql` - ALTER TABLE emails (folder_id) + ALTER TABLE sync_jobs (metadata)
- `src/lib/email/graph-folders.ts` - getExcludedFolderIds() -- pobiera ID 3 wykluczonych folderow z Graph API
- `src/lib/email/email-fetcher.ts` - All-folders endpoints, fetchMessagesSince, filterExcludedFolders, parentFolderId w $select

## Decisions Made
- parentFolderId dodany do MESSAGE_SELECT_FIELDS -- kazdy email teraz zawiera info o folderze zrodlowym
- getMailboxMessageCount zmieniony na /messages z $count i ConsistencyLevel: eventual (Graph API wymaga tego headera dla $count)
- fetchDeltaPage zachowany z @deprecated -- nie usuwamy, bo sync/process/route.ts nadal go importuje (zostanie zaktualizowany w planie 02.1-02)
- filterExcludedFolders jako czysta funkcja (pure function) -- nie robi API calls, filtruje in-memory po pobraniu batcha

## Deviations from Plan
None - plan executed exactly as written.

## User Setup Required
**WAZNE:** User musi wkleic migracje SQL w Supabase Dashboard > SQL Editor:
- Plik: `supabase/migrations/20260214_02_1_01_multi_folder_sync.sql`
- Dodaje: emails.folder_id (TEXT), sync_jobs.metadata (JSONB)
- Bezpieczne do wielokrotnego uruchomienia (IF NOT EXISTS)

## Next Phase Readiness
- Fundament gotowy dla planu 02.1-02 (sync route adaptation + email-parser folder_id)
- fetchMessagesPage i fetchMessagesSince gotowe do uzycia w sync/process/route.ts
- getExcludedFolderIds gotowy do wywolania na poczatku sync job
- filterExcludedFolders gotowy do filtrowania po kazdym batch fetch
- Brak blockerow

---
*Phase: 02.1-multi-folder-sync*
*Completed: 2026-02-15*
