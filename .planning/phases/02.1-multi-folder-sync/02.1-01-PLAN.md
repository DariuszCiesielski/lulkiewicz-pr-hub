---
phase: 02.1-multi-folder-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260214_02_1_01_multi_folder_sync.sql
  - src/lib/email/graph-folders.ts
  - src/lib/email/email-fetcher.ts
autonomous: true

must_haves:
  truths:
    - "emails tabela ma kolumnę folder_id TEXT"
    - "sync_jobs tabela ma kolumnę metadata JSONB"
    - "getExcludedFolderIds zwraca listę folder ID do wykluczenia"
    - "fetchMessagesPage używa /users/{email}/messages zamiast /mailFolders/inbox/messages"
    - "fetchMessagesSince istnieje i używa $filter=receivedDateTime ge"
    - "MESSAGE_SELECT_FIELDS zawiera parentFolderId"
  artifacts:
    - path: "supabase/migrations/20260214_02_1_01_multi_folder_sync.sql"
      provides: "ALTER TABLE emails + ALTER TABLE sync_jobs"
      contains: "folder_id"
    - path: "src/lib/email/graph-folders.ts"
      provides: "Helper do pobierania excluded folder IDs z Graph API"
      exports: ["getExcludedFolderIds"]
    - path: "src/lib/email/email-fetcher.ts"
      provides: "Zaktualizowany fetcher z endpointami all-folders"
      exports: ["fetchMessagesPage", "fetchMessagesSince", "upsertEmails", "getMailboxMessageCount"]
---

<objective>
Fundament multi-folder sync: migracja DB (nowe kolumny), helper do pobierania excluded folders z Graph API, zmiana endpointów w email-fetcher z /mailFolders/inbox/messages na /messages (all-folders).

Purpose: Sync process route (Plan 02) zależy od nowych endpointów i helper'a. Ten plan tworzy fundament.
Output: Migracja SQL, graph-folders.ts, zaktualizowany email-fetcher.ts.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-multi-folder-sync/02.1-CONTEXT.md
@src/lib/email/email-fetcher.ts
@src/lib/email/graph-auth.ts
@src/lib/email/graph-client.ts
@src/app/api/sync/process/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migracja SQL — nowe kolumny dla multi-folder sync</name>
  <files>supabase/migrations/20260214_02_1_01_multi_folder_sync.sql</files>
  <action>
Utwórz plik migracji SQL:

```sql
-- Phase 2.1: Multi-Folder Sync — nowe kolumny
-- Uwaga: Wklej w Supabase Dashboard > SQL Editor

-- 1. emails: folder_id do przechowywania ID folderu źródłowego
ALTER TABLE emails ADD COLUMN IF NOT EXISTS folder_id TEXT;

-- 2. sync_jobs: metadata do przechowywania konfiguracji sync (excluded folders, etc.)
ALTER TABLE sync_jobs ADD COLUMN IF NOT EXISTS metadata JSONB;
```

Kolumny są nullable — istniejące dane nie wymagają backfill.
  </action>
  <verify>
Plik SQL istnieje, zawiera 2 ALTER TABLE z IF NOT EXISTS. Gotowy do wklejenia w SQL Editor.
  </verify>
  <done>Migracja SQL gotowa z kolumnami folder_id i metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Helper graph-folders.ts — pobieranie excluded folder IDs</name>
  <files>src/lib/email/graph-folders.ts</files>
  <action>
Utwórz nowy plik `src/lib/email/graph-folders.ts`:

```typescript
import type { Client } from '@microsoft/microsoft-graph-client';

/**
 * Well-known folder names to EXCLUDE from sync.
 * - drafts: wersje robocze (nie wysłane)
 * - junkemail: spam
 * - deleteditems: kosz (usunięte maile)
 */
const EXCLUDED_FOLDER_NAMES = ['drafts', 'junkemail', 'deleteditems'];

/**
 * Fetch IDs of mail folders to exclude from sync.
 * Uses Graph API well-known folder names.
 *
 * Returns array of folder IDs (parentFolderId format).
 */
export async function getExcludedFolderIds(
  graphClient: Client,
  emailAddress: string
): Promise<string[]> {
  const excludedIds: string[] = [];

  for (const folderName of EXCLUDED_FOLDER_NAMES) {
    try {
      const folder = await graphClient
        .api(`/users/${emailAddress}/mailFolders/${folderName}`)
        .select('id')
        .get();

      if (folder?.id) {
        excludedIds.push(folder.id);
      }
    } catch {
      // Folder may not exist — skip silently
      console.warn(`Could not fetch folder '${folderName}' for ${emailAddress}`);
    }
  }

  return excludedIds;
}
```

Kluczowe decyzje:
- Używa well-known folder names (Graph API akceptuje nazwy zamiast ID)
- 3 foldery wykluczone: drafts, junkemail, deleteditems
- Graceful error handling — brak folderu nie przerywa sync
- Zwraca ID w formacie parentFolderId (do porównania z msg.parentFolderId)
  </action>
  <verify>
`npx tsc --noEmit` — zero błędów. Plik eksportuje `getExcludedFolderIds`.
  </verify>
  <done>Helper graph-folders.ts gotowy, eksportuje getExcludedFolderIds.</done>
</task>

<task type="auto">
  <name>Task 3: email-fetcher.ts — zmiana endpointów na all-folders</name>
  <files>src/lib/email/email-fetcher.ts</files>
  <action>
Zaktualizuj `src/lib/email/email-fetcher.ts`:

**3a. Dodaj `parentFolderId` do MESSAGE_SELECT_FIELDS:**
```typescript
const MESSAGE_SELECT_FIELDS = [
  'id',
  'subject',
  'from',
  'toRecipients',
  'ccRecipients',
  'sentDateTime',
  'receivedDateTime',
  'body',
  'bodyPreview',
  'internetMessageId',
  'conversationId',
  'hasAttachments',
  'internetMessageHeaders',
  'isRead',
  'parentFolderId',  // NOWE: do identyfikacji folderu źródłowego
].join(',');
```

**3b. Zmień `getMailboxMessageCount` — all-folders count:**
Zmień endpoint z `/users/${emailAddress}/mailFolders/inbox` na:
```typescript
export async function getMailboxMessageCount(
  graphClient: Client,
  emailAddress: string
): Promise<number> {
  // Count across all folders (excluding excluded ones)
  // Uses /messages with $count — simpler than summing per-folder
  const response = await graphClient
    .api(`/users/${emailAddress}/messages`)
    .top(1)
    .select('id')
    .header('ConsistencyLevel', 'eventual')
    .count(true)
    .get();

  return response?.['@odata.count'] ?? 0;
}
```

**3c. Zmień `fetchMessagesPage` — all-folders fetch:**
Zmień pierwszy page URL z `/users/${emailAddress}/mailFolders/inbox/messages` na `/users/${emailAddress}/messages`:
```typescript
response = await graphClient
  .api(`/users/${emailAddress}/messages`)
  .top(100)
  .select(MESSAGE_SELECT_FIELDS)
  .header('Prefer', 'outlook.body-content-type="text"')
  .orderby('receivedDateTime DESC')
  .get();
```
Reszta logiki (nextLink pagination) bez zmian.

**3d. Dodaj nową funkcję `fetchMessagesSince` (zamiennik delta sync):**
```typescript
/**
 * Fetch messages received since a given date (all folders).
 * Used as replacement for delta sync (which is per-folder only).
 *
 * Returns paginated results identical to fetchMessagesPage.
 */
export async function fetchMessagesSince(
  graphClient: Client,
  emailAddress: string,
  sinceDate: string,
  pageUrl: string | null
): Promise<{ messages: any[]; nextLink: string | null }> {
  let response: any;

  if (pageUrl) {
    response = await graphClient.api(pageUrl).get();
  } else {
    // ISO date for OData filter
    const filterDate = new Date(sinceDate).toISOString();
    response = await graphClient
      .api(`/users/${emailAddress}/messages`)
      .top(100)
      .select(MESSAGE_SELECT_FIELDS)
      .header('Prefer', 'outlook.body-content-type="text"')
      .filter(`receivedDateTime ge ${filterDate}`)
      .orderby('receivedDateTime DESC')
      .get();
  }

  return {
    messages: response?.value || [],
    nextLink: response?.['@odata.nextLink'] || null,
  };
}
```

**3e. Dodaj funkcję `filterExcludedFolders`:**
```typescript
/**
 * Filter out messages from excluded folders.
 * Call after fetching a batch from Graph API.
 */
export function filterExcludedFolders(
  messages: any[],
  excludedFolderIds: string[]
): any[] {
  if (excludedFolderIds.length === 0) return messages;
  return messages.filter(
    (msg) => !excludedFolderIds.includes(msg.parentFolderId)
  );
}
```

**3f. ZACHOWAJ istniejącą funkcję `fetchDeltaPage`** — nie usuwaj, ale dodaj komentarz `@deprecated — use fetchMessagesSince instead`.

**3g. ZACHOWAJ istniejące funkcje `upsertEmails`** — bez zmian (obsługa deduplikacji już naprawiona wcześniej).
  </action>
  <verify>
`npx tsc --noEmit` — zero błędów kompilacji.
Sprawdź że:
- MESSAGE_SELECT_FIELDS zawiera 'parentFolderId'
- fetchMessagesPage używa `/users/${emailAddress}/messages` (nie /mailFolders/inbox)
- fetchMessagesSince istnieje i eksportuje się
- filterExcludedFolders istnieje i eksportuje się
- fetchDeltaPage nadal istnieje (z @deprecated)
  </verify>
  <done>email-fetcher.ts zaktualizowany: all-folders endpoints, fetchMessagesSince, filterExcludedFolders. Kompilacja TS bez błędów.</done>
</task>

</tasks>

<verification>
- [ ] Migracja SQL istnieje w supabase/migrations/
- [ ] emails.folder_id (TEXT, nullable)
- [ ] sync_jobs.metadata (JSONB, nullable)
- [ ] graph-folders.ts eksportuje getExcludedFolderIds
- [ ] fetchMessagesPage używa /messages (nie /mailFolders/inbox/messages)
- [ ] fetchMessagesSince istnieje z $filter=receivedDateTime ge
- [ ] filterExcludedFolders istnieje
- [ ] parentFolderId w MESSAGE_SELECT_FIELDS
- [ ] `npx tsc --noEmit` przechodzi bez błędów
</verification>

<success_criteria>
1. Migracja SQL gotowa do wklejenia w Supabase SQL Editor
2. Helper graph-folders.ts pobiera ID folderów do wykluczenia
3. email-fetcher.ts używa endpointów all-folders
4. Nowa funkcja fetchMessagesSince zastępuje delta logikę
5. Kompilacja TypeScript bez błędów
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-multi-folder-sync/02.1-01-SUMMARY.md`
</output>
