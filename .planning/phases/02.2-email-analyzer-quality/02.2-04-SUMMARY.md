# Phase 2.2 Plan 04: UI/UX Polish Summary

**One-liner:** Kontrast WCAG AA dla jasnych motywow, nawigacja raportow, pelny prompt CRUD z reorder/checkboxami, podglad klucza API z odszyfrowania.

---
phase: 02.2
plan: 04
subsystem: email-analyzer-ui
tags: [wcag, accessibility, prompts, crud, api-key, navigation, ux]
requires: [02.2-01, 02.2-02]
provides: [prompt-crud, wcag-contrast, api-key-preview, report-navigation-fix]
affects: []
tech-stack:
  added: []
  patterns: [maskApiKey, prompt-reorder, soft-delete, global-context-prompt]
key-files:
  created:
    - supabase/migrations/20260215_02_2_04_prompt_report_flags.sql
  modified:
    - src/themes/default.ts
    - src/themes/minimal.ts
    - src/themes/corporate.ts
    - src/app/(hub)/email-analyzer/reports/page.tsx
    - src/app/(hub)/email-analyzer/prompts/page.tsx
    - src/app/api/prompts/route.ts
    - src/lib/ai/default-prompts.ts
    - src/app/api/ai-config/route.ts
    - src/app/(hub)/email-analyzer/settings/page.tsx
decisions:
  - "textMuted w jasnych motywach: #64748b (default/corporate), #737373 (minimal) — kontrast >= 4.5:1"
  - "Globalny prompt raportu: section_key='_global_context', section_order=0"
  - "Reset button: zapisuje domyslne wartosci z default-prompts.ts do DB (nie tylko local reset)"
  - "maskApiKey: 6 pierwszych + ... + 4 ostatnie znaki"
  - "Soft delete promptow: is_active=false (nie fizyczne usuwanie)"
  - "Checkboxy in_internal_report/in_client_report per sekcja"
metrics:
  duration: ~6 min
  completed: 2026-02-15
---

## Tasks Completed

| # | Task | Commit | Key Changes |
|---|------|--------|-------------|
| 1 | Kontrast czcionek WCAG AA | 0697333 | 3 jasne motywy: textMuted poprawiony na >= 4.5:1 |
| 2 | Nawigacja po generowaniu raportu | a23305e | Usuniety fetchReports() i state updates po router.push |
| 3 | Prompt CRUD | 4a1a902 | DELETE handler, POST z report flags, reorder, copy, add, global context, reset, SQL migration |
| 4 | Podglad klucza API | 0c99fda | decrypt + maskApiKey w GET /api/ai-config, UI preview |

## Decisions Made

1. **Kontrast WCAG AA** — textMuted w jasnych motywach zmieniony na ciemniejsze wartosci. Default i Corporate: #94a3b8 -> #64748b (4.7:1). Minimal: #a3a3a3 -> #737373 (4.6:1). Ciemne motywy bez zmian.

2. **Nawigacja raportow** — Po wygenerowaniu raportu, router.push() wykonywany natychmiast. Usuniety zbedny fetchReports() i setShowGenerate() przed nawigacja. isGenerating resetowany tylko w catch.

3. **Prompt CRUD** — Pelna edycja sekcji: dodawanie (custom_<timestamp>), kopiowanie (<key>_copy_<timestamp>), usuwanie (soft delete), zmiana kolejnosci (swap section_order). Domyslne sekcje nie moga byc usuwane (tylko custom).

4. **Globalny prompt kontekstu** — Nowa sekcja _global_context (section_order=0) z kontekstem dla calego raportu. Edytowalny jak inne sekcje.

5. **Checkboxy raportow** — Kazda sekcja ma checkboxy "Raport wewnetrzny" / "Raport kliencki". Dane w kolumnach in_internal_report/in_client_report w DB.

6. **{{threads}} ukryty** — Zamiast placeholdera, informacja: "Tresc watkow email zostanie automatycznie dolaczona do promptu".

7. **Reset promptu** — Przywraca tresc z default-prompts.ts i zapisuje do DB (nie tylko lokalny reset).

8. **Podglad klucza API** — Deszyfrowanie AES-256-GCM + maskowanie (6+...+4). api_key_encrypted nigdy nie opuszcza serwera.

## Parallel Execution Note

Plan 02.2-03 (Synthetic Reports) dzialal rownolegle i modyfikowal reports/page.tsx. Zmiany z obu planow sa kompatybilne — Task 2 (nawigacja) dotyczy handleGenerate, a 02.2-03 dotyczy formularza generowania i detailLevel. Brak konfliktow.

## SQL Migration

Plik: `supabase/migrations/20260215_02_2_04_prompt_report_flags.sql`

Dodaje kolumny:
- `in_internal_report BOOLEAN DEFAULT true`
- `in_client_report BOOLEAN DEFAULT false`

User musi wkleic w Supabase SQL Editor.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Usunieto nieuzywany interface AnalysisJob**
- **Found during:** Task 2
- **Issue:** Interface AnalysisJob zdefiniowany ale nigdy nie uzywany w reports/page.tsx
- **Fix:** Usunieto martwy kod
- **Files modified:** src/app/(hub)/email-analyzer/reports/page.tsx
- **Commit:** a23305e

## Next Phase Readiness

Phase 2.2 jest teraz kompletna (4/4 planow). Gotowe do:
- Wklejenia SQL migracji (plan 04) w Supabase SQL Editor
- Wdrozenia na Vercel (git push)
- Przejscia do Phase 9 (FB Scraping Engine)
