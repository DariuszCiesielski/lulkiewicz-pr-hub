---
phase: 02.2
plan: 03
subsystem: email-analyzer-reports
tags: [ai-synthesis, reduce-phase, docx-export, report-formatting]

dependency-graph:
  requires: [02.2-01, 02.2-02]
  provides: [synthetic-report-generation, report-formatting, docx-unique-names]
  affects: [02.2-04]

tech-stack:
  added: []
  patterns: [two-level-ai-synthesis, promise-allsettled-parallel, anchor-navigation]

key-files:
  created:
    - src/lib/ai/report-synthesizer.ts
  modified:
    - src/app/api/reports/route.ts
    - src/app/(hub)/email-analyzer/reports/page.tsx
    - src/app/(hub)/email-analyzer/reports/[id]/page.tsx
    - src/lib/export/export-report-docx.ts

decisions:
  - "Single-pass synthesis for <=100 threads, two-level (batch 30 + meta) for >100"
  - "Promise.allSettled for parallel section synthesis (Vercel 60s timeout)"
  - "Fallback to raw data if AI synthesis fails for a section"
  - "Table of Contents collapsible by default, anchor links with smooth scroll"
  - "DOCX filename: Raport_typ_skrzynka_daty.docx with Polish chars preserved"
  - "Global report prompt via report_global key in prompt_templates"

metrics:
  duration: ~7 min
  completed: 2026-02-15
---

# Phase 2.2 Plan 03: Synthetic Reports Summary

**One-liner:** AI REDUCE faza — synteza per-sekcja z two-level batching, spis tresci z anchor links, unikalne nazwy DOCX

## What Was Done

### Task 1: report-synthesizer.ts (427b15e)
Utworzono nowy modul `src/lib/ai/report-synthesizer.ts`:
- `SYNTHESIS_SYSTEM_PROMPT` — profesjonalny jezyk PL, 1-3 strony per sekcja, kluczowe wnioski z referencjami do watkow
- `synthesizeReportSection()` — glowna funkcja syntezy
- Tryb single-pass (<=100 watkow): formatuje wyniki per-watek, wysyla 1 request AI
- Tryb two-level (>100 watkow): batch po 30 → synteza per batch → meta-synteza lacząca grupy
- Truncation guard: max 100k chars per request (overflow protection)
- Helper: `synthesizeWithConfig()` convenience wrapper z auto-load AI config

### Task 2: POST /api/reports — faza REDUCE (36c5b09)
Rozbudowano `src/app/api/reports/route.ts`:
- Nowy parametr `detailLevel`: `'synthetic'` (default) / `'detailed'`
- Synthetic: laduje AI config, uruchamia `synthesizeReportSection` per sekcja rownolegle (Promise.allSettled)
- Detailed: oryginalna logika thread-by-thread z dodanymi tematami watkow
- Globalny prompt raportu (`report_global` w `prompt_templates`) przekazywany jako kontekst do kazdej syntezy
- `includeThreadSummaries` param (opcjonalny, na przyszlosc)
- Fallback: jesli synteza sekcji fail → surowe dane z adnotacja "(synteza nieudana)"
- `maxDuration=60` dla Vercel Edge
- Tytul zawiera typ szczegolowosci + liczbe watkow

### Task 3: reports/page.tsx — dropdown (ecc1517)
Rozbudowano strone listy raportow:
- Grid 3 kolumny: skrzynka, szablon, **poziom szczegolowosci**
- Dropdown: "Syntetyczny (~5-15 stron)" / "Szczegolowy (watek po watku)"
- Komunikat ladowania z animowanym spinner (Loader2): "AI syntetyzuje wyniki analizy..."
- `detailLevel` przekazywany do POST /api/reports

### Task 4: reports/[id]/page.tsx — formatowanie (0d56339)
Przebudowano podglad raportu:
- **Spis tresci (Table of Contents)**: zwijalna nav z numerowana lista sekcji
- **Anchor links**: klikniecie w TOC → smooth scroll do sekcji (`id="section-{key}"`)
- **Numeracja sekcji**: "1. Podsumowanie ogolne", "2. Jakosc komunikacji", etc.
- **Separatory wizualne**: delikatna linia (border-top) miedzy sekcjami
- **Metadane w headerze**: data utworzenia, zakres dat (badge), typ raportu (badge)
- **CSS formatting**: `.report-content` style — naglowki h1-h3, tabele, blockquote, code, listy
- **Sortowanie sekcji**: useMemo po section_order (stabilne)

### Task 5: export-report-docx.ts — nazwy (51646c3)
Ulepszone nazwy plikow DOCX:
- `generateDocxFilename()`: `Raport_wewnetrzny_JanKowalski_2026-01-01_2026-02-15.docx`
- `sanitizeForFilename()`: polskie znaki zachowane, special chars usuniete
- Fallback na `created_at` jesli brak zakresu dat
- Limit 80 znakow w segmencie nazwy

## Decisions Made

| Decision | Context | Reasoning |
|----------|---------|-----------|
| Two-level synthesis threshold = 100 | Wielu userow moze miec >100 watkow | Single-pass do 100 → szybciej; >100 → batch 30 + meta |
| Promise.allSettled (nie Promise.all) | Vercel 60s timeout | Jesli 1 sekcja fail, reszta nadal dziala |
| report_global w prompt_templates | Globalny kontekst raportu | Reuse istniejacego systemu prompt_templates |
| CSS via styled-jsx global | Formatowanie markdown w przegladarce | Scope do komponentu, CSS variables kompatybilne |
| sanitizeForFilename z polskimi znakami | User oczekuje czytelnych nazw | Polskie znaki w nazwach plikow sa OK na Windows/Mac |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] template_type w ReportMeta interface**
- **Found during:** Task 5
- **Issue:** Interface `ReportMeta` nie mial pola `template_type`, potrzebne do generowania nazwy pliku
- **Fix:** Dodano `template_type?: string` do interface
- **Files modified:** src/lib/export/export-report-docx.ts

**2. [Rule 2 - Missing Critical] Detailed mode — tematy watkow w naglowkach**
- **Found during:** Task 2
- **Issue:** Oryginalna logika detailed wstawiala "Watek 1", "Watek 2" bez tematow — bezuzyteczne w dlugim raporcie
- **Fix:** Dodano `threadSubject` do naglowkow: "### Watek 1: Awaria windy"
- **Files modified:** src/app/api/reports/route.ts

## Next Phase Readiness

- **Plan 02.2-04 (UI/UX Polish)** moze kontynuowac natychmiast — brak blockerow
- Synteza wymaga aktywnej konfiguracji AI (klucz API) — jesli brak, zwraca blad 400
- Globalny prompt raportu (report_global) jest opcjonalny — dziala bez niego
