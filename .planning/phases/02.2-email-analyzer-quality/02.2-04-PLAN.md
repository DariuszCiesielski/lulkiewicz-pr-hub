---
phase: 02.2-email-analyzer-quality
plan: 04
type: execute
wave: 2
depends_on: ["02.2-01", "02.2-02"]
files_modified:
  - src/app/globals.css
  - src/app/(hub)/email-analyzer/reports/page.tsx
  - src/app/(hub)/email-analyzer/reports/[id]/page.tsx
  - src/app/(hub)/email-analyzer/settings/page.tsx
  - src/app/(hub)/email-analyzer/prompts/page.tsx
  - src/app/api/prompts/route.ts
autonomous: true

must_haves:
  truths:
    - "Zmienne CSS --text-muted i --text-secondary mają kontrast min. 4.5:1 na jasnych motywach"
    - "Nawigacja po wygenerowaniu raportu: klik Generuj → jedno przekierowanie na podgląd"
    - "Strona promptów pozwala dodawać nowe sekcje, usuwać i kopiować istniejące"
    - "Podgląd klucza API na stronie ustawień działa poprawnie"
    - "Kolejność sekcji promptów jest edytowalna (strzałki góra/dół) i odzwierciedla kolejność w raporcie"
    - "Zmienna {{threads}} jest ukryta — użytkownik widzi informację 'Treść wątków zostanie automatycznie dołączona'"
    - "Każda sekcja ma checkboxy: 'Raport wewnętrzny' / 'Raport kliencki' — użytkownik decyduje co jest w którym raporcie"
    - "Globalny prompt raportu jest edytowalny na stronie promptów"
    - "Przycisk Resetuj przywraca domyślną treść promptu z default-prompts.ts"
  artifacts:
    - path: "src/app/globals.css"
      provides: "Zaktualizowane zmienne CSS z poprawnym kontrastem"
    - path: "src/app/(hub)/email-analyzer/prompts/page.tsx"
      provides: "Strona promptów z pełnym CRUD (add/delete/copy)"
---

<objective>
UI/UX Polish: poprawki kontrastu czcionek (WCAG AA), naprawienie nawigacji po generowaniu raportu, dodanie CRUD operacji do zarządzania promptami (dodaj/usuń/kopiuj sekcje), naprawienie podglądu klucza API.

Purpose: Aplikacja spełnia standardy dostępności, nawigacja jest płynna, prompty w pełni zarządzalne.
Output: Poprawione CSS, naprawiona nawigacja, CRUD promptów, podgląd klucza.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-email-analyzer-quality/02.2-CONTEXT.md
@src/app/globals.css
@src/app/(hub)/email-analyzer/prompts/page.tsx
@src/app/(hub)/email-analyzer/settings/page.tsx
@src/app/(hub)/email-analyzer/reports/page.tsx
@src/app/api/prompts/route.ts
@src/app/api/ai-config/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kontrast czcionek — poprawki CSS dla jasnych motywów</name>
  <files>src/app/globals.css</files>
  <action>
Sprawdź i popraw kontrast zmiennych CSS w jasnych motywach.

**1a. Zidentyfikuj motyw(y) jasne:**
Znajdź w globals.css definicje motywów (np. `[data-theme="glass"]`, `[data-theme="light"]`).

**1b. Popraw zmienne --text-muted i --text-secondary:**
Obecne wartości mogą mieć za niski kontrast na białym tle. Docelowe minimum:
- `--text-muted`: kontrast >= 4.5:1 na `--bg-primary` (WCAG AA dla tekstu normalnego)
- `--text-secondary`: kontrast >= 4.5:1 na `--bg-primary`

Typowe poprawki:
- Jeśli --text-muted to np. `rgba(0,0,0,0.3)` → zmień na `rgba(0,0,0,0.55)` lub `#737373`
- Jeśli --text-secondary to np. `rgba(0,0,0,0.5)` → zmień na `rgba(0,0,0,0.65)` lub `#525252`

**1c. NIE zmieniaj ciemnych motywów** — tam kontrast jest zwykle OK.

**1d. Narzędzie do weryfikacji kontrastu:**
Użyj formuły: kontrast = (L1 + 0.05) / (L2 + 0.05) >= 4.5
Lub odwołaj się do znanych wartości: na białym tle (#fff) minimum to ~#767676 (4.54:1).
  </action>
  <verify>
Dla każdego jasnego motywu: --text-muted i --text-secondary mają kontrast >= 4.5:1 na --bg-primary.
Wizualnie: tekst jest czytelny bez wysiłku.
  </verify>
  <done>Kontrast czcionek poprawiony we wszystkich jasnych motywach — WCAG AA compliant.</done>
</task>

<task type="auto">
  <name>Task 2: Naprawienie nawigacji po generowaniu raportu</name>
  <files>src/app/(hub)/email-analyzer/reports/page.tsx</files>
  <action>
**Problem:** Po kliknięciu "Generuj" strona przeskakuje między stronami chaotycznie.

**2a. Zidentyfikuj przyczynę przeskoków:**
Prawdopodobne problemy:
- `fetchReports()` jest wywoływany po `router.push()` — powoduje re-render
- Podwójne wywołanie `router.push`
- State update po nawigacji

**2b. Napraw handleGenerate:**
```typescript
const handleGenerate = async () => {
  if (!selectedMailboxId) return;
  setIsGenerating(true);
  setError(null);

  try {
    const res = await fetch('/api/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mailboxId: selectedMailboxId, templateType, detailLevel }),
    });

    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.error || 'Błąd generowania raportu');
    }

    const data = await res.json();
    // JEDYNE przekierowanie — od razu na podgląd raportu
    router.push(`/email-analyzer/reports/${data.reportId}`);
    // NIE wywołuj fetchReports() ani setShowGenerate() — strona się zmieni
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Błąd');
    setIsGenerating(false); // Reset tylko przy błędzie
  }
};
```

Kluczowe: usunąć wszelkie state updates po `router.push()` — po nawigacji nie potrzebujemy aktualizować starego komponentu.
  </action>
  <verify>
Scenariusz: Klik "Generuj" → strona ładuje → jedno przekierowanie na /reports/[id] → bez przeskoków.
  </verify>
  <done>Nawigacja po generowaniu: jedno płynne przekierowanie na podgląd raportu.</done>
</task>

<task type="auto">
  <name>Task 3: Prompt CRUD — dodawanie, usuwanie, kopiowanie sekcji</name>
  <files>
    src/app/(hub)/email-analyzer/prompts/page.tsx
    src/app/api/prompts/route.ts
  </files>
  <action>
**3a. API — rozszerz endpointy promptów:**

Dodaj do POST /api/prompts obsługę nowych operacji:
- `action: 'create'` — tworzenie nowej sekcji promptu
- `action: 'delete'` — usunięcie sekcji (soft delete: is_active = false)
- `action: 'duplicate'` — kopiowanie sekcji z nowym section_key

Jeśli POST obsługuje tylko update, dodaj odpowiednie handlery.

Dodaj DELETE handler jeśli nie istnieje:
```typescript
export async function DELETE(request: NextRequest) {
  if (!(await verifyAdmin())) return NextResponse.json({ error: 'Brak uprawnień' }, { status: 403 });
  const { id } = await request.json();
  const adminClient = getAdminClient();
  await adminClient.from('prompt_templates').update({ is_active: false }).eq('id', id);
  return NextResponse.json({ success: true });
}
```

**3b. UI — dodaj przyciski do każdej sekcji promptu:**

Przy każdej sekcji promptu dodaj dropdown menu lub przyciski:
- **Kopiuj** (ikona Copy) — duplikuje sekcję z prefiksem "Kopia — " w nazwie
- **Usuń** (ikona Trash) — z potwierdzeniem "Czy na pewno chcesz usunąć tę sekcję?"
- **Góra/Dół** (ikony ChevronUp/ChevronDown) — zmiana kolejności sekcji

**3c. Przycisk "Dodaj sekcję" na górze:**
```tsx
<button onClick={() => setShowAddForm(true)}>
  <Plus className="h-4 w-4" /> Dodaj sekcję
</button>
```

Formularz dodawania:
- Nazwa sekcji (section_key)
- Tytuł (title)
- System prompt
- User prompt template
- Kolejność (section_order)

**3d. Checkboxy typu raportu per sekcja:**
Przy każdej sekcji dodaj 2 checkboxy:
```tsx
<label><input type="checkbox" checked={section.in_internal_report} /> Raport wewnętrzny</label>
<label><input type="checkbox" checked={section.in_client_report} /> Raport kliencki</label>
```
To zastępuje hardcoded CLIENT_REPORT_SECTIONS — użytkownik sam konfiguruje, które sekcje trafiają do którego raportu.

Wymaga dodania kolumn do prompt_templates:
```sql
ALTER TABLE prompt_templates ADD COLUMN IF NOT EXISTS in_internal_report BOOLEAN DEFAULT true;
ALTER TABLE prompt_templates ADD COLUMN IF NOT EXISTS in_client_report BOOLEAN DEFAULT false;
```
Domyślne wartości: in_internal_report = true dla wszystkich, in_client_report = true tylko dla 4 sekcji (summary, communication_quality, response_time, recommendations).

**3e. Ukrycie zmiennej {{threads}}:**
W edytorze prompta, zamiast wyświetlać surowy template z `{{threads}}`, pokaż:
- Pole edycji user promptu BEZ zmiennej {{threads}}
- Pod polem informacja: "ℹ️ Treść analizowanych wątków zostanie automatycznie dołączona do tego promptu."
- Przy zapisie: automatycznie dodaj {{threads}} na końcu user_prompt_template jeśli nie ma

**3f. Globalny prompt raportu:**
Na górze strony promptów dodaj edytowalną sekcję "Kontekst raportu":
```tsx
<div className="mb-6 p-4 rounded-lg border">
  <h3>Kontekst raportu (globalny)</h3>
  <p className="text-sm text-muted">Ten tekst zostanie dołączony do każdego zapytania AI jako kontekst.</p>
  <textarea value={globalContext} onChange={...} placeholder="np. Raport dotyczy administracji osiedla Parkowe, klientem jest deweloper ABC Sp. z o.o." />
</div>
```
Zapisywany w prompt_templates z section_key = '_global_context', tier = 'global'.

**3g. Naprawienie przycisku "Resetuj":**
Problem: przycisk resetowania promptu do domyślnej wersji nie działa.

Zidentyfikuj przyczynę:
- Sprawdź czy `default-prompts.ts` jest importowany i dostępny w prompt editor
- Sprawdź czy API obsługuje reset (DELETE override z bazy → fallback na default z kodu)
- Sprawdź czy po resecie UI odświeża się

Poprawka — reset powinien:
1. Usunąć nadpisanie z tabeli `prompt_templates` (tier='global' dla danej sekcji)
2. Frontend ponownie załadować domyślną wartość z `DEFAULT_PROMPTS`
3. Wyświetlić potwierdzenie "Przywrócono domyślną treść"

Alternatywnie, jeśli reset tylko zeruje formularz (nie kasuje z DB):
```typescript
const handleReset = (sectionKey: string) => {
  const defaultPrompt = DEFAULT_PROMPTS.find(p => p.section_key === sectionKey);
  if (defaultPrompt) {
    setSystemPrompt(defaultPrompt.system_prompt);
    setUserPrompt(defaultPrompt.user_prompt_template);
  }
};
```
WAŻNE: Po resecie trzeba też zapisać (wywołać API), nie tylko zmienić stan lokalny.
  </action>
  <verify>
Scenariusz: Dodaj nową sekcję → pojawia się na liście.
Scenariusz: Kopiuj sekcję → "Kopia — [nazwa]" pojawia się z tym samym promptem.
Scenariusz: Usuń sekcję → znika z listy (soft delete).
  </verify>
  <done>Prompty z pełnym CRUD: dodaj, kopiuj, usuń sekcje.</done>
</task>

<task type="auto">
  <name>Task 4: Podgląd klucza API — naprawienie odszyfrowania</name>
  <files>src/app/(hub)/email-analyzer/settings/page.tsx</files>
  <action>
**4a. Zidentyfikuj problem:**
Sprawdź jak działa podgląd klucza API. Prawdopodobne problemy:
- API nie zwraca odszyfrowanego klucza (security — prawidłowo)
- Frontend próbuje wyświetlić zaszyfrowany klucz
- Brak endpointu do podglądu

**4b. Napraw podgląd:**
Zamiast pełnego odszyfrowania, wyświetl zamaskowaną wersję:
- Pierwsze 4 znaki + "..." + ostatnie 4 znaki (np. "sk-p...xK4f")
- API powinien zwracać `api_key_preview` (pierwsze/ostatnie znaki) w GET /api/ai-config

Sprawdź GET /api/ai-config — jeśli nie zwraca preview:
```typescript
// W GET handler
const preview = decryptedKey
  ? `${decryptedKey.substring(0, 6)}...${decryptedKey.substring(decryptedKey.length - 4)}`
  : null;

return NextResponse.json({
  ...config,
  api_key_preview: preview,
  api_key_encrypted: undefined, // NIE zwracaj zaszyfrowanego klucza
});
```

**4c. W UI wyświetl preview:**
```tsx
{config.api_key_preview ? (
  <span className="font-mono text-sm">{config.api_key_preview}</span>
) : (
  <span className="text-sm text-muted">Nie skonfigurowano</span>
)}
```
  </action>
  <verify>Strona ustawień wyświetla zamaskowany podgląd klucza API (np. "sk-pr...xK4f").</verify>
  <done>Podgląd klucza API naprawiony — wyświetla zamaskowaną wersję.</done>
</task>

</tasks>

<verification>
- [ ] Jasne motywy: --text-muted i --text-secondary mają kontrast >= 4.5:1
- [ ] Generowanie raportu: jedno płynne przekierowanie na podgląd (bez przeskoków)
- [ ] Strona promptów: przycisk "Dodaj sekcję" działa
- [ ] Strona promptów: przycisk "Kopiuj" duplikuje sekcję
- [ ] Strona promptów: przycisk "Usuń" z potwierdzeniem soft-deletuje sekcję
- [ ] Strona promptów: strzałki góra/dół zmieniają kolejność sekcji
- [ ] Strona promptów: checkboxy "Raport wewnętrzny" / "Raport kliencki" per sekcja
- [ ] Strona promptów: zmienna {{threads}} ukryta, info "treść dołączona automatycznie"
- [ ] Strona promptów: globalny prompt raportu edytowalny na górze strony
- [ ] Strona ustawień: podgląd klucza API wyświetla zamaskowaną wersję
- [ ] Migracja SQL: prompt_templates ma kolumny in_internal_report, in_client_report
- [ ] Strona promptów: przycisk "Resetuj" przywraca domyślną treść i zapisuje do DB
- [ ] `npx tsc --noEmit` przechodzi bez błędów
</verification>

<success_criteria>
1. Tekst czytelny na jasnych motywach (WCAG AA compliant)
2. Nawigacja płynna — bez chaotycznych przeskoków
3. Prompty w pełni zarządzalne (dodaj/kopiuj/usuń/zmień kolejność)
4. Użytkownik sam konfiguruje które sekcje są w raporcie wewnętrznym/klienckim
5. Zmienna {{threads}} nie myli użytkownika — ukryta za przyjaznym UI
6. Globalny kontekst raportu edytowalny
7. Podgląd klucza API działa
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-email-analyzer-quality/02.2-04-SUMMARY.md`
</output>
