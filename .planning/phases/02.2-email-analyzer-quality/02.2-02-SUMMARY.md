---
phase: 02.2-email-analyzer-quality
plan: 02
subsystem: email-analyzer-ui
tags: [analysis, ux, date-presets, progress, eta, sound, history]
dependency-graph:
  requires: [02.2-01]
  provides: [date-presets, analysis-progress, analysis-history-api, eta-calculation]
  affects: [02.2-03, 02.2-04]
tech-stack:
  added: []
  patterns: [web-audio-api-beep, eta-from-processing-rate, component-extraction]
key-files:
  created:
    - src/components/analysis/DatePresets.tsx
    - src/components/analysis/AnalysisProgress.tsx
  modified:
    - src/hooks/useAnalysisJob.ts
    - src/app/(hub)/email-analyzer/analyze/page.tsx
    - src/app/api/analysis/route.ts
decisions:
  - "Web Audio API (oscillator) dla sygnału dźwiękowego zamiast base64 audio — mniejszy bundle, brak zewnętrznych plików"
  - "ETA obliczane w komponencie AnalysisProgress z props startedAt — czysty podział odpowiedzialności"
  - "Historia analiz jako sekcja na stronie analizy (nie osobna strona) — prostszy UX"
  - "GET /api/analysis dodany do istniejącego route.ts obok POST — RESTful konwencja"
metrics:
  duration: ~6 min
  completed: 2026-02-15
---

# Phase 2.2 Plan 02: Analysis UX Improvements Summary

Szybkie filtry dat (4 presety), spinner z ETA, opcjonalny dźwięk zakończenia, historia analiz z GET /api/analysis endpoint.

## Completed Tasks

| # | Task | Commit | Key Files |
|---|------|--------|-----------|
| 1 | DatePresets — przyciski szybkiego wyboru zakresu dat | 27cb22b | src/components/analysis/DatePresets.tsx |
| 2 | AnalysisProgress — spinner, ETA, dźwięk | b7b9d60 | src/components/analysis/AnalysisProgress.tsx |
| 3 | useAnalysisJob — startedAt timestamp dla ETA | d4659db | src/hooks/useAnalysisJob.ts |
| 4 | Integracja DatePresets, AnalysisProgress, historia analiz | 2bd0bcc | analyze/page.tsx, api/analysis/route.ts |

## What Was Built

### DatePresets (Task 1)
Komponent z 4 przyciskami szybkiego wyboru zakresu dat:
- **Ostatni miesiąc** — pełny poprzedni miesiąc kalendarzowy (np. 1-31 stycznia)
- **Ostatnie 3 miesiące** — 3 pełne poprzednie miesiące kalendarzowe
- **Ostatnie 30 dni** — od dzisiaj minus 30 dni do dzisiaj
- **Ostatnie 90 dni** — od dzisiaj minus 90 dni do dzisiaj

Kliknięcie wypełnia pola Od/Do odpowiednimi datami w formacie YYYY-MM-DD.

### AnalysisProgress (Task 2)
Wydzielony komponent postępu analizy zastępujący inline progress z page.tsx:
- **Spinner**: Lucide `Loader2` z `animate-spin` podczas przetwarzania
- **ETA**: Obliczanie szacowanego czasu na podstawie `(elapsed / processed) * remaining`
- **Komunikat**: "Możesz opuścić stronę" po >= 3 przetworzonych wątkach
- **Dźwięk**: Checkbox "Powiadom dźwiękiem po zakończeniu" (domyślnie: odznaczony) + Web Audio API (2x beep 800Hz)
- **Podsumowanie**: "Przeanalizowano X wątków w Y minut" + przyciski "Zobacz raporty" / "Nowa analiza"
- Ikony statusu: CheckCircle (completed), AlertCircle (error), Loader2 (running)

### useAnalysisJob rozszerzenie (Task 3)
- Dodano `startedAt: Date | null` state ustawiany przy przejściu na status 'processing'
- Resetowany w `startAnalysis()` i `reset()`
- Zwracany w obiekcie hooka do użycia przez AnalysisProgress

### Integracja + Historia analiz (Task 4)
- DatePresets pod polami dat w formularzu
- Inline progress zastąpiony `<AnalysisProgress />`
- Nowa sekcja "Historia analiz" z listą ostatnich 10 zadań per skrzynka
- **GET /api/analysis** — nowy endpoint (query: `?mailboxId=uuid`)
- Historia odświeżana automatycznie po zakończeniu analizy
- Zachowana persystencja wyboru skrzynki z planu 02.2-01

## Decisions Made

1. **Web Audio API oscillator** zamiast base64-encoded audio — generuje 2 krótkie beepy (800Hz, 0.15s) bez zewnętrznych plików, mniejszy bundle, graceful degradation (catch ignoruje błędy autoplay)
2. **ETA w komponencie** a nie w hooku — hook zwraca `startedAt`, komponent oblicza ETA. Czysty podział: hook = dane, komponent = prezentacja
3. **Historia inline** na stronie analizy — nie jako osobna strona. Prostszy UX, widoczna od razu obok formularza
4. **GET handler w istniejącym route.ts** — RESTful: GET /api/analysis (list) + POST /api/analysis (create)
5. **Polskie znaki diakrytyczne** we wszystkich nowych komponentach (zgodnie z konwencją z planu 02.1-03)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Polskie znaki diakrytyczne**
- **Found during:** Task 2
- **Issue:** Początkowy draft AnalysisProgress miał ASCII-only polskie teksty (np. "niz" zamiast "niż", "watkow" zamiast "wątków")
- **Fix:** Poprawione 9 stringów z polskimi znakami diakrytycznymi
- **Files modified:** src/components/analysis/AnalysisProgress.tsx
- **Commit:** b7b9d60

**2. [Rule 3 - Blocking] Plan 02.2-01 zmienił analyze/page.tsx**
- **Found during:** Task 4
- **Issue:** Plik analyze/page.tsx został zmodyfikowany przez plan 02.2-01 (Wave 1, ta sama faza) — dodano localStorage persystencję wyboru skrzynki
- **Fix:** Zachowano zmiany z 02.2-01 (localStorage) w nowej wersji pliku
- **Impact:** Brak — zmiany kompatybilne

## Verification

- [x] 4 przyciski presetów dat: Ostatni miesiąc, Ostatnie 3 miesiące, Ostatnie 30 dni, Ostatnie 90 dni
- [x] Kliknięcie presetu wypełnia pola Od/Do poprawnymi datami
- [x] Spinner/animacja widoczna podczas przetwarzania (Loader2 animate-spin)
- [x] ETA wyświetlane: "Szacowany czas: ~X min"
- [x] Komunikat "możesz opuścić stronę" po kilku przetworzonych wątkach (>= 3)
- [x] Checkbox "Powiadom dźwiękiem" z Web Audio API beep
- [x] Historia analiz wyświetla się pod formularzem (ostatnie 10 per skrzynka)
- [x] GET /api/analysis zwraca listę zadań
- [x] `npx tsc --noEmit` przechodzi bez błędów

## Next Phase Readiness

Plan 02.2-02 ukończony. Gotowe do:
- Plan 02.2-03 (Wave 2): Synthetic Reports — REDUCE z AI syntezą
- Plan 02.2-04 (Wave 2): UI/UX Polish — kontrast, nawigacja, prompt CRUD
