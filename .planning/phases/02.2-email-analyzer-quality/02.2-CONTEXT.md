# Phase 2.2: Email Analyzer Quality — INSERTED

## Cel fazy

Poprawa jakości i użyteczności Email Analyzer na podstawie testów produkcyjnych (48 wątków, 1 skrzynka).
Obecny stan: pipeline działa end-to-end (sync → thread → analyze → report), ale raport jest bezużytecznie obszerny (439 stron wewnętrzny, 281 stron kliencki), brak inteligentnych podsumowań wątków, UX analizy wymaga poprawy.

## Dlaczego INSERTED (nie Phase 9)

- Problemy wykryte podczas pierwszego pełnego testu produkcyjnego Email Analyzer
- Raport 439 stron jest krytycznym blokerem użyteczności — musi być syntetyczny (~5-15 stron)
- Poprawki dotyczą istniejących faz 3-6 (Threading, Analysis, Reports, Dashboard), stąd numer 2.2
- Blokuje wdrożenie do użytkowników końcowych

## Zebrane uwagi z testów produkcyjnych

### Wątki (strona /email-analyzer/threads)

1. **Brak statusu "zamknięty"** — żaden wątek nie ma statusu zamkniętego. Powinien być "zamknięty" jeśli wątek zakończył się (pozytywnie lub negatywnie dla mieszkańców).
2. **Brak opisu wątku** — każdy wątek powinien mieć krótki opis (1-2 zdania): czego dotyczy + jak się zakończył lub na czym się zatrzymał.
3. **Brak zapamiętywania skrzynki** — po opuszczeniu strony i powrocie zawsze pokazuje pierwszą skrzynkę z listy. Powinno pamiętać ostatnio wybraną (dotyczy też stron analizy i raportów).

### Analiza AI (strona /email-analyzer/analyze)

4. **Brak szybkich filtrów dat** — dodać przyciski: ostatni miesiąc kalendarzowy, ostatnie 3 miesiące kalendarzowe, ostatnie 30 dni, ostatnie 90 dni. Kliknięcie wypełnia pola Od/Do.
5. **Niejasna liczba wątków** — przy wybranym zakresie 1 miesiąca znalazło 48 wątków. Filtrowanie używa `first_message_at >= Od` AND `last_message_at <= Do`, co może być nieintuicyjne.
6. **Brak spinnera** — przy wolnym przetwarzaniu (~40s/wątek) użytkownik nie ma pewności czy proces działa. Potrzebna animacja ładowania.
7. **Brak szacowanego czasu** — przy 48 wątkach = ~30 min. Użytkownik powinien widzieć ETA i komunikat "możesz iść na kawę".
8. **Brak sygnału dźwiękowego** — opcjonalny dźwięk po zakończeniu analizy (checkbox).
9. **Brak historii analiz** — po opuszczeniu strony analiza "znika". Potrzebna lista ukończonych/trwających zadań analizy.

### Raporty (strona /email-analyzer/reports)

10. **KRYTYCZNE: Raport absurdalnie obszerny** — raport wewnętrzny 439 stron, kliencki 281 stron (czcionka 9). Obecna faza REDUCE po prostu skleja analizy wątek po wątku. Potrzebny raport SYNTETYCZNY (~5-15 stron).
11. **Brak syntezy** — raport powinien agregować wnioski z wielu wątków, wskazywać trendy, problemy, ze wskazaniem konkretnych wątków jako przykładów.
12. **Słabe formatowanie** — tekst trudny do czytania, brak wyraźnych nagłówków, separatorów, spisu treści.
13. **Identyczne nazwy DOCX** — eksport wewnętrzny i kliencki tworzą plik z tą samą nazwą. Nazwa powinna zawierać: typ, skrzynkę, daty.
14. **Chaotyczna nawigacja** — po wygenerowaniu raportu przeskakuje między stronami (raport → podgląd → lista). Powinno: klik Generuj → od razu podgląd.

### Ustawienia i prompty

15. **Podgląd klucza API nie działa** — na stronie ustawień AI klucz jest oznaczony jako skonfigurowany, ale podgląd (odszyfrowanie) nie działa.
16. **Brak CRUD sekcji promptów** — brak możliwości dodawania nowych sekcji, usuwania istniejących, kopiowania (duplikowania) sekcji.

### UI ogólne

17. **Słaby kontrast czcionek** — jasno-szare teksty na białym tle są słabo widoczne w jasnych motywach. Elementy aktywne muszą mieć kontrast min. WCAG AA (4.5:1).

### Raporty — skalowalność i przechowywanie

18. **Raporty z długich okresów** — mogą być generowane z kwartału, pół roku, roku lub całej skrzynki (tysiące wątków). Synteza AI musi skalować się — raport syntetyczny zawsze ~5-15 stron niezależnie od liczby wątków. Strategie: grupowanie wątków w batche → synteza per batch → meta-synteza.
19. **Przechowywanie raportów** — raporty muszą być trwale przechowywane, tak żeby można było do nich wrócić. (Obecna architektura to obsługuje — reports + report_sections w DB — ale trzeba zadbać o łatwy dostęp i historię.)

### Zarządzanie promptami — rozszerzenia

20. **Kolejność sekcji** — możliwość zmiany kolejności sekcji (drag & drop lub strzałki góra/dół). Kolejność promptów = kolejność sekcji w raporcie.
21. **Opisy wątków opcjonalne** — dołączanie opisów (summary) wątków do raportu powinno być opcjonalne (checkbox, domyślnie zaznaczony).
22. **Globalny prompt raportu** — oprócz promptów per sekcja, powinien być globalny prompt opisujący kontekst całego raportu (np. "Ten raport dotyczy administracji osiedla X, klientem jest deweloper Y"). Przekazywany jako kontekst do każdego zapytania AI.
23. **Ukrycie zmiennej {{threads}}** — zmienna `{{threads}}` w promptach jest myląca dla użytkownika nietechnicznego. Powinna być ukryta lub zastąpiona przyjaznym opisem (np. info "Treść wątków zostanie automatycznie dołączona").
24. **Przypisanie sekcji do typu raportu** — checkboxy przy każdej sekcji: "Raport wewnętrzny" / "Raport kliencki". Użytkownik sam decyduje, które sekcje są w którym raporcie (zamiast hardcoded listy CLIENT_REPORT_SECTIONS).

### Zarządzanie promptami — bugi

25. **Przycisk "Resetuj" nie działa** — po edycji promptu (np. usunięciu linijki z user promptu) przycisk resetowania do domyślnej treści nie przywraca oryginalnej wersji. Użytkownik traci możliwość odwrócenia zmian.

### Do rozważenia w przyszłości (poza scopem 2.2)

26. **Background processing** — przy 1600 wątkach (~16h) analiza musi działać server-side (job queue, kontynuacja po wylogowaniu, powiadomienia mailowe). Wymaga zmiany architektury — osobna faza.

## Kontekst techniczny

### Obecna architektura raportu (problem)

```
MAP phase:  48 wątków × 7 sekcji = 336 zapytań AI → analysis_results (336 rekordów)
REDUCE phase: GROUP BY section_key → sklej wątek po wątku → report_sections (7 rekordów, każdy ~60 stron)
```

Faza REDUCE nie redukuje — po prostu łączy wyniki z nagłówkami "Wątek 1", "Wątek 2"...

### Docelowa architektura raportu

```
MAP phase:  48 wątków × 7 sekcji = 336 zapytań AI → analysis_results (336 rekordów)  [bez zmian]
REDUCE phase:  AI dostaje wyniki per sekcja → syntetyzuje w 1-2 strony per sekcja → report_sections (7 zwięzłych sekcji)
```

Faza REDUCE wysyła dodatkowe zapytanie AI per sekcja z instrukcją: "Zsyntetyzuj poniższe analizy X wątków w zwięzłe podsumowanie ze wskazaniem kluczowych wątków".

### Obecne pliki do modyfikacji

- `src/lib/threading/thread-builder.ts` — dodanie AI summary i lepszej detekcji statusu
- `src/app/api/analysis/process/route.ts` — spinner, ETA
- `src/app/api/reports/route.ts` — nowa faza REDUCE z AI syntezą
- `src/app/(hub)/email-analyzer/analyze/page.tsx` — filtry dat, spinner, ETA, dźwięk
- `src/app/(hub)/email-analyzer/threads/page.tsx` — zapamiętywanie skrzynki
- `src/app/(hub)/email-analyzer/reports/page.tsx` — nawigacja
- `src/app/(hub)/email-analyzer/reports/[id]/page.tsx` — formatowanie, nazwy DOCX
- `src/app/(hub)/email-analyzer/prompts/page.tsx` — CRUD sekcji
- `src/app/(hub)/email-analyzer/settings/page.tsx` — podgląd klucza API
- `src/lib/export/export-report-docx.ts` — nazwy plików DOCX

## Scope

- 4 plany, 2-3 wave'y
- Plan 01 (Wave 1): Thread Intelligence — AI summary, status, zapamiętywanie skrzynki
- Plan 02 (Wave 1): Analysis UX — filtry dat, spinner, ETA, dźwięk, historia analiz
- Plan 03 (Wave 2): Synthetic Reports — REDUCE z AI syntezą, formatowanie, nazwy DOCX
- Plan 04 (Wave 2): UI/UX Polish — kontrast, nawigacja, prompt CRUD, podgląd klucza API
