---
phase: "02.2"
plan: "01"
subsystem: "email-analyzer-threading"
tags: ["ai-summary", "thread-intelligence", "localStorage", "status-detection"]
dependency-graph:
  requires: ["phase-3", "phase-4"]
  provides: ["thread-ai-summaries", "extended-thread-status", "persisted-mailbox-selection"]
  affects: ["02.2-03"]
tech-stack:
  added: []
  patterns: ["AI summary per thread", "graceful AI fallback", "localStorage persistence"]
key-files:
  created:
    - "supabase/migrations/20260215_02_2_01_thread_intelligence.sql"
  modified:
    - "src/types/email.ts"
    - "src/lib/threading/thread-builder.ts"
    - "src/app/api/threads/build/route.ts"
    - "src/components/threads/ThreadCard.tsx"
    - "src/components/threads/ThreadFilters.tsx"
    - "src/app/(hub)/email-analyzer/threads/page.tsx"
    - "src/app/(hub)/email-analyzer/analyze/page.tsx"
    - "src/app/(hub)/email-analyzer/reports/page.tsx"
decisions:
  - id: "02.2-01-01"
    summary: "AI summary prompt zwraca JSON {summary, status} z instrukcjami PL"
  - id: "02.2-01-02"
    summary: "Batch 5 watkow rownolegle via Promise.allSettled"
  - id: "02.2-01-03"
    summary: "Graceful fallback — brak AI config = puste summary, status z heurystyki"
  - id: "02.2-01-04"
    summary: "localStorage klucz 'ea-selected-mailbox' wspoldzielony miedzy 3 stronami"
metrics:
  duration: "~6 min"
  completed: "2026-02-15"
---

# Phase 2.2 Plan 01: Thread Intelligence Summary

AI summary per watek, rozszerzone statusy (closed_positive/closed_negative), persisted mailbox selection via localStorage.

## Tasks Completed

| # | Task | Commit | Key Changes |
|---|------|--------|-------------|
| 1 | Migracja SQL — kolumna summary | d5cee2a | ALTER TABLE email_threads ADD COLUMN summary TEXT |
| 2 | Typ EmailThread — pole summary | 8ad58e6 | ThreadStatus rozszerzony o closed_positive, closed_negative |
| 3 | thread-builder AI summary | 1e67f83 | AI summary generowanie, batch 5 parallel, graceful fallback |
| 4 | ThreadCard — wyswietlanie summary | 3f2d708 | Summary pod tematem, nowe kolory statusow, ThreadFilters update |
| 5 | Persisted mailbox selection | 4f42b83 | localStorage na threads, analyze, reports z walidacja |

## Key Implementation Details

### AI Summary Generation (thread-builder.ts)
- Po zbudowaniu watkow, generuje AI summary per watek
- Prompt: system PL z instrukcjami dla zarzadcy nieruchomosci
- Input: first + last email body (max 1200 chars each), temat, liczba wiadomosci, kierunek
- Output: JSON {summary: string, status: string} — parsowany z graceful error handling
- Batch: 5 watkow rownolegle via Promise.allSettled
- Fallback: jesli AI nie skonfigurowane, summary = null, status z heurystyki (lastIsIncoming ? pending : open)
- Nowy return type: { threadsCreated, emailsUpdated, summariesGenerated }

### Extended Thread Status
- Stare: open, closed, pending
- Nowe: open, closed_positive, closed_negative, pending (+ zachowano legacy "closed" w UI)
- AI decyduje o statusie na podstawie kontekstu emaili
- ThreadCard: closed_positive = zielony, closed_negative = czerwony
- ThreadFilters: nowe opcje filtrowania

### Persisted Mailbox Selection
- Klucz: `ea-selected-mailbox` w localStorage
- Wspoldzielony miedzy threads, analyze, reports
- Walidacja: sprawdza czy ID istnieje w aktualnej liscie skrzynek
- Fallback: pierwszy na liscie jesli zapisany nie istnieje

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] ThreadFilters nie pokrywal nowych statusow**
- **Found during:** Task 4
- **Issue:** ThreadFilters.tsx mial tylko 3 statusy (pending, open, closed), brak closed_positive/closed_negative
- **Fix:** Dodano 2 nowe opcje do STATUS_OPTIONS
- **Files modified:** src/components/threads/ThreadFilters.tsx
- **Commit:** 3f2d708

## Decisions Made

1. **AI prompt format**: JSON {summary, status} zamiast osobnych callów — 1 API call per watek
2. **Batch size 5**: kompromis miedzy szybkoscia a obciazeniem API (Vercel 60s timeout)
3. **Graceful fallback**: brak AI = brak summary, nie blokuje budowania watkow
4. **Shared localStorage key**: jeden klucz wspoldzielony miedzy stronami — user wybiera raz, pamietane wszedzie

## Next Phase Readiness

- Plan 02.2-03 (Synthetic Reports) moze korzystac z thread.summary do generowania lepszych raportow
- Migracja SQL wymaga wklejenia w Supabase SQL Editor przez usera
