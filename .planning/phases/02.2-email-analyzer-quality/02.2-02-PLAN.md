---
phase: 02.2-email-analyzer-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(hub)/email-analyzer/analyze/page.tsx
  - src/hooks/useAnalysisJob.ts
  - src/components/analysis/DatePresets.tsx
  - src/components/analysis/AnalysisProgress.tsx
autonomous: true

must_haves:
  truths:
    - "Strona analizy wyświetla 4 przyciski szybkiego wyboru dat: Ostatni miesiąc, Ostatnie 3 miesiące, Ostatnie 30 dni, Ostatnie 90 dni"
    - "Kliknięcie presetu wypełnia pola Od/Do odpowiednimi datami"
    - "Podczas analizy widoczny jest spinner/animacja ładowania"
    - "Wyświetlany jest szacowany czas zakończenia (ETA)"
    - "Po zakończeniu analizy można opcjonalnie usłyszeć sygnał dźwiękowy"
    - "Historia analiz jest widoczna na stronie (lista zakończonych/trwających)"
  artifacts:
    - path: "src/components/analysis/DatePresets.tsx"
      provides: "Komponent z przyciskami szybkiego wyboru zakresu dat"
      exports: ["DatePresets"]
    - path: "src/components/analysis/AnalysisProgress.tsx"
      provides: "Komponent postępu analizy ze spinnerem, ETA i dźwiękiem"
      exports: ["AnalysisProgress"]
---

<objective>
Analysis UX Improvements: szybkie filtry dat (4 presety), widoczny spinner/animacja podczas analizy, szacowany czas zakończenia (ETA), opcjonalny sygnał dźwiękowy po zakończeniu, historia zadań analizy.

Purpose: Użytkownik wie ile potrwa analiza, widzi że proces działa, może odejść od komputera i być powiadomiony.
Output: DatePresets komponent, AnalysisProgress z ETA i dźwiękiem, historia analiz.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-email-analyzer-quality/02.2-CONTEXT.md
@src/app/(hub)/email-analyzer/analyze/page.tsx
@src/hooks/useAnalysisJob.ts
@src/app/api/analysis/process/route.ts
@src/app/api/analysis/status/[jobId]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DatePresets — przyciski szybkiego wyboru zakresu dat</name>
  <files>src/components/analysis/DatePresets.tsx</files>
  <action>
Utwórz komponent `DatePresets`:

```tsx
'use client';

interface DatePresetsProps {
  onSelect: (from: string, to: string) => void;
  disabled?: boolean;
}

export default function DatePresets({ onSelect, disabled }: DatePresetsProps) {
  const presets = [
    {
      label: 'Ostatni miesiąc',
      getDates: () => {
        // Ostatni pełny miesiąc kalendarzowy
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);
        return { from: formatDate(firstDay), to: formatDate(lastDay) };
      },
    },
    {
      label: 'Ostatnie 3 miesiące',
      getDates: () => {
        // Ostatnie 3 pełne miesiące kalendarzowe
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth() - 3, 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);
        return { from: formatDate(firstDay), to: formatDate(lastDay) };
      },
    },
    {
      label: 'Ostatnie 30 dni',
      getDates: () => {
        const now = new Date();
        const from = new Date(now);
        from.setDate(from.getDate() - 30);
        return { from: formatDate(from), to: formatDate(now) };
      },
    },
    {
      label: 'Ostatnie 90 dni',
      getDates: () => {
        const now = new Date();
        const from = new Date(now);
        from.setDate(from.getDate() - 90);
        return { from: formatDate(from), to: formatDate(now) };
      },
    },
  ];

  return (
    <div className="flex flex-wrap gap-2">
      {presets.map((preset) => (
        <button
          key={preset.label}
          onClick={() => {
            const { from, to } = preset.getDates();
            onSelect(from, to);
          }}
          disabled={disabled}
          className="rounded-md border px-3 py-1.5 text-xs transition-colors hover:opacity-80 disabled:opacity-50"
          style={{
            borderColor: 'var(--border-primary)',
            color: 'var(--text-secondary)',
            backgroundColor: 'var(--bg-primary)',
          }}
        >
          {preset.label}
        </button>
      ))}
    </div>
  );
}

function formatDate(d: Date): string {
  return d.toISOString().split('T')[0]; // YYYY-MM-DD
}
```

Kluczowe:
- "Ostatni miesiąc" = pełny poprzedni miesiąc kalendarzowy (np. 1-31 stycznia)
- "Ostatnie 3 miesiące" = 3 pełne poprzednie miesiące kalendarzowe
- "Ostatnie 30/90 dni" = od dzisiaj minus 30/90 dni do dzisiaj
  </action>
  <verify>Komponent renderuje 4 przyciski, kliknięcie zwraca poprawne daty w formacie YYYY-MM-DD.</verify>
  <done>DatePresets gotowy z 4 presetami dat.</done>
</task>

<task type="auto">
  <name>Task 2: AnalysisProgress — spinner, ETA, dźwięk</name>
  <files>src/components/analysis/AnalysisProgress.tsx</files>
  <action>
Utwórz komponent `AnalysisProgress` wydzielony z analyze/page.tsx:

**2a. Spinner:**
Dodaj animowany spinner (pulsująca ikona lub CSS spinner) obok tekstu "Przetwarzanie wątków...".

**2b. ETA:**
Oblicz szacowany czas na podstawie dotychczasowego tempa:
```typescript
// W hooku lub w komponencie
const getETA = (processed: number, total: number, startedAt: Date) => {
  if (processed === 0) return 'Obliczanie...';
  const elapsedMs = Date.now() - startedAt.getTime();
  const avgPerThread = elapsedMs / processed;
  const remainingMs = avgPerThread * (total - processed);
  const remainingMin = Math.ceil(remainingMs / 60000);
  if (remainingMin <= 1) return 'Mniej niż minuta';
  return `~${remainingMin} min`;
};
```

Wyświetlaj:
- "Przetwarzanie wątków... X/Y"
- "Szacowany czas: ~Z min"
- "Możesz opuścić stronę — analiza kontynuuje się w tle" (po przetworzeniu >3 wątków)

**2c. Sygnał dźwiękowy:**
Dodaj checkbox "Powiadom dźwiękiem po zakończeniu" (domyślnie odznaczony).
Gdy analiza się zakończy i checkbox zaznaczony:
```typescript
const playSound = () => {
  const audio = new Audio('data:audio/wav;base64,...'); // prosty beep
  // Alternatywnie: Web Audio API do wygenerowania krótkiego dźwięku
  audio.play().catch(() => {}); // ignoruj błędy autoplay
};
```

**2d. Komunikat po zakończeniu:**
"Analiza zakończona! Przeanalizowano X wątków w Y minut." z przyciskami:
- "Zobacz raporty" (router.push)
- "Nowa analiza" (reset)
  </action>
  <verify>Komponent wyświetla spinner, ETA, checkbox dźwiękowy. Po zakończeniu: dźwięk (jeśli zaznaczony) + podsumowanie.</verify>
  <done>AnalysisProgress gotowy ze spinnerem, ETA, dźwiękiem.</done>
</task>

<task type="auto">
  <name>Task 3: useAnalysisJob — rozszerzenie o ETA i timestamp startu</name>
  <files>src/hooks/useAnalysisJob.ts</files>
  <action>
Rozszerz hook useAnalysisJob:

**3a. Dodaj timestamp startu:**
```typescript
const [startedAt, setStartedAt] = useState<Date | null>(null);
```
Ustaw przy pierwszym statusie 'processing'.

**3b. Zwracaj startedAt w obiekcie:**
```typescript
return {
  ...existing,
  startedAt,
};
```

**3c. Dodaj do progress info o tempie:**
Zwracaj `avgTimePerThread` obliczany z `(Date.now() - startedAt) / processedThreads`.
  </action>
  <verify>`npx tsc --noEmit` — zero błędów. Hook zwraca startedAt i avgTimePerThread.</verify>
  <done>useAnalysisJob rozszerzony o dane do ETA.</done>
</task>

<task type="auto">
  <name>Task 4: analyze/page.tsx — integracja DatePresets, AnalysisProgress, historia analiz</name>
  <files>src/app/(hub)/email-analyzer/analyze/page.tsx</files>
  <action>
**4a. Dodaj DatePresets pod polami dat:**
```tsx
<DatePresets
  onSelect={(from, to) => { setDateFrom(from); setDateTo(to); }}
  disabled={isRunning}
/>
```

**4b. Zamień inline progress na AnalysisProgress komponent.**

**4c. Dodaj sekcję "Historia analiz" pod formularzem:**
Pobierz listę analysis_jobs dla wybranej skrzynki:
```typescript
useEffect(() => {
  if (!selectedMailboxId) return;
  fetch(`/api/analysis?mailboxId=${selectedMailboxId}`)
    .then(res => res.json())
    .then(data => setAnalysisHistory(data.jobs || []));
}, [selectedMailboxId]);
```

Wyświetl jako listę:
- Data uruchomienia
- Status (zakończona/w toku/błąd)
- Liczba wątków
- Zakres dat

**4d. API route GET /api/analysis (jeśli nie istnieje):**
Dodaj GET handler do `src/app/api/analysis/route.ts`:
```typescript
export async function GET(request: NextRequest) {
  if (!(await verifyAdmin())) return NextResponse.json({ error: 'Brak uprawnień' }, { status: 403 });
  const mailboxId = request.nextUrl.searchParams.get('mailboxId');
  let query = getAdminClient().from('analysis_jobs').select('*').order('created_at', { ascending: false }).limit(10);
  if (mailboxId) query = query.eq('mailbox_id', mailboxId);
  const { data } = await query;
  return NextResponse.json({ jobs: data || [] });
}
```
  </action>
  <verify>
Strona analizy wyświetla:
- 4 przyciski presetów dat
- Spinner i ETA podczas analizy
- Checkbox dźwięku
- Historię analiz pod formularzem
  </verify>
  <done>Strona analizy zintegrowana z DatePresets, AnalysisProgress i historią.</done>
</task>

</tasks>

<verification>
- [ ] 4 przyciski presetów dat: Ostatni miesiąc, Ostatnie 3 miesiące, Ostatnie 30 dni, Ostatnie 90 dni
- [ ] Kliknięcie presetu wypełnia pola Od/Do poprawnymi datami
- [ ] Spinner/animacja widoczna podczas przetwarzania
- [ ] ETA wyświetlane: "Szacowany czas: ~X min"
- [ ] Komunikat "możesz opuścić stronę" po kilku przetworzonych wątkach
- [ ] Checkbox "Powiadom dźwiękiem" działa
- [ ] Historia analiz wyświetla się pod formularzem
- [ ] GET /api/analysis zwraca listę zadań
- [ ] `npx tsc --noEmit` przechodzi bez błędów
</verification>

<success_criteria>
1. Użytkownik może wybrać zakres dat jednym kliknięciem (4 presety)
2. Podczas analizy widoczny spinner i szacowany czas zakończenia
3. Po zakończeniu opcjonalny sygnał dźwiękowy
4. Historia analiz dostępna bez utraty danych po opuszczeniu strony
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-email-analyzer-quality/02.2-02-SUMMARY.md`
</output>
