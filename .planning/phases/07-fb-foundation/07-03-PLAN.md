---
phase: 07-fb-foundation
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/lib/api/admin.ts
  - src/app/api/mailboxes/route.ts
  - src/app/api/mailboxes/[id]/route.ts
  - src/app/api/mailboxes/[id]/test-connection/route.ts
  - src/app/api/sync/route.ts
  - src/app/api/sync/process/route.ts
  - src/app/api/sync/status/[jobId]/route.ts
  - src/app/api/threads/route.ts
  - src/app/api/threads/[id]/route.ts
  - src/app/api/threads/build/route.ts
  - src/app/api/analysis/route.ts
  - src/app/api/analysis/process/route.ts
  - src/app/api/analysis/status/[jobId]/route.ts
  - src/app/api/reports/route.ts
  - src/app/api/reports/[id]/route.ts
  - src/app/api/prompts/route.ts
  - src/app/api/ai-config/route.ts
  - src/app/api/dashboard/route.ts
  - src/app/api/admin/users/route.ts
  - src/app/api/admin/create-user/route.ts
  - src/app/api/dev/clear/route.ts
  - src/app/api/dev/seed/route.ts
autonomous: true

must_haves:
  truths:
    - "verifyAdmin() i getAdminClient() sa dostepne z importu @/lib/api/admin"
    - "Wszystkie 21 istniejacych API routes uzywaja shared module zamiast lokalnych kopii"
    - "Zadna z istniejacych API routes nie przestala dzialac po refaktoringu"
    - "Nowe FB API routes moga importowac verifyAdmin/getAdminClient z jednego miejsca"
  artifacts:
    - path: "src/lib/api/admin.ts"
      provides: "Shared verifyAdmin() i getAdminClient() utilities"
      exports: ["verifyAdmin", "getAdminClient"]
      min_lines: 15
  key_links:
    - from: "src/lib/api/admin.ts"
      to: "src/app/api/*/route.ts"
      via: "import { verifyAdmin, getAdminClient } from '@/lib/api/admin'"
      pattern: "from '@/lib/api/admin'"
    - from: "src/lib/api/admin.ts"
      to: "@supabase/supabase-js"
      via: "createClient for service role"
      pattern: "createClient.*SUPABASE_SERVICE_ROLE_KEY"
    - from: "src/lib/api/admin.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient for auth user check"
      pattern: "createClient.*from '@/lib/supabase/server'"
---

<objective>
Ekstrakcja verifyAdmin() i getAdminClient() z 21 API routes do shared module src/lib/api/admin.ts i aktualizacja wszystkich istniejacych routes.

Purpose: Eliminacja duplikacji kodu (21 kopii tej samej logiki). Nowe FB API routes (fazy 8-12) beda importowac z jednego miejsca zamiast kopiowac. Latwiejsze utrzymanie — zmiana w jednym pliku zamiast 21.
Output: Nowy modul src/lib/api/admin.ts + zaktualizowane 21 API route plikow
</objective>

<execution_context>
@C:\Users\dariu\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\dariu\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Obecny wzorzec w kazdym API route (21 plikow):
```typescript
import { createClient } from '@supabase/supabase-js';
import { createClient as createServerClient } from '@/lib/supabase/server';

function getAdminClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );
}

async function verifyAdmin() {
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user?.email) return false;
  const { data } = await getAdminClient()
    .from('app_allowed_users')
    .select('role')
    .eq('email', user.email)
    .single();
  return data?.role === 'admin';
}
```

Lista 21 plikow do aktualizacji (potwierdzona grepem):
1. src/app/api/admin/create-user/route.ts
2. src/app/api/admin/users/route.ts
3. src/app/api/analysis/process/route.ts
4. src/app/api/ai-config/route.ts
5. src/app/api/dashboard/route.ts
6. src/app/api/reports/route.ts
7. src/app/api/reports/[id]/route.ts
8. src/app/api/analysis/status/[jobId]/route.ts
9. src/app/api/analysis/route.ts
10. src/app/api/prompts/route.ts
11. src/app/api/threads/build/route.ts
12. src/app/api/threads/[id]/route.ts
13. src/app/api/threads/route.ts
14. src/app/api/dev/clear/route.ts
15. src/app/api/dev/seed/route.ts
16. src/app/api/sync/process/route.ts
17. src/app/api/sync/status/[jobId]/route.ts
18. src/app/api/sync/route.ts
19. src/app/api/mailboxes/[id]/test-connection/route.ts
20. src/app/api/mailboxes/[id]/route.ts
21. src/app/api/mailboxes/route.ts

WAZNE: getAdminClient() musi uzywac lazy init (NIE top-level createClient) — wymog Vercel.
WAZNE: verifyAdmin() musi uzywac `createClient as createServerClient` z '@/lib/supabase/server' (SSR client z cookie sync).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Utworzenie shared module src/lib/api/admin.ts</name>
  <files>src/lib/api/admin.ts</files>
  <action>
Utworz plik src/lib/api/admin.ts:

```typescript
import { createClient } from '@supabase/supabase-js';
import { createClient as createServerClient } from '@/lib/supabase/server';

/**
 * Tworzy klienta Supabase z service_role_key (admin access, pomija RLS).
 * WAZNE: Lazy init — NIE tworzyc na top-level (wymog Vercel cold start).
 */
export function getAdminClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );
}

/**
 * Weryfikuje czy aktualnie zalogowany uzytkownik ma role admin.
 * Sprawdza tabele app_allowed_users.
 * @returns true jesli user jest adminem, false w przeciwnym razie
 */
export async function verifyAdmin(): Promise<boolean> {
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user?.email) return false;

  const { data } = await getAdminClient()
    .from('app_allowed_users')
    .select('role')
    .eq('email', user.email)
    .single();

  return data?.role === 'admin';
}
```

To jest dokladna kopia logiki z istniejacych routes, ale jako eksportowany modul.
  </action>
  <verify>
1. Plik istnieje i eksportuje getAdminClient i verifyAdmin
2. Import dziala: `import { verifyAdmin, getAdminClient } from '@/lib/api/admin'`
3. Build przechodzi bez bledow TS
  </verify>
  <done>Shared module admin.ts istnieje z getAdminClient() i verifyAdmin() gotowymi do importu.</done>
</task>

<task type="auto">
  <name>Task 2: Aktualizacja 21 API routes — zamiana lokalnych kopii na import z shared module</name>
  <files>
    src/app/api/mailboxes/route.ts
    src/app/api/mailboxes/[id]/route.ts
    src/app/api/mailboxes/[id]/test-connection/route.ts
    src/app/api/sync/route.ts
    src/app/api/sync/process/route.ts
    src/app/api/sync/status/[jobId]/route.ts
    src/app/api/threads/route.ts
    src/app/api/threads/[id]/route.ts
    src/app/api/threads/build/route.ts
    src/app/api/analysis/route.ts
    src/app/api/analysis/process/route.ts
    src/app/api/analysis/status/[jobId]/route.ts
    src/app/api/reports/route.ts
    src/app/api/reports/[id]/route.ts
    src/app/api/prompts/route.ts
    src/app/api/ai-config/route.ts
    src/app/api/dashboard/route.ts
    src/app/api/admin/users/route.ts
    src/app/api/admin/create-user/route.ts
    src/app/api/dev/clear/route.ts
    src/app/api/dev/seed/route.ts
  </files>
  <action>
Dla KAZDEGO z 21 plikow:

1. **USUN** lokalna funkcje `getAdminClient()` (caly blok ~4-6 linii)
2. **USUN** lokalna funkcje `verifyAdmin()` (caly blok ~8-10 linii)
3. **DODAJ** import na gorze pliku: `import { verifyAdmin, getAdminClient } from '@/lib/api/admin';`
4. **USUN** nieuzywany import `createClient` z `@supabase/supabase-js` TYLKO JESLI plik nie uzywa createClient do niczego innego (np. niektorePliki moga miec inne uzycia createClient)
5. **USUN** nieuzywany import `createClient as createServerClient` z `@/lib/supabase/server` TYLKO JESLI plik nie uzywa createServerClient do niczego innego (np. src/app/api/sync/process/route.ts moze uzywac go bezposrednio)

WAZNE: Nie zmieniaj ZADNEJ logiki biznesowej w plikach. Tylko zamien lokalne definicje na import.

WAZNE: Niektore pliki moga miec lekko zmodyfikowana wersje getAdminClient/verifyAdmin. Sprawdz ze logika jest identyczna przed zamiana. Jesli sa roznice (np. dodatkowe pola w select), zachowaj lokalna wersje i NIE zamieniaj — tylko dodaj import shared module dla nowych routes.

Podejscie: Otwieraj pliki jeden po drugim, sprawdz czy getAdminClient/verifyAdmin sa identyczne ze wzorcem, i zamien. Jesli plik nie ma obu funkcji (np. ma tylko getAdminClient), zamien tylko ta ktora ma.

Po kazdej edycji sprawdz ze plik nie ma bledow skladniowych.
  </action>
  <verify>
1. Grep potwierdza ze `function getAdminClient()` NIE wystepuje juz w zadnym API route (tylko w src/lib/api/admin.ts)
2. Grep potwierdza ze `function verifyAdmin()` NIE wystepuje juz w zadnym API route (tylko w src/lib/api/admin.ts)
3. Grep potwierdza ze `from '@/lib/api/admin'` wystepuje w 21 plikach
4. Build przechodzi bez bledow: `npm run build`
5. KRYTYCZNE: Przetestuj jeden endpoint manualnie (np. GET /api/mailboxes) — powinien zwrocic dane lub 403 (zaleznie od sesji)
  </verify>
  <done>Wszystkie 21 API routes importuja verifyAdmin/getAdminClient z shared module. Zero duplikacji. Logika biznesowa nienaruszona. Build przechodzi.</done>
</task>

</tasks>

<verification>
1. src/lib/api/admin.ts istnieje i eksportuje verifyAdmin + getAdminClient
2. Zero lokalnych kopii verifyAdmin/getAdminClient w API routes (grep potwierdza)
3. 21 plikow importuje z '@/lib/api/admin'
4. `npm run build` przechodzi bez bledow
5. Istniejaca funkcjonalnosc dziala bez zmian (refaktoring jest przezroczysty)
</verification>

<success_criteria>
- verifyAdmin() i getAdminClient() sa w jednym miejscu (src/lib/api/admin.ts)
- Wszystkie 21 istniejacych API routes uzywaja shared module
- Build przechodzi, zero regresji
- Nowe FB routes (fazy 8-12) moga importowac z tego samego modulu
</success_criteria>

<output>
After completion, create `.planning/phases/07-fb-foundation/07-03-SUMMARY.md`
</output>
