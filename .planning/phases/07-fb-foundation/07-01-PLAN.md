---
phase: 07-fb-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260212_07_01_fb_analyzer.sql
  - src/types/fb.ts
autonomous: true

must_haves:
  truths:
    - "6 tabel FB istnieje w Supabase z poprawnymi kolumnami, typami i constraintami"
    - "Kazda tabela FB ma admin-only RLS policy (SELECT/INSERT/UPDATE/DELETE)"
    - "fb_posts ma UNIQUE(group_id, facebook_post_id) constraint dla deduplikacji"
    - "Typy TS domeny FB sa importowalne z @/types/fb"
  artifacts:
    - path: "supabase/migrations/20260212_07_01_fb_analyzer.sql"
      provides: "Kompletna migracja SQL z 6 tabelami, RLS, indeksami"
      contains: "CREATE TABLE fb_groups"
    - path: "src/types/fb.ts"
      provides: "Typy domeny FB: FbGroup, FbPost, FbComment, FbScrapeJob, FbAnalysisJob, FbReport"
      exports: ["FbGroup", "FbPost", "FbComment", "FbScrapeJob", "FbAnalysisJob", "FbReport", "FbSentiment", "FbGroupStatus", "FbScrapeStatus", "FbAnalysisStatus"]
  key_links:
    - from: "src/types/fb.ts"
      to: "supabase/migrations/20260212_07_01_fb_analyzer.sql"
      via: "Typy TS odzwierciedlaja schemat DB 1:1"
      pattern: "interface Fb(Group|Post|Comment|ScrapeJob|AnalysisJob|Report)"
---

<objective>
Utworzenie fundamentu danych dla modulu FB Analyzer: migracja SQL z 6 tabelami + admin-only RLS + indeksami oraz typy TypeScript domeny FB.

Purpose: Bez tabel DB i typow TS zadna kolejna faza FB Analyzer nie moze ruszic. To jest warstwa danych, na ktorej buduja sie API routes, komponenty i logika biznesowa.
Output: Plik migracji SQL (do aplikacji przez SQL Editor w Supabase Dashboard) + plik typow src/types/fb.ts
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Wzorzec RLS z istniejacych tabel (admin-only):
```sql
ALTER TABLE nazwa_tabeli ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Admin full access" ON nazwa_tabeli
  FOR ALL USING (
    auth.uid() IN (SELECT user_id FROM app_allowed_users WHERE role = 'admin')
  );
```

Schemat bazy z planu architektonicznego (.claude/plans/lexical-marinating-blossom.md):
- fb_groups: name, facebook_url, developer, status (active/paused), last_scraped_at, total_posts, apify_actor_id
- fb_posts: group_id FK, facebook_post_id, author_name, content, posted_at, likes/comments/shares counts, post_url, sentiment (enum), relevance_score (float), ai_snippet, ai_categories (text[])
- fb_comments: post_id FK, facebook_comment_id, author_name, content, posted_at, sentiment
- fb_scrape_jobs: group_id FK, status, posts_found/new/updated counts, apify_run_id, error_message, started_at/completed_at
- fb_analysis_jobs: group_id FK, status, total_posts/analyzed_posts counts, progress (float), started_at/completed_at
- fb_reports: title, content_markdown, summary_data (JSONB), group_ids (text[]), date_from/date_to

WAZNE: Supabase CLI jest zepsuty — plik SQL tworzymy jako dokumentacje. User aplikuje przez SQL Editor w Supabase Dashboard.
WAZNE: Status i sentiment jako TEXT (nie enum PostgreSQL) — elastycznosc, wzorzec z email-analyzer (sync_status TEXT).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migracja SQL — 6 tabel FB z RLS, indeksami i constraintami</name>
  <files>supabase/migrations/20260212_07_01_fb_analyzer.sql</files>
  <action>
Utworz plik migracji SQL z nastepujacymi tabelami:

**fb_groups:**
- id UUID DEFAULT gen_random_uuid() PRIMARY KEY
- name TEXT NOT NULL
- facebook_url TEXT NOT NULL
- developer TEXT — deweloper/klient (do grupowania w raportach)
- status TEXT NOT NULL DEFAULT 'active' — CHECK(status IN ('active', 'paused'))
- last_scraped_at TIMESTAMPTZ
- total_posts INTEGER NOT NULL DEFAULT 0
- apify_actor_id TEXT DEFAULT 'curious_coder/facebook-post-scraper'
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()
- updated_at TIMESTAMPTZ NOT NULL DEFAULT now()

**fb_posts:**
- id UUID DEFAULT gen_random_uuid() PRIMARY KEY
- group_id UUID NOT NULL REFERENCES fb_groups(id) ON DELETE CASCADE
- facebook_post_id TEXT NOT NULL — ID posta z Facebooka
- author_name TEXT
- content TEXT
- posted_at TIMESTAMPTZ
- likes_count INTEGER NOT NULL DEFAULT 0
- comments_count INTEGER NOT NULL DEFAULT 0
- shares_count INTEGER NOT NULL DEFAULT 0
- post_url TEXT — link do oryginalnego posta na FB (krytyczny!)
- media_url TEXT — URL do zalacznika/zdjecia
- sentiment TEXT — CHECK(sentiment IN ('positive', 'negative', 'neutral'))
- relevance_score REAL — 0.0 do 10.0
- ai_snippet TEXT — 1-2 zdania streszczenia AI
- ai_categories TEXT[] — kategorie tematyczne
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()
- updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
- UNIQUE(group_id, facebook_post_id) — deduplikacja!

**fb_comments:**
- id UUID DEFAULT gen_random_uuid() PRIMARY KEY
- post_id UUID NOT NULL REFERENCES fb_posts(id) ON DELETE CASCADE
- facebook_comment_id TEXT NOT NULL
- author_name TEXT
- content TEXT
- posted_at TIMESTAMPTZ
- sentiment TEXT — CHECK(sentiment IN ('positive', 'negative', 'neutral'))
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()

**fb_scrape_jobs:**
- id UUID DEFAULT gen_random_uuid() PRIMARY KEY
- group_id UUID NOT NULL REFERENCES fb_groups(id) ON DELETE CASCADE
- status TEXT NOT NULL DEFAULT 'pending' — CHECK(status IN ('pending', 'running', 'downloading', 'completed', 'failed'))
- posts_found INTEGER NOT NULL DEFAULT 0
- posts_new INTEGER NOT NULL DEFAULT 0
- posts_updated INTEGER NOT NULL DEFAULT 0
- apify_run_id TEXT
- error_message TEXT
- started_at TIMESTAMPTZ
- completed_at TIMESTAMPTZ
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()

**fb_analysis_jobs:**
- id UUID DEFAULT gen_random_uuid() PRIMARY KEY
- group_id UUID NOT NULL REFERENCES fb_groups(id) ON DELETE CASCADE
- status TEXT NOT NULL DEFAULT 'pending' — CHECK(status IN ('pending', 'running', 'completed', 'failed'))
- total_posts INTEGER NOT NULL DEFAULT 0
- analyzed_posts INTEGER NOT NULL DEFAULT 0
- progress REAL NOT NULL DEFAULT 0.0
- error_message TEXT
- started_at TIMESTAMPTZ
- completed_at TIMESTAMPTZ
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()

**fb_reports:**
- id UUID DEFAULT gen_random_uuid() PRIMARY KEY
- title TEXT NOT NULL
- content_markdown TEXT
- summary_data JSONB
- group_ids TEXT[] — grupy objete raportem
- date_from DATE
- date_to DATE
- status TEXT NOT NULL DEFAULT 'draft' — CHECK(status IN ('draft', 'generating', 'completed', 'failed'))
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()
- updated_at TIMESTAMPTZ NOT NULL DEFAULT now()

**RLS (dla kazdej tabeli):**
```sql
ALTER TABLE {tabela} ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Admin full access on {tabela}" ON {tabela}
  FOR ALL USING (
    auth.uid() IN (SELECT user_id FROM app_allowed_users WHERE role = 'admin')
  );
```

**Indeksy:**
- fb_posts: INDEX na group_id, INDEX na posted_at, INDEX na sentiment, INDEX na relevance_score
- fb_comments: INDEX na post_id
- fb_scrape_jobs: INDEX na group_id, INDEX na status
- fb_analysis_jobs: INDEX na group_id, INDEX na status
- fb_reports: INDEX na created_at
- fb_groups: INDEX na developer, INDEX na status

**Trigger updated_at** (dla tabel z updated_at):
Uzyj istniejacego trigger patternu lub utworz funkcje:
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';
```
I podlacz do fb_groups, fb_posts, fb_reports.
  </action>
  <verify>
Sprawdz ze plik istnieje i zawiera:
- 6 instrukcji CREATE TABLE
- 6 bloków RLS (ENABLE ROW LEVEL SECURITY + CREATE POLICY)
- UNIQUE constraint na fb_posts(group_id, facebook_post_id)
- CHECK constraints na polach status/sentiment
- Minimum 10 CREATE INDEX
- Trigger updated_at
  </verify>
  <done>Plik migracji SQL jest kompletny, poprawny skladniowo i gotowy do wklejenia w Supabase SQL Editor. Zawiera 6 tabel, RLS, indeksy, constrainty i triggery.</done>
</task>

<task type="auto">
  <name>Task 2: Typy TypeScript domeny FB</name>
  <files>src/types/fb.ts</files>
  <action>
Utworz plik src/types/fb.ts z nastepujacymi typami odzwierciedlajacymi schemat DB 1:1:

```typescript
// Status types
export type FbGroupStatus = 'active' | 'paused';
export type FbSentiment = 'positive' | 'negative' | 'neutral';
export type FbScrapeStatus = 'pending' | 'running' | 'downloading' | 'completed' | 'failed';
export type FbAnalysisStatus = 'pending' | 'running' | 'completed' | 'failed';
export type FbReportStatus = 'draft' | 'generating' | 'completed' | 'failed';

// Domain types
export interface FbGroup {
  id: string;
  name: string;
  facebook_url: string;
  developer: string | null;
  status: FbGroupStatus;
  last_scraped_at: string | null;
  total_posts: number;
  apify_actor_id: string;
  created_at: string;
  updated_at: string;
}

export interface FbPost {
  id: string;
  group_id: string;
  facebook_post_id: string;
  author_name: string | null;
  content: string | null;
  posted_at: string | null;
  likes_count: number;
  comments_count: number;
  shares_count: number;
  post_url: string | null;
  media_url: string | null;
  sentiment: FbSentiment | null;
  relevance_score: number | null;
  ai_snippet: string | null;
  ai_categories: string[] | null;
  created_at: string;
  updated_at: string;
}

export interface FbComment {
  id: string;
  post_id: string;
  facebook_comment_id: string;
  author_name: string | null;
  content: string | null;
  posted_at: string | null;
  sentiment: FbSentiment | null;
  created_at: string;
}

export interface FbScrapeJob {
  id: string;
  group_id: string;
  status: FbScrapeStatus;
  posts_found: number;
  posts_new: number;
  posts_updated: number;
  apify_run_id: string | null;
  error_message: string | null;
  started_at: string | null;
  completed_at: string | null;
  created_at: string;
}

export interface FbAnalysisJob {
  id: string;
  group_id: string;
  status: FbAnalysisStatus;
  total_posts: number;
  analyzed_posts: number;
  progress: number;
  error_message: string | null;
  started_at: string | null;
  completed_at: string | null;
  created_at: string;
}

export interface FbReport {
  id: string;
  title: string;
  content_markdown: string | null;
  summary_data: Record<string, unknown> | null;
  group_ids: string[] | null;
  date_from: string | null;
  date_to: string | null;
  status: FbReportStatus;
  created_at: string;
  updated_at: string;
}
```

Kazdy interfejs musi miec pola nullable tam gdzie kolumna DB nie ma NOT NULL.
Daty jako string (ISO format z Supabase).
  </action>
  <verify>
Sprawdz ze:
- Plik kompiluje sie bez bledow: `npx tsc --noEmit src/types/fb.ts` (lub sprawdz brak bledow TS w edytorze)
- 6 interfejsow: FbGroup, FbPost, FbComment, FbScrapeJob, FbAnalysisJob, FbReport
- 5 union types: FbGroupStatus, FbSentiment, FbScrapeStatus, FbAnalysisStatus, FbReportStatus
- Wszystkie exportowane
  </verify>
  <done>Typy FB domeny sa zdefiniowane, exportowane i importowalne z @/types/fb. Odzwierciedlaja schemat DB 1:1.</done>
</task>

</tasks>

<verification>
1. Plik SQL zawiera 6 tabel z poprawnymi typami kolumn i constraintami
2. Kazda tabela ma RLS (ENABLE + POLICY)
3. fb_posts ma UNIQUE(group_id, facebook_post_id)
4. Plik src/types/fb.ts eksportuje 6 interfejsow + 5 union types
5. Import `import type { FbGroup } from '@/types/fb'` dziala bez bledow TS
</verification>

<success_criteria>
- Migracja SQL jest gotowa do aplikacji w Supabase Dashboard (user wklei w SQL Editor)
- Typy TS sa kompletne i importowalne
- Schemat DB i typy TS sa zsynchronizowane (te same pola, te same typy)
</success_criteria>

<output>
After completion, create `.planning/phases/07-fb-foundation/07-01-SUMMARY.md`
</output>
