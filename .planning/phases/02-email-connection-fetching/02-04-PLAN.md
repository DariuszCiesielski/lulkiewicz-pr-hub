---
phase: 02-email-connection-fetching
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/hooks/useSyncJob.ts
  - src/components/email/SyncProgress.tsx
  - src/components/email/MailboxList.tsx
  - src/app/(hub)/email-analyzer/mailboxes/page.tsx
autonomous: false

must_haves:
  truths:
    - "Admin moze kliknac 'Synchronizuj' na skrzynce i widziec progress bar z liczba pobranych maili"
    - "Progress bar aktualizuje sie w czasie rzeczywistym (polling co batch)"
    - "Admin moze kliknac 'Odswiezyc' na zsynchronizowanej skrzynce i pobrac tylko nowe maile (delta sync)"
    - "Po zakonczeniu sync lista skrzynek odswiezy sie automatycznie z nowymi statystykami"
    - "Blad sync (np. timeout, 429, MFA) jest czytelnie wyswietlony po polsku"
  artifacts:
    - path: "src/hooks/useSyncJob.ts"
      provides: "React hook do zarzadzania cyklem sync (start, process batches, poll status)"
      exports: ["useSyncJob"]
      min_lines: 50
    - path: "src/components/email/SyncProgress.tsx"
      provides: "Progress bar z liczba pobranych/calkowitych maili"
      min_lines: 30
  key_links:
    - from: "src/hooks/useSyncJob.ts"
      to: "/api/sync"
      via: "fetch POST do start sync"
      pattern: "fetch.*api/sync"
    - from: "src/hooks/useSyncJob.ts"
      to: "/api/sync/process"
      via: "fetch POST do process batch, loop until completed"
      pattern: "fetch.*api/sync/process"
    - from: "src/components/email/SyncProgress.tsx"
      to: "src/hooks/useSyncJob.ts"
      via: "konsumuje status/progress z hooka"
      pattern: "useSyncJob"
    - from: "src/app/(hub)/email-analyzer/mailboxes/page.tsx"
      to: "src/hooks/useSyncJob.ts"
      via: "integracja hooka z UI skrzynek"
      pattern: "useSyncJob"
---

<objective>
Integracja sync z UI: React hook do zarzadzania cyklem sync (polling-driven), progress bar, delta sync button, obsluga bledow. Polaczenie silnika sync (plan 02-03) z UI skrzynek (plan 02-02).

Purpose: Uzytkownik musi widziec postep pobierania maili i moc uruchomic sync/delta sync z poziomu UI.
Output: useSyncJob hook, SyncProgress component, zaktualizowane MailboxList i mailboxes page.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-connection-fetching/02-RESEARCH.md
@.planning/phases/02-email-connection-fetching/02-02-SUMMARY.md
@.planning/phases/02-email-connection-fetching/02-03-SUMMARY.md
@src/hooks/useSyncJob.ts
@src/components/email/MailboxList.tsx
@src/components/email/SyncProgress.tsx
@src/app/(hub)/email-analyzer/mailboxes/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: useSyncJob hook + SyncProgress component</name>
  <files>
    src/hooks/useSyncJob.ts
    src/components/email/SyncProgress.tsx
  </files>
  <action>
1. Utworz `src/hooks/useSyncJob.ts`:
   - Stan wewnetrzny:
     - jobId: string | null
     - status: 'idle' | 'starting' | 'syncing' | 'completed' | 'error'
     - progress: { fetched: number, estimatedTotal: number, currentBatch: number }
     - error: string | null
     - syncType: 'full' | 'delta'

   - Funkcja `startSync(mailboxId: string, type: 'full' | 'delta' = 'full')`:
     - Ustaw status = 'starting'
     - POST /api/sync z { mailboxId, type }
     - Jesli sukces: zapisz jobId, ustaw status = 'syncing', wywolaj processBatch()
     - Jesli blad: ustaw status = 'error', error = message

   - Funkcja `processBatch(jId: string)` (wewnetrzna):
     - POST /api/sync/process z { jobId: jId }
     - Jesli sukces:
       - Zaktualizuj progress (fetched, estimatedTotal)
       - Jesli data.status === 'has_more': setTimeout(() => processBatch(jId), 500) -- 500ms delay miedzy batchami
       - Jesli data.status === 'completed': ustaw status = 'completed', wywolaj onComplete callback
     - Jesli blad (HTTP error lub data.status === 'failed'):
       - Ustaw status = 'error', error = data.error_message lub HTTP error message
       - NIE kontynuuj przetwarzania

   - Funkcja `reset()`: resetuj stan do idle

   - Zwracaj: { startSync, status, progress, error, jobId, syncType, reset }

   - Uzyj useCallback/useRef dla stabilnych referencji (unikaj infinite loops)

2. Utworz `src/components/email/SyncProgress.tsx`:
   - Props: { status, progress: {fetched, estimatedTotal}, error, syncType }
   - Layout:
     - Pasek postepu (progress bar): szerokosc = (fetched / estimatedTotal * 100)% jesli estimatedTotal > 0, inaczej indeterminate (pulsujacy)
     - Tekst: "Pobrano {fetched} z ~{estimatedTotal} wiadomosci" (jesli estimatedTotal > 0) lub "Pobrano {fetched} wiadomosci..." (jesli nieznane)
     - Dla delta sync: "Pobieranie nowych wiadomosci... ({fetched} nowych)"
     - Status 'completed': "Synchronizacja zakonczona. Pobrano {fetched} wiadomosci." z zielonym checkmark
     - Status 'error': "Blad synchronizacji: {error}" z czerwonym X i przyciskiem "Ponow"
   - Animacja: pasek powinien sie plynnie wypelniac (transition-all duration-300)
   - Kolory: uzyj CSS variables (--accent-primary dla paska, --text-primary dla tekstu)

WAZNE: Hook musi byc odporny na unmount -- jesli komponent sie odmontuje podczas sync, timeout powinien byc wyczyszczony (useEffect cleanup lub useRef dla timeout ID).
WAZNE: Nie polluj statusu osobnym endpointem -- processBatch juz zwraca status. To eliminuje race conditions.
WAZNE: 500ms delay miedzy batchami jest wazny dla rate limiting Graph API.
  </action>
  <verify>
    npm run build -- hook i komponent kompiluja.
    Sprawdz ze useSyncJob eksportuje startSync, status, progress, error, reset.
    Sprawdz ze SyncProgress renderuje progress bar z tekstem.
  </verify>
  <done>
    useSyncJob hook zarzadza cyklem sync: start -> process batches (z 500ms delay) -> completed/error.
    SyncProgress wyswietla progress bar z liczba pobranych maili.
    Hook jest odporny na unmount (cleanup timeouts).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integracja sync z UI skrzynek (full sync, delta sync, refreshing)</name>
  <files>
    src/components/email/MailboxList.tsx
    src/app/(hub)/email-analyzer/mailboxes/page.tsx
  </files>
  <action>
1. Zaktualizuj `src/app/(hub)/email-analyzer/mailboxes/page.tsx`:
   - Dodaj useSyncJob() hook
   - Stan: activeSyncMailboxId: string | null (ktora skrzynka jest aktualnie synchronizowana)
   - Funkcja handleStartSync(mailboxId: string):
     - Ustaw activeSyncMailboxId = mailboxId
     - Wywolaj startSync(mailboxId, 'full')
   - Funkcja handleDeltaSync(mailboxId: string):
     - Ustaw activeSyncMailboxId = mailboxId
     - Wywolaj startSync(mailboxId, 'delta')
   - Gdy sync completed: odswierz liste skrzynek (refetch GET /api/mailboxes), resetuj sync state
   - Przekaz handleStartSync, handleDeltaSync do MailboxList
   - Renderuj SyncProgress gdy activeSyncMailboxId jest ustawiony (inline pod skrzynka lub jako overlay)

2. Zaktualizuj `src/components/email/MailboxList.tsx`:
   - Dodaj props: onStartSync(id), onDeltaSync(id), syncState: { mailboxId: string, status, progress, error } | null
   - Dla kazdej skrzynki:
     - Przycisk "Synchronizuj" (full sync) -- widoczny gdy sync_status !== 'syncing' i nie ma aktywnego sync
     - Przycisk "Odswierz" (delta sync) -- widoczny gdy sync_status === 'synced' (juz bylo co najmniej jedno sync)
     - Jesli ta skrzynka jest aktualnie synchronizowana (syncState.mailboxId === this.id): pokaz SyncProgress zamiast przyciskow
     - Disable przyciskow sync na innych skrzynkach gdy jedna sie synchronizuje (sequential sync)
   - Pokaz toast/notification po zakonczeniu sync ("Synchronizacja zakonczona: {N} wiadomosci")
   - Pokaz blad sync inline pod skrzynka z przyciskiem "Ponow"

3. Obsluga test connection:
   - Przycisk "Testuj polaczenie" na kazdej skrzynce
   - POST /api/mailboxes/[id]/test-connection
   - Loading state na przycisku
   - Wynik: toast z message (sukces/blad)

WAZNE: Tylko JEDNA skrzynka moze byc synchronizowana naraz (sequential) -- disable przyciskow na innych.
WAZNE: Po zakonczeniu sync odswierz dane skrzynki (total_emails, last_sync_at, sync_status).
WAZNE: Delta sync jest dostepny TYLKO po pierwszym pelnym sync (sync_status === 'synced').
WAZNE: Jesli user zamknie strone podczas sync, job zostanie w stanie 'has_more' -- przy nastepnym wejsciu pokaz "Przerwany sync" z opcja kontynuacji lub restartu.
  </action>
  <verify>
    npm run build -- zaktualizowane pliki kompiluja.
    Otworz strone mailboxes -- skrzynki powinny miec przyciski sync/odswierz/testuj.
  </verify>
  <done>
    Admin moze uruchomic full sync i widziec progress bar na zywo.
    Admin moze uruchomic delta sync na zsynchronizowanej skrzynce.
    Progress bar aktualizuje sie po kazdym batchu (100 maili).
    Tylko jedna skrzynka synchronizowana naraz.
    Po zakonczeniu lista sie odswierza z nowymi statystykami.
    Bledy sa wyswietlane po polsku z opcja ponowienia.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Kompletny flow synchronizacji maili: od klikniecia "Synchronizuj" przez progress bar az po zakonczone pobieranie z delta sync. Calosciowo Phase 2: dodawanie skrzynek + test polaczenia + bulk sync + delta sync + parsowanie maili.
  </what-built>
  <how-to-verify>
    1. Otworz http://localhost:3000/email-analyzer/mailboxes jako admin
    2. Dodaj skrzynke Outlook (wymaga ENCRYPTION_KEY, AZURE_TENANT_ID, AZURE_CLIENT_ID w .env.local)
    3. Kliknij "Testuj polaczenie" -- powinien pokazac "Polaczenie udane" z liczba wiadomosci
    4. Kliknij "Synchronizuj" -- progress bar powinien sie pojawic i aktualizowac po kazdym batchu (100 maili)
    5. Poczekaj na zakonczenie sync -- lista powinna sie odswiez z nowymi statystykami (total_emails, last_sync_at)
    6. Sprawdz w Supabase Dashboard ze tabela emails zawiera pobrane maile z poprawnymi polskimi znakami
    7. Kliknij "Odswierz" na zsynchronizowanej skrzynce -- powinien pobrac tylko nowe maile (delta sync)
    8. Sprawdz ze bledy sa czytelne po polsku (np. nieprawidlowe haslo, MFA required)
    9. Sprawdz responsywnosc na mobile
  </how-to-verify>
  <resume-signal>Wpisz "approved" lub opisz problemy do naprawienia</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` przechodzi
2. useSyncJob hook: start -> process batches -> completed (lub error)
3. SyncProgress: progress bar aktualizuje sie w real-time
4. Full sync: pobiera wszystkie maile z paginacja (100 per batch)
5. Delta sync: pobiera tylko nowe maile
6. Bledy wyswietlane po polsku
7. Sequential sync (jedna skrzynka naraz)
8. Maile w Supabase z poprawnymi polskimi znakami
9. Human verification: pelny flow od dodania skrzynki do pobrania maili
</verification>

<success_criteria>
- Admin moze uruchomic sync i widziec progress bar na zywo
- Full sync pobiera tysiace maili bez timeout (chunked po 100)
- Delta sync pobiera tylko nowe maile
- Maile w bazie z poprawnymi polskimi znakami i threading headers
- Bledy auth/sync wyswietlane po polsku
- Lista skrzynek odswierza sie automatycznie po sync
- Checkpoint: human verification passed -- pelny flow dziala end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-connection-fetching/02-04-SUMMARY.md`
</output>
