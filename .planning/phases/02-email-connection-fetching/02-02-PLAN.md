---
phase: 02-email-connection-fetching
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/mailboxes/route.ts
  - src/app/api/mailboxes/[id]/route.ts
  - src/app/api/mailboxes/[id]/test-connection/route.ts
  - src/app/(hub)/email-analyzer/mailboxes/page.tsx
  - src/components/email/MailboxList.tsx
  - src/components/email/MailboxForm.tsx
  - src/components/email/ConnectionStatus.tsx
autonomous: false

must_haves:
  truths:
    - "Admin moze dodac skrzynke Outlook przez formularz (email, credentials, typ polaczenia)"
    - "Admin moze przetestowac polaczenie ze skrzynka i zobaczyc wynik (sukces z liczba maili lub blad z opisem po polsku)"
    - "Admin moze usunac skrzynke z potwierdzeniem"
    - "Admin widzi liste skrzynek ze statusami polaczenia i sync"
    - "Credentials sa szyfrowane AES-256-GCM przed zapisem do bazy"
  artifacts:
    - path: "src/app/api/mailboxes/route.ts"
      provides: "GET lista skrzynek, POST tworzenie skrzynki"
      exports: ["GET", "POST"]
    - path: "src/app/api/mailboxes/[id]/route.ts"
      provides: "GET/DELETE pojedyncza skrzynka"
      exports: ["GET", "DELETE"]
    - path: "src/app/api/mailboxes/[id]/test-connection/route.ts"
      provides: "POST test polaczenia ze skrzynka"
      exports: ["POST"]
    - path: "src/app/(hub)/email-analyzer/mailboxes/page.tsx"
      provides: "Strona zarzadzania skrzynkami (admin only)"
      min_lines: 30
    - path: "src/components/email/MailboxList.tsx"
      provides: "Lista skrzynek ze statusami"
      min_lines: 40
    - path: "src/components/email/MailboxForm.tsx"
      provides: "Formularz dodawania/edycji skrzynki"
      min_lines: 50
  key_links:
    - from: "src/app/api/mailboxes/route.ts"
      to: "src/lib/crypto/encrypt.ts"
      via: "encrypt() credentials przed zapisem"
      pattern: "encrypt\\("
    - from: "src/app/api/mailboxes/[id]/test-connection/route.ts"
      to: "src/lib/email/graph-auth.ts"
      via: "getAccessToken() z odszyfrowanymi credentials"
      pattern: "getAccessToken"
    - from: "src/app/api/mailboxes/[id]/test-connection/route.ts"
      to: "src/lib/email/graph-client.ts"
      via: "createGraphClient() z tokenem"
      pattern: "createGraphClient"
    - from: "src/components/email/MailboxForm.tsx"
      to: "/api/mailboxes"
      via: "fetch POST do API"
      pattern: "fetch.*api/mailboxes"
---

<objective>
API CRUD skrzynek emailowych z szyfrowaniem credentials, test polaczenia z Graph API, oraz UI zarzadzania skrzynkami (formularz, lista, statusy).

Purpose: Admin musi moc dodawac skrzynki Outlook, testowac polaczenie i widziec status -- to fundament przed uruchomieniem sync.
Output: 3 API routes (CRUD + test connection), strona zarzadzania skrzynkami, 3 komponenty UI.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-connection-fetching/02-RESEARCH.md
@.planning/phases/02-email-connection-fetching/02-01-SUMMARY.md
@src/app/api/admin/users/route.ts
@src/types/email.ts
@src/lib/crypto/encrypt.ts
@src/lib/email/graph-auth.ts
@src/lib/email/graph-client.ts
@src/contexts/AuthContext.tsx
@src/components/layout/Sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API routes -- CRUD skrzynek + test polaczenia</name>
  <files>
    src/app/api/mailboxes/route.ts
    src/app/api/mailboxes/[id]/route.ts
    src/app/api/mailboxes/[id]/test-connection/route.ts
  </files>
  <action>
1. Utworz `src/app/api/mailboxes/route.ts`:
   - Wzorzec jak w admin/users/route.ts: adminClient (service role), verifyAdmin()
   - **GET**: lista wszystkich skrzynek z tabeli mailboxes, posortowane po created_at. Zwroc BEZ credentials_encrypted (select konkretne kolumny). Dodaj do kazdej skrzynki pole `email_count` -- query count z tabeli emails WHERE mailbox_id = id.
   - **POST**: tworzenie skrzynki:
     - Body: { email_address, display_name, connection_type, tenant_id, client_id, username, password, client_secret }
     - Walidacja: email_address wymagany, dla ROPC: username + password wymagane, dla client_credentials: client_secret wymagany
     - tenant_id i client_id: jesli nie podane, uzyj AZURE_TENANT_ID i AZURE_CLIENT_ID z env
     - Szyfruj credentials: dla ROPC szyfruj JSON `{username, password}`, dla client_credentials szyfruj JSON `{clientSecret}`
     - Insert do mailboxes z credentials_encrypted, connection_type, tenant_id, client_id
     - Zwroc nowa skrzynke (bez credentials_encrypted)
   - Kazdy endpoint wymaga verifyAdmin() -- zwroc 403 "Brak uprawnien" jesli nie admin

2. Utworz `src/app/api/mailboxes/[id]/route.ts`:
   - **GET**: zwroc pojedyncza skrzynke (bez credentials_encrypted)
   - **DELETE**: usun skrzynke (CASCADE usunie powiazane sync_jobs i emails)
   - Oba wymagaja verifyAdmin()

3. Utworz `src/app/api/mailboxes/[id]/test-connection/route.ts`:
   - **POST**: testuje polaczenie ze skrzynka
   - Pobierz skrzynke z DB, odszyfruj credentials (decrypt)
   - Zbuduj MailboxCredentials z danych skrzynki + odszyfrowanych credentials
   - Wywolaj getAccessToken(credentials) -- wrap w try/catch
   - Jesli sukces: utworz Graph client, wykonaj test query: `GET /users/{email}/mailFolders/inbox` -- pobierz totalItemCount
   - Zwroc `{ success: true, message: "Polaczenie udane. Skrzynka zawiera {N} wiadomosci.", messageCount: N }`
   - Jesli blad auth: uzyj parseGraphAuthError() i zwroc `{ success: false, message: parsedError }` ze status 400
   - Jesli blad Graph API: sparsuj blad (401 -> "Brak uprawnien", 403 -> "Dostep zabroniony", inne -> oryginalny message)
   - `export const maxDuration = 30;` -- test connection moze byc wolny

WAZNE: Uzyj tego samego wzorca verifyAdmin() jak w admin/users/route.ts.
WAZNE: NIE zwracaj credentials_encrypted w zadnym GET response.
WAZNE: Komunikaty bledow po POLSKU.
  </action>
  <verify>
    npm run build -- wszystkie 3 API routes kompiluja jako dynamic (f).
    Sprawdz ze pliki istnieja i eksportuja GET/POST/DELETE.
  </verify>
  <done>
    GET /api/mailboxes zwraca liste skrzynek bez credentials.
    POST /api/mailboxes tworzy skrzynke z zaszyfrowanymi credentials.
    DELETE /api/mailboxes/[id] usuwa skrzynke.
    POST /api/mailboxes/[id]/test-connection testuje polaczenie i zwraca wynik po polsku.
    Wszystkie endpointy wymagaja admina (403 dla nie-adminow).
  </done>
</task>

<task type="auto">
  <name>Task 2: UI zarzadzania skrzynkami -- lista, formularz, status polaczenia</name>
  <files>
    src/app/(hub)/email-analyzer/mailboxes/page.tsx
    src/app/(hub)/email-analyzer/layout.tsx
    src/components/email/MailboxList.tsx
    src/components/email/MailboxForm.tsx
    src/components/email/ConnectionStatus.tsx
  </files>
  <action>
1. Utworz `src/app/(hub)/email-analyzer/layout.tsx`:
   - Prosty layout z children -- nie dodawaj dodatkowego chrome (sidebar juz jest w hub layout)
   - Opcjonalnie: breadcrumb nawigacja (Dashboard > Analizator Email > ...)

2. Utworz `src/app/(hub)/email-analyzer/mailboxes/page.tsx`:
   - Admin-only strona (sprawdz isAdmin z useAuth, redirect jesli nie admin)
   - Tytul: "Zarzadzanie skrzynkami"
   - Stan: mailboxes[] ladowane z GET /api/mailboxes, loading, error
   - Przycisk "Dodaj skrzynke" otwiera modal/formularz (MailboxForm)
   - Renderuje MailboxList z akcjami (test, sync, usun)
   - Po dodaniu/usunieciu odswiez liste

3. Utworz `src/components/email/MailboxList.tsx`:
   - Props: mailboxes[], onTestConnection(id), onStartSync(id), onDelete(id), onRefresh(id)
   - Dla kazdej skrzynki pokazuj:
     - Email address (bold)
     - Display name (jesli jest)
     - ConnectionStatus component (sync_status)
     - Statystyki: total_emails, last_sync_at (sformatowane po polsku np. "2 godz. temu")
     - Akcje: "Testuj polaczenie" button, "Synchronizuj" button, "Usun" button z confirm dialog
   - Empty state: "Brak skrzynek. Dodaj pierwsza skrzynke aby rozpoczac."
   - Styl: dark theme, CSS variables z design systemu, karty z border-radius

4. Utworz `src/components/email/MailboxForm.tsx`:
   - Modal lub sheet (wzorzec "jasna wyspa" jak w admin panel -- bg-white na ciemnym tle)
   - Pola formularza:
     - Email skrzynki (email_address) -- wymagany
     - Nazwa wyswietlana (display_name) -- opcjonalny
     - Typ polaczenia: radio/select (connection_type: "Login i haslo" / "OAuth2 App Registration")
     - Warunkowe pola:
       - Dla ROPC: Login (username), Haslo (password)
       - Dla client_credentials: Client Secret
     - Tenant ID -- opcjonalny, placeholder "Domyslny z konfiguracji"
     - Client ID -- opcjonalny, placeholder "Domyslny z konfiguracji"
   - Submit: POST /api/mailboxes, pokaz loading state
   - Sukces: zamknij modal, wywolaj onSuccess callback
   - Blad: pokaz message

5. Utworz `src/components/email/ConnectionStatus.tsx`:
   - Props: status (SyncStatus), lastSyncAt (string | null)
   - Renderuj kolorowy indicator:
     - 'synced': zielone kolko + "Zsynchronizowano" + data
     - 'syncing': pomaranczowe pulsujace + "Synchronizacja..."
     - 'error': czerwone kolko + "Blad"
     - 'never_synced': szare kolko + "Nigdy nie synchronizowano"

6. Dodaj link do strony mailboxes w Sidebar:
   - Pod "Analizator Email" dodaj sub-link "Skrzynki" (href: /email-analyzer/mailboxes)
   - Tylko dla adminow (sprawdz isAdmin)

WAZNE: Jezyk TYLKO PL -- wszystkie etykiety, placeholdery, komunikaty po polsku.
WAZNE: Uzyj CSS variables z design systemu (--bg-primary, --text-primary, --accent-primary itd.).
WAZNE: "Jasna wyspa" modal pattern -- bg-white text-gray-900 w ciemnym overlay.
WAZNE: Formularz NIE wysyla credentials w URL -- tylko w body POST.
  </action>
  <verify>
    npm run build -- strona mailboxes i komponenty kompiluja.
    Otworz http://localhost:3000/email-analyzer/mailboxes jako admin -- strona renderuje sie z tytul + przycisk "Dodaj skrzynke".
    Kliknij "Dodaj skrzynke" -- formularz otwiera sie z polami.
  </verify>
  <done>
    Strona /email-analyzer/mailboxes renderuje liste skrzynek z akcjami.
    Formularz dodawania skrzynki dziala (ROPC i client_credentials warianty).
    ConnectionStatus pokazuje kolorowe wskazniki statusu sync.
    Sidebar zawiera link do strony mailboxes (admin only).
    Calosc w jezyku polskim, spojny design.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Kompletny flow zarzadzania skrzynkami: API CRUD z szyfrowaniem credentials + test polaczenia z Graph API + UI z formularzem i lista.
  </what-built>
  <how-to-verify>
    1. Otworz http://localhost:3000/email-analyzer/mailboxes (zalogowany jako admin)
    2. Sprawdz ze strona wyswietla "Zarzadzanie skrzynkami" z pustym stanem
    3. Kliknij "Dodaj skrzynke" -- formularz powinien sie otworzyc
    4. Wypelnij formularz (email, login, haslo) i zatwierdz -- skrzynka pojawi sie na liscie
    5. Kliknij "Testuj polaczenie" na skrzynce -- powinien pokazac wynik (sukces lub blad z czytelnym opisem)
    6. Sprawdz ze sidebar ma link "Skrzynki" pod Analizatorem Email
    7. Sprawdz ze nie-admin nie widzi strony (redirect)
  </how-to-verify>
  <resume-signal>Wpisz "approved" lub opisz problemy do naprawienia</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` przechodzi bez bledow
2. API routes /api/mailboxes (GET, POST), /api/mailboxes/[id] (GET, DELETE), /api/mailboxes/[id]/test-connection (POST) dzialaja
3. Credentials sa szyfrowane w bazie (sprawdz w Supabase ze kolumna credentials_encrypted zawiera format iv:tag:cipher)
4. Test connection laczy sie z Graph API i zwraca wynik po polsku
5. UI: lista skrzynek, formularz, statusy -- wszystko po polsku, dark theme
</verification>

<success_criteria>
- Admin moze dodac skrzynke przez formularz (email + credentials)
- Credentials sa zaszyfrowane AES-256-GCM w bazie
- Admin moze przetestowac polaczenie i zobaczyc wynik
- Admin moze usunac skrzynke
- Lista skrzynek pokazuje statusy i statystyki
- Sidebar ma link do strony mailboxes
- Checkpoint: human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-connection-fetching/02-02-SUMMARY.md`
</output>
