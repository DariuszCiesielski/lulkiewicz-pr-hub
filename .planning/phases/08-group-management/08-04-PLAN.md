---
phase: 08-group-management
plan: 04
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/app/(hub)/fb-analyzer/settings/page.tsx
  - src/components/fb/SettingsForm.tsx
autonomous: true

must_haves:
  truths:
    - "Admin moze wpisac Apify API token i zapisac go zaszyfrowanego w bazie"
    - "Admin moze wkleic FB cookies (tekst JSON) i zapisac je zaszyfrowane"
    - "Settings page pokazuje czy token i cookies sa skonfigurowane (flagi boolean, nie wartosci)"
    - "Super admin widzi i moze zmienic Apify Actor ID, zwykly admin nie"
    - "Admin moze zapisac domyslna instrukcje AI per deweloper"
  artifacts:
    - path: "src/app/(hub)/fb-analyzer/settings/page.tsx"
      provides: "Strona ustawien FB Analyzer (zastepuje shell)"
      min_lines: 60
    - path: "src/components/fb/SettingsForm.tsx"
      provides: "Formularz ustawien (Apify token, cookies, actor, instrukcje AI)"
      min_lines: 150
  key_links:
    - from: "src/components/fb/SettingsForm.tsx"
      to: "/api/fb-settings"
      via: "fetch GET (load) + POST (save)"
      pattern: "fetch.*api/fb-settings"
    - from: "src/components/fb/SettingsForm.tsx"
      to: "/api/fb-groups/developers"
      via: "fetch GET (load developers for instructions)"
      pattern: "fetch.*api/fb-groups/developers"
---

<objective>
Strona ustawien FB Analyzer z formularzem do konfiguracji Apify token, FB cookies, Actor ID i domyslnych instrukcji AI per deweloper. Zastepuje shell page.

Purpose: Admin musi skonfigurowac credentiale Apify zanim bedzie mogl scrapowac (Phase 9). Spelnia wymaganie FBGRP-04.
Output: 2 pliki — strona settings + komponent SettingsForm.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-group-management/08-CONTEXT.md
@.planning/phases/08-group-management/08-RESEARCH.md
@.planning/phases/08-group-management/08-02-SUMMARY.md
@src/types/fb.ts
@src/app/(hub)/fb-analyzer/settings/page.tsx
@src/lib/crypto/encrypt.ts
@src/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: SettingsForm + settings page</name>
  <files>
    src/components/fb/SettingsForm.tsx
    src/app/(hub)/fb-analyzer/settings/page.tsx
  </files>
  <action>
**1. SettingsForm.tsx — Formularz ustawien**

`'use client'`

Komponent laduje ustawienia z API i pozwala je zapisywac per-sekcja.

State:
```typescript
// Loaded flags
const [hasApifyToken, setHasApifyToken] = useState(false);
const [hasFbCookies, setHasFbCookies] = useState(false);
const [apifyActorId, setApifyActorId] = useState('curious_coder/facebook-post-scraper');
const [developerInstructions, setDeveloperInstructions] = useState<Record<string, string>>({});
const [developers, setDevelopers] = useState<string[]>([]);

// Form inputs
const [newApifyToken, setNewApifyToken] = useState('');
const [newFbCookies, setNewFbCookies] = useState('');
const [newActorId, setNewActorId] = useState('');

// UI state
const [loading, setLoading] = useState(true);
const [saving, setSaving] = useState<string | null>(null); // ktory sektor sie zapisuje
const [error, setError] = useState<string | null>(null);
const [successMessage, setSuccessMessage] = useState<string | null>(null);
```

Logika ladowania (useEffect on mount):
- `Promise.all([fetch('/api/fb-settings'), fetch('/api/fb-groups/developers')])`
- Z fb-settings response: ustaw hasApifyToken, hasFbCookies, apifyActorId, developerInstructions
- Z developers response: ustaw developers

Logika zapisu:
- Kazda sekcja ma wlasny przycisk "Zapisz" — zapis jednego ustawienia naraz
- `saveSetting(key, value)`: POST /api/fb-settings z `{ key, value }`
- Po zapisie: pokaz success message na 3s (setTimeout), odswierz dane (re-fetch GET)

**Sekcje formularza (4 karty):**

**Karta 1: Apify API Token**
- Ikona Key, tytul "Apify API Token"
- Status badge: "Skonfigurowany" (zielony, CheckCircle2) lub "Nieskonfigurowany" (czerwony, XCircle)
- Input type="password" z placeholder "apify_api_..."
- Przycisk "Zapisz token" (disable gdy pusty)
- Info text: "Token jest szyfrowany AES-256 i przechowywany bezpiecznie"

**Karta 2: Facebook Cookies**
- Ikona Cookie, tytul "Facebook Cookies (globalne)"
- Status badge: "Skonfigurowane" / "Nieskonfigurowane"
- Dwa tryby inputu (tabs/toggle):
  1. **Wklej tekst**: textarea (JSON format), placeholder z przykladem `[{"name":"c_user","value":"..."}]`
  2. **Upload plik**: input type="file" accept=".json,.txt", czyta content via FileReader
- Przycisk "Zapisz cookies"
- Warning box (zolty): "Uzywaj dedykowanego konta Facebook do scrapowania. Nie uzywaj osobistego konta — ryzyko blokady." (ikona Shield)

**Karta 3: Apify Actor (tylko super admin)**
- WIDOCZNA TYLKO gdy `user?.email === 'dariusz.ciesielski.71@gmail.com'` (z AuthContext)
- Ikona Settings2, tytul "Apify Actor (zaawansowane)"
- Input text z wartoscia `apifyActorId`, default: 'curious_coder/facebook-post-scraper'
- Przycisk "Zapisz actor"
- Info text: "Zmiana actora wymaga uprawnien super admina"

**Karta 4: Domyslne instrukcje AI per deweloper**
- Ikona Brain, tytul "Domyslne instrukcje AI"
- Jesli nie ma deweloperow: tekst "Dodaj grupy z deweloperem aby ustawic domyslne instrukcje"
- Dla kazdego dewelopera z listy `developers`:
  - Label: nazwa dewelopera
  - Textarea z wartoscia `developerInstructions[developer] || ''`
  - Placeholder: "Opisz co AI ma szukac w postach grup tego dewelopera..."
  - Przycisk "Zapisz" per deweloper
- Zapis: key = `developer_instruction:{developer}`, value = tekst instrukcji

**Stylowanie:**
- Karty: rounded-lg border, `style={{ borderColor: 'var(--border-primary)', backgroundColor: 'var(--bg-secondary)' }}`
- Inputy: rounded-md border, `style={{ borderColor: 'var(--border-primary)', backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)' }}`
- Labels: text-xs, `style={{ color: 'var(--text-muted)' }}`
- Przyciski save: accent-primary bg, white text
- Success message: zielony text pod przyciskiem, znika po 3s
- Error message: czerwony text pod przyciskiem

**Import AuthContext:**
```typescript
import { useAuth } from '@/contexts/AuthContext';
// ...
const { user } = useAuth();
const isSuperAdmin = user?.email === 'dariusz.ciesielski.71@gmail.com';
```

**2. settings/page.tsx — Zastapienie shell page**

`'use client'`

Prosta strona-wrapper:
- Header: ikona Cog + "Ustawienia FB"
- Render `<SettingsForm />`
- Usun caly mock data z istniejacego shell
- Max-w-3xl (zachowaj z shell)

Usun stanu mockowany z istniejacego shell (apifyToken, cookiesStatus, maxPosts, minInterval, proxyEnabled).

UWAGA: "Parametry scrapowania" (maxPosts, minInterval, proxyEnabled) z shell page — te ustawienia naleza do Phase 9 (Scraping Engine). NIE implementuj ich tutaj. Usun te sekcje z page.tsx. Zostaw tylko: Apify token, FB cookies, Actor ID, instrukcje AI.
  </action>
  <verify>
`npx tsc --noEmit` — zero bledow. Sprawdz ze:
- settings/page.tsx NIE ma mock data (useState z hardcoded wartosciami)
- SettingsForm fetchuje z /api/fb-settings i /api/fb-groups/developers
- SettingsForm POST zapisuje do /api/fb-settings
- Sekcja Actor ID widoczna TYLKO dla super admina
- Token i cookies NIE sa wyswietlane (tylko boolean flagi)
- CSS variables wszedzie (zero hardcoded bg-white)
- Warning o dedykowanym koncie FB jest widoczny
  </verify>
  <done>Settings page dziala z real API: admin moze skonfigurowac Apify token (encrypted), FB cookies (encrypted), instrukcje AI per deweloper. Super admin moze zmienic Actor ID. Token/cookies nigdy nie sa wyswietlane — tylko flagi "Skonfigurowany/Nieskonfigurowany".</done>
</task>

</tasks>

<verification>
- [ ] settings/page.tsx zastepuje shell (zero mock data)
- [ ] SettingsForm laduje dane z /api/fb-settings
- [ ] Apify token zapisywany jako encrypted (POST /api/fb-settings)
- [ ] FB cookies: 2 tryby input (wklej + upload), zapisywane encrypted
- [ ] Actor ID widoczny TYLKO dla super admina
- [ ] Instrukcje AI per deweloper — dynamicznie generowane z listy developers
- [ ] Status badges: Skonfigurowany/Nieskonfigurowany (nie wyswietla wartosci)
- [ ] Warning o dedykowanym koncie FB
- [ ] CSS variables pattern
- [ ] `npx tsc --noEmit` przechodzi
</verification>

<success_criteria>
1. Admin moze skonfigurowac Apify token i FB cookies — dane sa szyfrowane
2. Admin widzi status konfiguracji (Skonfigurowany/Nieskonfigurowany)
3. Super admin moze zmienic Actor ID
4. Admin moze ustawic domyslne instrukcje AI per deweloper
</success_criteria>

<output>
After completion, create `.planning/phases/08-group-management/08-04-SUMMARY.md`
</output>
