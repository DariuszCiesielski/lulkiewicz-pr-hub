---
phase: 08-group-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260212_08_01_fb_groups_settings.sql
  - src/types/fb.ts
autonomous: true

must_haves:
  truths:
    - "Tabela fb_groups ma kolumny ai_instruction, deleted_at, cookies_encrypted"
    - "Tabela fb_settings istnieje z kolumnami key, value_encrypted, value_plain"
    - "Typ FbGroup w TypeScript zawiera nowe pola ai_instruction, deleted_at, cookies_encrypted"
    - "Typ FbSettings istnieje i jest eksportowalny"
  artifacts:
    - path: "supabase/migrations/20260212_08_01_fb_groups_settings.sql"
      provides: "ALTER TABLE fb_groups + CREATE TABLE fb_settings"
      contains: "ALTER TABLE fb_groups"
    - path: "src/types/fb.ts"
      provides: "Zaktualizowane typy FB z nowymi polami"
      exports: ["FbGroup", "FbSettings"]
  key_links:
    - from: "src/types/fb.ts"
      to: "supabase/migrations/20260212_08_01_fb_groups_settings.sql"
      via: "typy odzwierciedlaja schemat DB"
      pattern: "ai_instruction.*deleted_at.*cookies_encrypted"
---

<objective>
Fundament danych Phase 8: migracja SQL (ALTER TABLE fb_groups + nowa tabela fb_settings) i aktualizacja typow TypeScript.

Purpose: Pozostale plany Phase 8 (API routes, UI) zaleza od schematu DB i typow TS. Ten plan tworzy fundament.
Output: Plik migracji SQL + zaktualizowany fb.ts z nowymi polami i interfejsem FbSettings.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-group-management/08-RESEARCH.md
@supabase/migrations/20260212_07_01_fb_analyzer.sql
@src/types/fb.ts
@src/lib/crypto/encrypt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migracja SQL — ALTER TABLE fb_groups + CREATE TABLE fb_settings</name>
  <files>supabase/migrations/20260212_08_01_fb_groups_settings.sql</files>
  <action>
Utworz plik migracji SQL z dwoma czesciami:

**Czesc 1: ALTER TABLE fb_groups**
```sql
ALTER TABLE fb_groups
  ADD COLUMN IF NOT EXISTS ai_instruction TEXT,
  ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS cookies_encrypted TEXT;

CREATE INDEX IF NOT EXISTS idx_fb_groups_deleted_at ON fb_groups(deleted_at);
```
- `ai_instruction` — instrukcja AI (free text) co szukac w postach tej grupy (nullable)
- `deleted_at` — soft delete: NULL = aktywna, timestamp = usunieta (nullable)
- `cookies_encrypted` — override FB cookies per grupa, AES-256-GCM encrypted (nullable, NULL = uzyj globalnych)
- Indeks na deleted_at — przyspieszenie filtrowania `.is('deleted_at', null)`

**Czesc 2: CREATE TABLE fb_settings**
```sql
CREATE TABLE IF NOT EXISTS fb_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key TEXT NOT NULL UNIQUE,
  value_encrypted TEXT,
  value_plain TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```
- Trigger `updated_at` — reuse istniejaca funkcja `update_updated_at_column()` (CREATE OR REPLACE z Phase 7)
- RLS: ENABLE ROW LEVEL SECURITY + admin-only policy (wzorzec z fb_groups)
- Policy name: "Admin full access on fb_settings"

Klucze ktore beda uzywane:
- `apify_token` -> value_encrypted (globalny token API Apify)
- `fb_cookies` -> value_encrypted (globalne cookies FB, JSON string encrypted)
- `apify_actor_id` -> value_plain (domyslnie 'curious_coder/facebook-post-scraper')
- `developer_instruction:{developer_name}` -> value_plain (domyslna instrukcja AI per deweloper)

Dodaj komentarze SQL opisujace uzycie kazdego klucza.

WAZNE: Na poczatku pliku dodaj komentarz:
```sql
-- Phase 8: Group Management — ALTER TABLE fb_groups + CREATE TABLE fb_settings
-- Uwaga: Wklej w Supabase Dashboard > SQL Editor (Supabase CLI zepsuty)
```
  </action>
  <verify>
Walidacja skladni SQL:
- Plik nie ma bledow skladniowych (kazde statement konczy sie `;`)
- ALTER TABLE ma 3 ADD COLUMN IF NOT EXISTS
- CREATE TABLE fb_settings ma 6 kolumn
- Jest 1 trigger, 1 RLS policy, 1 indeks (na deleted_at)
- Uzywa `update_updated_at_column()` (istniejaca funkcja)
  </verify>
  <done>Plik migracji istnieje, zawiera ALTER TABLE fb_groups (3 nowe kolumny + indeks) i CREATE TABLE fb_settings (6 kolumn + trigger + RLS). Gotowy do wklejenia w SQL Editor.</done>
</task>

<task type="auto">
  <name>Task 2: Aktualizacja typow TypeScript — FbGroup + FbSettings</name>
  <files>src/types/fb.ts</files>
  <action>
Zaktualizuj istniejacy plik `src/types/fb.ts`:

**1. Dodaj nowe pola do interfejsu FbGroup:**
```typescript
export interface FbGroup {
  // ... istniejace pola bez zmian ...
  ai_instruction: string | null;      // NOWE: instrukcja AI (co szukac w postach)
  deleted_at: string | null;          // NOWE: soft delete timestamp
  cookies_encrypted: string | null;   // NOWE: override cookies per grupa (encrypted)
}
```

**2. Dodaj nowy interfejs FbSettings:**
```typescript
export interface FbSettings {
  id: string;
  key: string;
  value_encrypted: string | null;
  value_plain: string | null;
  created_at: string;
  updated_at: string;
}
```

**3. Dodaj interfejs FbGroupEnriched (dla API response z agregatami):**
```typescript
/** FbGroup wzbogacony o pola obliczane (z API response, nie z DB) */
export interface FbGroupEnriched extends FbGroup {
  relevant_posts: number;        // liczba istotnych postow (obliczana)
  has_custom_cookies: boolean;   // czy ma override cookies (flag, nie wartosc)
}
```

**4. Dodaj typ FbSettingsKey:**
```typescript
export type FbSettingsKey =
  | 'apify_token'
  | 'fb_cookies'
  | 'apify_actor_id'
  | `developer_instruction:${string}`;
```

Zachowaj istniejace interfejsy i typy BEZ ZMIAN. Dodaj nowe elementy na koncu pliku (po FbReport).

Uruchom `npx tsc --noEmit` aby potwierdzic brak bledow kompilacji.
  </action>
  <verify>
`npx tsc --noEmit` — zero bledow kompilacji. Sprawdz ze FbGroup, FbSettings, FbGroupEnriched, FbSettingsKey sa eksportowane.
  </verify>
  <done>Plik fb.ts zawiera zaktualizowany FbGroup (3 nowe pola), nowy FbSettings, FbGroupEnriched (extended type), FbSettingsKey. Kompilacja TypeScript bez bledow.</done>
</task>

</tasks>

<verification>
- [ ] Plik SQL istnieje w supabase/migrations/
- [ ] ALTER TABLE fb_groups dodaje 3 kolumny (ai_instruction, deleted_at, cookies_encrypted)
- [ ] CREATE TABLE fb_settings z 6 kolumnami + trigger + RLS
- [ ] FbGroup interface ma 3 nowe pola
- [ ] FbSettings interface istnieje
- [ ] FbGroupEnriched interface rozszerza FbGroup
- [ ] `npx tsc --noEmit` przechodzi bez bledow
</verification>

<success_criteria>
1. Migracja SQL gotowa do wklejenia w Supabase SQL Editor
2. Typy TS odzwierciedlaja nowy schemat DB
3. Kompilacja TypeScript bez bledow
</success_criteria>

<output>
After completion, create `.planning/phases/08-group-management/08-01-SUMMARY.md`
</output>
